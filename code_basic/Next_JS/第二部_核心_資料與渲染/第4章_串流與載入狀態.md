# ç¬¬ 4 ç« ï¼šä¸²æµèˆ‡è¼‰å…¥ç‹€æ…‹ (Streaming & Suspense)

åœ¨éå»çš„ SPA é–‹ç™¼ä¸­ï¼Œè™•ç†ã€Œè¼‰å…¥ä¸­ (Loading)ã€ç‹€æ…‹é€šå¸¸å¾ˆç¹ç‘£ã€‚ä½ è¦å®£å‘Š `const [isLoading, setIsLoading] = useState(true)`ï¼Œç„¶å¾Œåœ¨ fetch çš„ finally å€å¡ŠæŠŠå®ƒè¨­ç‚º falseï¼Œé‚„è¦åœ¨ JSX è£¡å¯«ä¸‰å…ƒé‹ç®—å­ `isLoading ? <Spinner /> : <Content />`ã€‚

Next.js App Router çµåˆäº† **React Suspense**ï¼Œè®“é€™ä¸€åˆ‡è®Šå¾—æ¥µåº¦å„ªé›…ä¸”è‡ªå‹•åŒ–ã€‚

## 4.1 loading.tsx çš„é­”æ³•

åªè¦åœ¨ä»»ä½•è·¯å¾‘è³‡æ–™å¤¾ä¸‹æ–°å¢ä¸€å€‹ `loading.tsx`ï¼ŒNext.js å°±æœƒè‡ªå‹•æŠŠå®ƒç•¶ä½œè©²è·¯å¾‘çš„ã€Œè¼‰å…¥ä½”ä½ç¬¦ã€ã€‚

### é‹ä½œåŸç†
ç•¶ä½¿ç”¨è€…å°èˆªåˆ°è©²é é¢ï¼Œä¸” Server Component é‚„åœ¨æŠ“å–è³‡æ–™æ™‚ï¼ŒNext.js æœƒï¼š
1.  **ç«‹å³**é¡¯ç¤º `loading.tsx` çš„å…§å®¹ï¼ˆç¢ºä¿å³æ™‚åé¥‹ï¼‰ã€‚
2.  åœ¨èƒŒæ™¯ç¹¼çºŒä¸‹è¼‰è³‡æ–™èˆ‡æ¸²æŸ“é é¢ã€‚
3.  ä¸€æ—¦æ¸²æŸ“å®Œæˆï¼Œè‡ªå‹•æŠŠ Loading UI æ›¿æ›æˆçœŸæ­£çš„é é¢å…§å®¹ã€‚

### ç¯„ä¾‹
```tsx
// app/dashboard/loading.tsx
export default function Loading() {
  return <div className="spinner">è³‡æ–™è®€å–ä¸­ï¼Œè«‹ç¨å€™...</div>;
}
```

é€™å€‹æª”æ¡ˆæœƒè‡ªå‹•åŒ…è£¹åŒå±¤ç´šçš„ `page.tsx`ã€‚ä½ å®Œå…¨ä¸éœ€è¦åœ¨ `page.tsx` è£¡é¢å¯«ä»»ä½•ä¸€è¡Œé—œæ–¼ loading çš„é‚è¼¯ã€‚

---

## 4.2 React Suspense æ·±åº¦è§£æ

é™¤äº†å…¨é é¢çš„ `loading.tsx`ï¼Œæˆ‘å€‘å¸¸å¸¸éœ€è¦æ›´ç´°ç·»çš„æ§åˆ¶ã€‚ä¾‹å¦‚ï¼šå„€è¡¨æ¿æœ‰å¤šå€‹å€å¡Šï¼Œæˆ‘å€‘å¸Œæœ›ã€Œèª°å…ˆè¼‰å¥½å°±å…ˆé¡¯ç¤ºèª°ã€ï¼Œè€Œä¸æ˜¯ç­‰å…¨éƒ¨ä¸€èµ·å¥½ã€‚é€™å°±æ˜¯ **Streaming (ä¸²æµ)** çš„æ¦‚å¿µã€‚

### Component Level Streaming
æˆ‘å€‘å¯ä»¥åˆ©ç”¨ React çš„ `<Suspense>` å…ƒä»¶æ‰‹å‹•åŒ…è£¹è€—æ™‚çš„å€å¡Šã€‚

```tsx
import { Suspense } from 'react';
import RevenueChart from './RevenueChart'; // é€™æ˜¯ä¸€å€‹æœƒ fetch è³‡æ–™çš„ async component
import LatestInvoices from './LatestInvoices'; // é€™ä¹Ÿæ˜¯ async component

export default function Dashboard() {
  return (
    <main>
      <h1>å„€è¡¨æ¿</h1>
      
      {/* ç‡Ÿæ”¶åœ–è¡¨å€å¡Š */}
      <Suspense fallback={<p>åœ–è¡¨ç¹ªè£½ä¸­...</p>}>
        <RevenueChart />
      </Suspense>

      {/* æœ€æ–°ç™¼ç¥¨å€å¡Š */}
      <Suspense fallback={<p>ç™¼ç¥¨åˆ—è¡¨è¼‰å…¥ä¸­...</p>}>
        <LatestInvoices />
      </Suspense>
    </main>
  );
}
```

é€™æ¨£åšçš„å¥½è™•æ˜¯ï¼šå³ä½¿ `RevenueChart` è¦è·‘ 5 ç§’ï¼Œä½¿ç”¨è€…ä¾ç„¶å¯ä»¥å…ˆçœ‹åˆ°æ¨™é¡Œï¼Œç”šè‡³å…ˆçœ‹åˆ°è·‘æ¯”è¼ƒå¿«çš„ `LatestInvoices`ã€‚æ•´å€‹é é¢ä¸æœƒè¢«æœ€æ…¢çš„å…ƒä»¶å¡ä½ (Blocking)ã€‚

---

## 4.3 éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ï¼šerror.tsx

æœ‰è¼‰å…¥å°±è¦æœ‰éŒ¯èª¤è™•ç†ã€‚Next.js æä¾›äº† `error.tsx` ä¾†å„ªé›…åœ°æ””æˆª Runtime Errorã€‚

### ç‰¹æ€§
1.  å¿…é ˆæ˜¯ **Client Component** (`'use client'`)ã€‚
2.  æ¥æ”¶ `error` ç‰©ä»¶èˆ‡ `reset` å‡½å¼ã€‚
3.  `reset()` è®“ä½¿ç”¨è€…å¯ä»¥å˜—è©¦ã€Œé‡è©¦ã€(Re-render) è©²å€å¡Šï¼Œè€Œä¸éœ€è¦é‡æ–°æ•´ç†æ•´é ã€‚

```tsx
// app/dashboard/error.tsx
'use client';

export default function Error({
  error,
  reset,
}: {
  error: Error;
  reset: () => void;
}) {
  return (
    <div className="error-box">
      <h2>å‡ºéŒ¯äº†ï¼</h2>
      <p>{error.message}</p>
      <button onClick={() => reset()}>é‡è©¦</button>
    </div>
  );
}
```

---

## [ç¯„ä¾‹æ¼”ç·´]ï¼šå¯¦ä½œã€Œå„€è¡¨æ¿ (Dashboard)ã€

æˆ‘å€‘ä¾†æ¨¡æ“¬ä¸€å€‹çœŸå¯¦å ´æ™¯ï¼šä¸€å€‹å„€è¡¨æ¿åŒ…å«ã€Œæ…¢é€Ÿçš„åœ–è¡¨ã€èˆ‡ã€Œå¿«é€Ÿçš„æ•¸æ“šã€ã€‚

1.  **å»ºç«‹ `app/dashboard/page.tsx`**

```tsx
import { Suspense } from 'react';

// æ¨¡æ“¬æ…¢é€Ÿå…ƒä»¶ ( delay 3ç§’ )
async function SlowChart() {
  await new Promise(resolve => setTimeout(resolve, 3000));
  return <div style={{ height: '200px', background: '#e0e7ff', padding: '20px' }}>ğŸ“Š é€™æ˜¯è·‘å¾ˆæ…¢çš„åœ–è¡¨</div>;
}

// æ¨¡æ“¬å¿«é€Ÿå…ƒä»¶ ( delay 0.5ç§’ )
async function FastStats() {
  await new Promise(resolve => setTimeout(resolve, 500));
  return <div style={{ padding: '20px', background: '#dcfce7' }}>ğŸ’° ç‡Ÿæ”¶ï¼š$5,000,000</div>;
}

export default function DashboardPage() {
  return (
    <div style={{ padding: '2rem' }}>
      <h1>å…¬å¸ç‡Ÿé‹å„€è¡¨æ¿</h1>
      
      <div style={{ display: 'grid', gap: '20px', gridTemplateColumns: '1fr 1fr' }}>
        
        <section>
          <h3>å³æ™‚æ•¸æ“š</h3>
          <Suspense fallback={<div style={{ padding: '20px', background: '#eee' }}>æ•¸æ“šè¨ˆç®—ä¸­...</div>}>
            <FastStats />
          </Suspense>
        </section>

        <section>
          <h3>å¹´åº¦åˆ†æåœ–è¡¨</h3>
          <Suspense fallback={<div style={{ height: '200px', background: '#eee', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>åœ–è¡¨ç¹ªè£½ä¸­ (é è¨ˆ 3 ç§’)...</div>}>
            <SlowChart />
          </Suspense>
        </section>

      </div>
    </div>
  );
}
```

2.  **é«”é©—ä¸²æµ**
    *   é–‹å•Ÿ `/dashboard`ã€‚
    *   ä½ æœƒ**ç«‹å³**çœ‹åˆ°æ¨™é¡Œèˆ‡å…©å€‹ç°è‰²çš„ loading å€å¡Š (Fallback)ã€‚
    *   0.5 ç§’å¾Œï¼Œã€Œå³æ™‚æ•¸æ“šã€æœƒå…ˆå½ˆå‡ºä¾†ã€‚
    *   3 ç§’å¾Œï¼Œã€Œåœ–è¡¨ã€æ‰å½ˆå‡ºä¾†ã€‚
    *   é€™å°±æ˜¯ **Progressive Rendering (æ¼¸é€²å¼æ¸²æŸ“)**ï¼Œä½¿ç”¨è€…é«”é©—æ¥µä½³ï¼
