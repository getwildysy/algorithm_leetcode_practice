# 第 10 章：堅若磐石 —— 測試策略 (Testing)

沒有測試的程式碼就是技術債。為了讓產品長久維護，我們需要建立完整的測試防護網。

## 10.1 測試金字塔

1.  **E2E (End-to-End) 測試** (最上層)：模擬真實使用者打開瀏覽器操作。成本最高，但信心度最高。
    *   工具：**Playwright**, Cypress。
2.  **整合測試 (Integration)** (中層)：測試多個元件或模組的互動。
    *   工具：**React Testing Library (RTL)** + Jest/Vitest。
3.  **單元測試 (Unit)** (底層)：測試單一函數或元件。
    *   工具：Jest, Vitest。

## 10.2 單元與整合測試 (Jest + RTL)

測試 React Component 是否正確渲染。

### 安裝
```bash
npm install -D jest jest-environment-jsdom @testing-library/react @testing-library/jest-dom
```

### 撰寫測試 (`components/Button.test.tsx`)
```tsx
import { render, screen } from '@testing-library/react'
import Button from './Button'

describe('Button', () => {
  it('renders a heading', () => {
    render(<Button>Click me</Button>)
    
    const button = screen.getByRole('button', { name: /click me/i })
    
    expect(button).toBeInTheDocument()
  })
})
```

---

## 10.3 端對端測試 (Playwright)

Next.js 官方大力推薦 Playwright，因為它支援多瀏覽器（Chromium, Firefox, WebKit）並能並行執行，速度極快。

### 安裝
```bash
npm init playwright@latest
```

### 撰寫測試 (`e2e/home.spec.ts`)
我們來測試首頁標題是否正確，並嘗試點擊導航。

```ts
import { test, expect } from '@playwright/test';

test('首頁應該有正確標題並能導航到關於頁', async ({ page }) => {
  // 1. 前往首頁
  await page.goto('http://localhost:3000');
  
  // 2. 驗證標題
  await expect(page).toHaveTitle(/我的部落格/);
  await expect(page.getByRole('heading', { level: 1 })).toContainText('歡迎來到 Next.js');
  
  // 3. 點擊連結
  await page.getByRole('link', { name: '關於我們' }).click();
  
  // 4. 驗證網址是否變更
  await expect(page).toHaveURL(/.*about/);
  
  // 5. 驗證新頁面內容
  await expect(page.getByText('這是關於頁面')).toBeVisible();
});
```
Playwright 甚至提供了 Codegen 工具，可以錄製你的操作並自動生成程式碼！

---

## 10.4 靜態分析與無障礙測試

別忘了最基礎的檢查工具。

1.  **TypeScript**：抓出型別錯誤。
2.  **ESLint**：抓出語法與風格錯誤。
    *   Next.js 內建了 `eslint-plugin-next`，會提醒你 `<img>` 要改用 `<Image>` 等最佳實踐。
3.  **Lighthouse CI**：自動跑分效能、SEO 與 Accessibility。

---

## [範例演練]：完整的測試流程

建立一個 CI/CD Pipeline (以 GitHub Actions 為例)，確保每次 Push 都要通過所有測試。

建立 `.github/workflows/test.yml`：

```yaml
name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      
      - name: Install dependencies
        run: npm ci
        
      - name: Run Lint
        run: npm run lint
        
      - name: Run Unit Tests
        run: npm run test
        
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
        
      - name: Run E2E Tests
        run: npx playwright test
```

現在，如果有人寫出爛 code 想偷偷 merge，CI 機器人會無情地擋下他。這就是現代軟體工程的品質保證。
