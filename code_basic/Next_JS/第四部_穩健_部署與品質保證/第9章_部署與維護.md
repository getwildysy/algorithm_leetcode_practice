# 第 9 章：部署與維護 (Deployment)

開發完成後，讓全世界看到你的作品是最後一哩路。Next.js 的母公司 Vercel 提供了最無痛的部署體驗，但了解 Docker 部署也是全端工程師必備技能。

## 9.1 Vercel 部署流程

### 為什麼選 Vercel？
*   **Git 整合**：Push code 就自動部署。
*   **預覽環境 (Preview Deployments)**：開 PR 就自動產生一個測試網址，這對團隊 Code Review 極有幫助。
*   **Edge Network**：全球 CDN 加速。

### 步驟
1.  將程式碼推送到 GitHub/GitLab。
2.  登入 Vercel -> Add New Project -> Import Repository。
3.  設定環境變數 (Environment Variables)。
4.  點擊 **Deploy**。

就這麼簡單。

---

## 9.2 環境變數管理 (.env)

安全性至上。永遠不要把 secrets 寫死在程式碼裡。

*   `.env.local`：本地開發用，**絕對不要 commit** 到 Git (加到 `.gitignore`)。
*   `.env`：公開的預設值（通常不放機密）。
*   **私鑰原則**：只有 server 端能讀取。Next.js 會自動過濾掉沒有 `NEXT_PUBLIC_` 前綴的變數，防止洩漏到瀏覽器。

```bash
# Server only (API keys, DB password)
DATABASE_URL="postgresql://..."
API_SECRET="xyz"

# Client accessible
NEXT_PUBLIC_ANALYTICS_ID="UA-123456"
```

---

## 9.3 Docker 容器化

如果你需要部署到 AWS, GCP 或公司內部的私有雲，Docker 是標準答案。

### 撰寫 Dockerfile
Next.js 官方提供了一個優化過的多階段構建 (Multi-stage build) Dockerfile，能大幅縮減映像檔大小。

```dockerfile
# 1. Install dependencies only when needed
FROM node:18-alpine AS deps
WORKDIR /app
COPY package.json package-lock.json ./ 
RUN npm ci

# 2. Rebuild the source code only when needed
FROM node:18-alpine AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build

# 3. Production image, copy all the files and run next
FROM node:18-alpine AS runner
WORKDIR /app
ENV NODE_ENV production

# Standalone output (Next.js 的黑科技，自動分析依賴，只打包必要的檔案)
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

EXPOSE 3000
CMD ["node", "server.js"]
```

### Next.js Standalone Mode
要在 `next.config.js` 開啟這個功能：
```js
module.exports = {
  output: 'standalone',
}
```
這會讓原本 1GB+ 的 node_modules 縮減到僅剩幾十 MB，極大優化容器體積。

---

## [範例演練]：自訂網域 (Custom Domain)

就算是用 Vercel 免費版，你也可以綁定自己的網域。

1.  在 Namecheap / GoDaddy 購買網域 (`example.com`)。
2.  在 Vercel 專案設定 -> Domains -> 輸入 `example.com`。
3.  Vercel 會給你一組 DNS 紀錄（通常是 A Record 指向 76.76.21.21 或 CNAME）。
4.  回到網域註冊商的後台設定 DNS。
5.  等待生效 (通常幾分鐘)，Vercel 會自動幫你申請並更新 SSL 憑證 (HTTPS)。

你的網站現在是專業的 `https://example.com` 了！
