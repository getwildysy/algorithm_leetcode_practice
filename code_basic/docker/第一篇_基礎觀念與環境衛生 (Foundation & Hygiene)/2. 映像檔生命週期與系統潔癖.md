# 2. æ˜ åƒæª”ç”Ÿå‘½é€±æœŸèˆ‡ç³»çµ±æ½”ç™–

## 2.1. æ˜ åƒæª”æ¨™ç±¤ç®¡ç†ï¼šlatest çš„é™·é˜±èˆ‡èªæ„åŒ–ç‰ˆæœ¬æ§åˆ¶

### latest æ¨™ç±¤çš„å¸¸è¦‹èª¤è§£

å¾ˆå¤šäººä»¥ç‚º `latest` æ¨™ç±¤ä»£è¡¨ã€Œæœ€æ–°ç‰ˆæœ¬ã€ï¼Œä½†å¯¦éš›ä¸Šå®ƒåªæ˜¯ä¸€å€‹**æ™®é€šçš„æ¨™ç±¤åç¨±**ï¼Œæ²’æœ‰ä»»ä½•ç‰¹æ®Šæ„ç¾©ã€‚

```bash
# å‡è¨­ä½ åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤
docker pull nginx

# ç­‰åŒæ–¼
docker pull nginx:latest

# ä½† latest ä¸ä¸€å®šæ˜¯ã€Œæœ€æ–°çš„ã€ï¼
```

**ç‚ºä»€éº¼æœƒé€ æˆæ··æ·†ï¼Ÿ**

1. **`latest` åªæ˜¯é è¨­æ¨™ç±¤**
   - ç•¶ä½ æ²’æœ‰æŒ‡å®šæ¨™ç±¤æ™‚ï¼ŒDocker è‡ªå‹•ä½¿ç”¨ `latest`
   - å®ƒä¸æœƒè‡ªå‹•æ›´æ–°ç‚ºæœ€æ–°ç‰ˆæœ¬

2. **æ‰‹å‹•æ¨™è¨˜æ‰æœƒæ›´æ–°**
   ```bash
   # å»ºç½®æ™‚æ‰‹å‹•æ¨™è¨˜ç‚º latest
   docker build -t myapp:latest .
   
   # æ¨é€åˆ° Registry
   docker push myapp:latest
   ```

3. **å¯èƒ½é€ æˆçš„å•é¡Œï¼šç‰ˆæœ¬ä¸ä¸€è‡´**
   
   **å ´æ™¯ï¼š** ä½ çš„åœ˜éšŠä¸‰å€‹æˆå“¡åœ¨ä¸åŒæ™‚é–“æ‹‰å–æ˜ åƒæª”
   
   ```bash
   # 2024-01-01: Alice æ‹‰å–
   docker pull myapp:latest  # å¯¦éš›æ˜¯ v1.0
   
   # 2024-02-01: ä½ æ¨é€æ–°ç‰ˆæœ¬
   docker tag myapp:v2.0 myapp:latest
   docker push myapp:latest
   
   # 2024-02-15: Bob æ‹‰å–
   docker pull myapp:latest  # å¯¦éš›æ˜¯ v2.0
   
   # çµæœï¼šAlice å’Œ Bob ä½¿ç”¨çš„æ˜¯ä¸åŒç‰ˆæœ¬ï¼
   ```

### èªæ„åŒ–ç‰ˆæœ¬æ§åˆ¶ (Semantic Versioning)

**æœ€ä½³å¯¦è¸ï¼šä½¿ç”¨æ˜ç¢ºçš„ç‰ˆæœ¬è™Ÿ**

```bash
# æ ¼å¼: MAJOR.MINOR.PATCH
docker build -t myapp:1.2.3 .

# å¤šé‡æ¨™ç±¤ç­–ç•¥
docker tag myapp:1.2.3 myapp:1.2
docker tag myapp:1.2.3 myapp:1
docker tag myapp:1.2.3 myapp:latest

# æ¨é€æ‰€æœ‰æ¨™ç±¤
docker push myapp:1.2.3
docker push myapp:1.2
docker push myapp:1
docker push myapp:latest
```

**ç‰ˆæœ¬è™Ÿæ„ç¾©ï¼š**
- **MAJOR** (ä¸»ç‰ˆæœ¬è™Ÿ): ä¸ç›¸å®¹çš„ API è®Šæ›´
- **MINOR** (æ¬¡ç‰ˆæœ¬è™Ÿ): å‘ä¸‹ç›¸å®¹çš„åŠŸèƒ½æ–°å¢
- **PATCH** (ä¿®è¨‚è™Ÿ): å‘ä¸‹ç›¸å®¹çš„å•é¡Œä¿®æ­£

**ç¯„ä¾‹ï¼šnginx å®˜æ–¹æ˜ åƒæª”**

```bash
# æŸ¥çœ‹ nginx çš„æ‰€æœ‰æ¨™ç±¤
docker pull nginx:1.25.3
docker pull nginx:1.25
docker pull nginx:1
docker pull nginx:latest

# æŸ¥çœ‹æ˜ åƒæª” IDï¼ˆæœƒç™¼ç¾éƒ¨åˆ†æ¨™ç±¤æŒ‡å‘åŒä¸€å€‹æ˜ åƒæª”ï¼‰
docker images nginx

# è¼¸å‡ºç¯„ä¾‹ï¼š
# REPOSITORY   TAG       IMAGE ID       CREATED       SIZE
# nginx        1.25.3    a1b2c3d4e5f6   2 weeks ago   187MB
# nginx        1.25      a1b2c3d4e5f6   2 weeks ago   187MB  â† ç›¸åŒ ID
# nginx        1         a1b2c3d4e5f6   2 weeks ago   187MB  â† ç›¸åŒ ID
# nginx        latest    a1b2c3d4e5f6   2 weeks ago   187MB  â† ç›¸åŒ ID
```

### Docker Compose ä¸­çš„æœ€ä½³å¯¦è¸

**ä¸å¥½çš„åšæ³•ï¼š**
```yaml
services:
  web:
    image: nginx:latest  # âŒ å®¹æ˜“é€ æˆä¸åŒç’°å¢ƒç‰ˆæœ¬ä¸ä¸€è‡´
```

**å¥½çš„åšæ³•ï¼š**
```yaml
services:
  web:
    image: nginx:1.25.3  # âœ… æ˜ç¢ºæŒ‡å®šç‰ˆæœ¬
```

**ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ç®¡ç†ç‰ˆæœ¬ï¼š**

```yaml
# docker-compose.yml
services:
  web:
    image: nginx:${NGINX_VERSION:-1.25.3}  # é è¨­ 1.25.3
```

```bash
# .env æª”æ¡ˆ
NGINX_VERSION=1.25.3
```

```bash
# ä¸åŒç’°å¢ƒä½¿ç”¨ä¸åŒç‰ˆæœ¬
NGINX_VERSION=1.24.0 docker-compose up -d
```

### è‡ªå‹•åŒ–æ¨™ç±¤ç­–ç•¥

**ä½¿ç”¨ Git æ¨™ç±¤è‡ªå‹•å»ºç½®æ˜ åƒæª”ï¼š**

```bash
#!/bin/bash
# build-and-tag.sh

# å–å¾— Git commit hash
GIT_COMMIT=$(git rev-parse --short HEAD)

# å–å¾— Git æ¨™ç±¤ï¼ˆå¦‚æœæœ‰ï¼‰
GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "dev")

# å»ºç½®æ˜ åƒæª”
docker build -t myapp:${GIT_TAG} \
             -t myapp:${GIT_COMMIT} \
             -t myapp:latest \
             .

echo "Built images:"
echo "  - myapp:${GIT_TAG}"
echo "  - myapp:${GIT_COMMIT}"
echo "  - myapp:latest"
```

**ä½¿ç”¨ç¯„ä¾‹ï¼š**
```bash
# é–‹ç™¼ç’°å¢ƒï¼ˆæ²’æœ‰ Git æ¨™ç±¤ï¼‰
./build-and-tag.sh
# Output: myapp:dev, myapp:a1b2c3d, myapp:latest

# ç”Ÿç”¢ç’°å¢ƒï¼ˆæœ‰ Git æ¨™ç±¤ï¼‰
git tag v1.0.0
./build-and-tag.sh
# Output: myapp:v1.0.0, myapp:a1b2c3d, myapp:latest
```

---

## 2.2. æ¸…ç†èˆŠæ˜ åƒæª”ç­–ç•¥

### 2.2.1. è¾¨è­˜ã€Œæ‡¸ç©ºæ˜ åƒæª”ã€(Dangling Images / <none>) çš„æˆå› 

### ä»€éº¼æ˜¯æ‡¸ç©ºæ˜ åƒæª”ï¼Ÿ

æ‡¸ç©ºæ˜ åƒæª” (Dangling Images) æ˜¯æŒ‡**æ²’æœ‰æ¨™ç±¤åç¨±**çš„æ˜ åƒæª”å±¤ï¼Œåœ¨ `docker images` ä¸­é¡¯ç¤ºç‚º `<none>:<none>`ã€‚

```bash
# æŸ¥çœ‹æ‡¸ç©ºæ˜ åƒæª”
docker images -f "dangling=true"

# è¼¸å‡ºç¯„ä¾‹ï¼š
# REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
# <none>       <none>    abc123def456   10 minutes ago   150MB
# <none>       <none>    def456abc123   1 hour ago       200MB
```

### æ‡¸ç©ºæ˜ åƒæª”çš„ç”¢ç”ŸåŸå› 

**åŸå›  1: é‡æ–°å»ºç½®ç›¸åŒæ¨™ç±¤çš„æ˜ åƒæª”**

```bash
# ç¬¬ä¸€æ¬¡å»ºç½®
docker build -t myapp:v1 .
# ç”¢ç”Ÿæ˜ åƒæª” ID: aaa111

# ä¿®æ”¹ Dockerfile å¾Œå†æ¬¡å»ºç½®ï¼ˆä½¿ç”¨ç›¸åŒæ¨™ç±¤ï¼‰
docker build -t myapp:v1 .
# ç”¢ç”Ÿæ˜ åƒæª” ID: bbb222

# çµæœï¼š
# - myapp:v1 ç¾åœ¨æŒ‡å‘ bbb222
# - aaa111 è®Šæˆæ‡¸ç©ºæ˜ åƒæª”ï¼ˆå› ç‚ºæ¨™ç±¤è¢«ç§»é™¤äº†ï¼‰
```

**è¦–è¦ºåŒ–æµç¨‹ï¼š**
```
å»ºç½®å‰:
myapp:v1 â”€â”€â–º aaa111

å»ºç½®å¾Œ:
myapp:v1 â”€â”€â–º bbb222
              aaa111  â† æ‡¸ç©ºæ˜ åƒæª”ï¼ˆæ²’æœ‰æ¨™ç±¤æŒ‡å‘å®ƒï¼‰
```

**åŸå›  2: æ‹‰å–æ–°ç‰ˆæœ¬è¦†è“‹èˆŠç‰ˆæœ¬**

```bash
# æ‹‰å–æ˜ åƒæª”
docker pull nginx:latest  # æ‹‰å–åˆ° ID: old123

# éä¸€æ®µæ™‚é–“å¾Œï¼Œnginx:latest æ›´æ–°äº†
docker pull nginx:latest  # æ‹‰å–åˆ° ID: new456

# çµæœï¼šold123 è®Šæˆæ‡¸ç©ºæ˜ åƒæª”
```

**åŸå›  3: å¤šéšæ®µå»ºç½®ç”¢ç”Ÿçš„ä¸­é–“å±¤**

```dockerfile
# Dockerfile
FROM node:18 AS builder  # â† ä¸­é–“éšæ®µ
WORKDIR /app
COPY package.json .
RUN npm install

FROM nginx:alpine        # â† æœ€çµ‚éšæ®µ
COPY --from=builder /app/dist /usr/share/nginx/html
```

```bash
docker build -t myapp .
# å»ºç½®éç¨‹ä¸­æœƒç”¢ç”Ÿ builder éšæ®µçš„æ˜ åƒæª”
# ä½†æ²’æœ‰æ¨™ç±¤æŒ‡å‘å®ƒï¼Œæˆç‚ºæ‡¸ç©ºæ˜ åƒæª”
```

**åŸå›  4: åˆªé™¤æ˜ åƒæª”ä½†ä¿ç•™ä¾è³´å±¤**

```bash
# å‡è¨­æœ‰å…©å€‹æ˜ åƒæª”å…±äº«åŸºç¤å±¤
docker build -t app1 .  # ä½¿ç”¨ ubuntu:22.04
docker build -t app2 .  # ä¹Ÿä½¿ç”¨ ubuntu:22.04

# åˆªé™¤ app1
docker rmi app1

# å¦‚æœ ubuntu:22.04 æ²’æœ‰å…¶ä»–æ¨™ç±¤ï¼Œå¯èƒ½è®Šæˆæ‡¸ç©ºæ˜ åƒæª”
```

### æŸ¥çœ‹æ‡¸ç©ºæ˜ åƒæª”çš„è©³ç´°è³‡è¨Š

```bash
# åˆ—å‡ºæ‡¸ç©ºæ˜ åƒæª”çš„è©³ç´°è³‡è¨Š
docker images -f "dangling=true" --no-trunc

# æŸ¥çœ‹ç‰¹å®šæ‡¸ç©ºæ˜ åƒæª”çš„æ­·å²
docker history <IMAGE_ID>

# æŸ¥çœ‹ä¾è³´é—œä¿‚
docker image inspect <IMAGE_ID> --format='{{.Parent}}'
```

---

### 2.2.2. ä½¿ç”¨ docker image prune é€²è¡Œå®‰å…¨æ¸…ç†

### åŸºæœ¬ç”¨æ³•

```bash
# æ¸…ç†æ‡¸ç©ºæ˜ åƒæª”ï¼ˆæœ€å®‰å…¨ï¼‰
docker image prune

# è¼¸å‡ºï¼š
# WARNING! This will remove all dangling images.
# Are you sure you want to continue? [y/N] y
# Deleted Images:
# deleted: sha256:abc123...
# deleted: sha256:def456...
# Total reclaimed space: 1.5GB
```

### é€²éšé¸é …

**1. è‡ªå‹•ç¢ºèªï¼ˆä¸æç¤ºï¼‰**
```bash
docker image prune -f
# æˆ–
docker image prune --force
```

**2. æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨çš„æ˜ åƒæª”ï¼ˆå±éšªï¼ï¼‰**
```bash
# æ¸…ç†æ‰€æœ‰æ²’æœ‰è¢«å®¹å™¨ä½¿ç”¨çš„æ˜ åƒæª”
docker image prune -a

# è¼¸å‡ºè­¦å‘Šï¼š
# WARNING! This will remove all images without at least one container associated to them.
# Are you sure you want to continue? [y/N]
```

> âš ï¸ **è­¦å‘Š**ï¼š`-a` é¸é …æœƒåˆªé™¤**æ‰€æœ‰æ²’æœ‰è¢«å®¹å™¨ä½¿ç”¨çš„æ˜ åƒæª”**ï¼ŒåŒ…æ‹¬ä½ ç²¾å¿ƒå»ºç½®çš„ç‰ˆæœ¬ï¼

**3. ä½¿ç”¨éæ¿¾å™¨**
```bash
# æ¸…ç† 24 å°æ™‚å‰å»ºç«‹çš„æ‡¸ç©ºæ˜ åƒæª”
docker image prune -f --filter "until=24h"

# æ¸…ç† 7 å¤©å‰å»ºç«‹çš„æ‰€æœ‰æœªä½¿ç”¨æ˜ åƒæª”
docker image prune -a -f --filter "until=168h"

# æ¸…ç†ç‰¹å®šæ¨™ç±¤æ¨¡å¼
docker images | grep "^<none>" | awk '{print $3}' | xargs docker rmi
```

**éæ¿¾å™¨èªæ³•ç¯„ä¾‹ï¼š**
```bash
# until: ç›¸å°æ™‚é–“
until=24h       # 24 å°æ™‚å‰
until=168h      # 7 å¤©å‰ (24 * 7)
until=720h      # 30 å¤©å‰ (24 * 30)

# label: æ¨™ç±¤éæ¿¾
label=version=1.0
label!=production
```

### å®‰å…¨æ¸…ç†ç­–ç•¥

**æ­¥é©Ÿ 1: å…ˆæª¢è¦–æœƒè¢«åˆªé™¤çš„å…§å®¹**
```bash
# åˆ—å‡ºæ‡¸ç©ºæ˜ åƒæª”
docker images -f "dangling=true"

# è¨ˆç®—å¯å›æ”¶ç©ºé–“
docker system df
```

**æ­¥é©Ÿ 2: ä¿ç•™é‡è¦æ˜ åƒæª”**
```bash
# ç‚ºé‡è¦æ˜ åƒæª”å»ºç«‹æ–°æ¨™ç±¤
docker tag abc123def456 myapp:backup-20241212
```

**æ­¥é©Ÿ 3: åŸ·è¡Œæ¸…ç†**
```bash
# åªæ¸…ç†æ‡¸ç©ºæ˜ åƒæª”
docker image prune -f
```

**æ­¥é©Ÿ 4: é©—è­‰çµæœ**
```bash
# ç¢ºèªé‡è¦æ˜ åƒæª”é‚„åœ¨
docker images | grep myapp

# æŸ¥çœ‹å›æ”¶çš„ç©ºé–“
docker system df
```

### è‡ªå‹•åŒ–å®šæœŸæ¸…ç†è…³æœ¬

```bash
#!/bin/bash
# docker-cleanup.sh

echo "=== Docker æ¸…ç†è…³æœ¬ ==="
echo ""

# é¡¯ç¤ºæ¸…ç†å‰çš„ç‹€æ…‹
echo "æ¸…ç†å‰ï¼š"
docker system df

echo ""
echo "é–‹å§‹æ¸…ç†..."

# 1. æ¸…ç†åœæ­¢çš„å®¹å™¨
echo "â†’ æ¸…ç†åœæ­¢çš„å®¹å™¨"
docker container prune -f --filter "until=24h"

# 2. æ¸…ç†æ‡¸ç©ºæ˜ åƒæª”
echo "â†’ æ¸…ç†æ‡¸ç©ºæ˜ åƒæª”"
docker image prune -f

# 3. æ¸…ç†æœªä½¿ç”¨çš„ç¶²è·¯
echo "â†’ æ¸…ç†æœªä½¿ç”¨çš„ç¶²è·¯"
docker network prune -f

# 4. æ¸…ç†æœªä½¿ç”¨çš„ Volumes
echo "â†’ æ¸…ç†æœªä½¿ç”¨çš„ Volumesï¼ˆè¬¹æ…ï¼‰"
# docker volume prune -f  # å–æ¶ˆè¨»è§£ä»¥å•Ÿç”¨

echo ""
echo "æ¸…ç†å¾Œï¼š"
docker system df

echo ""
echo "âœ… æ¸…ç†å®Œæˆï¼"
```

**è¨­å®š Cron å®šæœŸåŸ·è¡Œï¼ˆæ¯é€±æ—¥å‡Œæ™¨ 3 é»ï¼‰ï¼š**
```bash
# ç·¨è¼¯ crontab
crontab -e

# åŠ å…¥ä»¥ä¸‹å…§å®¹
0 3 * * 0 /path/to/docker-cleanup.sh >> /var/log/docker-cleanup.log 2>&1
```

---

## 2.3. ç£ç¢Ÿç©ºé–“æ•‘æ´èˆ‡ç¶­è­·

### 2.3.1. ä½¿ç”¨ docker system prune çš„é¢¨éšªè©•ä¼°èˆ‡æœ€ä½³æ™‚æ©Ÿ

### docker system prune åšäº†ä»€éº¼ï¼Ÿ

`docker system prune` æ˜¯ä¸€å€‹ã€Œçµ„åˆæŠ€ã€æŒ‡ä»¤ï¼ŒæœƒåŒæ™‚æ¸…ç†ï¼š
1. åœæ­¢çš„å®¹å™¨
2. æ‡¸ç©ºæ˜ åƒæª”
3. æœªä½¿ç”¨çš„ç¶²è·¯
4. æœªä½¿ç”¨çš„å»ºç½®å¿«å–

```bash
# åŸºæœ¬ç”¨æ³•
docker system prune

# è¼¸å‡ºè­¦å‘Šï¼š
# WARNING! This will remove:
#   - all stopped containers
#   - all networks not used by at least one container
#   - all dangling images
#   - all dangling build cache
# Are you sure you want to continue? [y/N]
```

### é¢¨éšªç­‰ç´šåˆ†æ

| å‘½ä»¤ | é¢¨éšªç­‰ç´š | åˆªé™¤å…§å®¹ | å»ºè­°ä½¿ç”¨æ™‚æ©Ÿ |
|------|---------|---------|-------------|
| `docker system prune` | ğŸŸ¡ ä¸­ | åœæ­¢çš„å®¹å™¨ã€æ‡¸ç©ºæ˜ åƒæª” | å®šæœŸç¶­è­· |
| `docker system prune -a` | ğŸ”´ é«˜ | + æ‰€æœ‰æœªä½¿ç”¨æ˜ åƒæª” | ç£ç¢Ÿç©ºé–“ç·Šæ€¥ |
| `docker system prune --volumes` | ğŸ”´ æ¥µé«˜ | + æ‰€æœ‰æœªä½¿ç”¨ Volumes | **è³‡æ–™éºå¤±é¢¨éšªï¼** |
| `docker system prune -a --volumes` | ğŸ”´ğŸ”´ ç½é›£ç´š | ä¸€æ¬¡æ¸…é™¤æ‰€æœ‰ | **åƒ…é™é–‹ç™¼ç’°å¢ƒ** |

### å„é¸é …è©³è§£

**1. åŸºæœ¬æ¸…ç†ï¼ˆè¼ƒå®‰å…¨ï¼‰**
```bash
docker system prune -f

# ç­‰åŒæ–¼åŸ·è¡Œï¼š
docker container prune -f  # æ¸…ç†åœæ­¢çš„å®¹å™¨
docker image prune -f      # æ¸…ç†æ‡¸ç©ºæ˜ åƒæª”
docker network prune -f    # æ¸…ç†æœªä½¿ç”¨ç¶²è·¯
```

**å¯¦éš›ç¯„ä¾‹ï¼š**
```bash
$ docker system prune -f

Deleted Containers:
abc123def456...
def456abc123...

Deleted Images:
untagged: myapp@sha256:...
deleted: sha256:old123...

Deleted Networks:
old_network
test_network

Total reclaimed space: 2.5GB
```

**2. æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨æ˜ åƒæª”ï¼ˆå±éšªï¼‰**
```bash
docker system prune -a -f
```

**æœƒåˆªé™¤çš„æƒ…æ³ï¼š**
```bash
# å‡è¨­ä½ æœ‰é€™äº›æ˜ åƒæª”
docker images
# nginx:1.25.3    (æ²’æœ‰å®¹å™¨ä½¿ç”¨) â† æœƒè¢«åˆªé™¤
# postgres:15     (æ²’æœ‰å®¹å™¨ä½¿ç”¨) â† æœƒè¢«åˆªé™¤
# myapp:v1.0      (æ²’æœ‰å®¹å™¨ä½¿ç”¨) â† æœƒè¢«åˆªé™¤
# redis:latest    (æœ‰å®¹å™¨ä½¿ç”¨)   â† ä¿ç•™
```

**3. åŒ…å« Volumesï¼ˆæ¥µåº¦å±éšªï¼‰**
```bash
docker system prune --volumes -f
```

> âš ï¸ **è­¦å‘Š**ï¼šé€™æœƒåˆªé™¤**è³‡æ–™åº«è³‡æ–™ã€ä¸Šå‚³çš„æª”æ¡ˆ**ç­‰æ°¸ä¹…æ€§è³‡æ–™ï¼

**ç¯„ä¾‹ç½é›£å ´æ™¯ï¼š**
```yaml
# docker-compose.yml
services:
  db:
    image: postgres:15
    volumes:
      - db_data:/var/lib/postgresql/data  # â† è³‡æ–™åº«è³‡æ–™

volumes:
  db_data:  # â† æœƒè¢« prune --volumes åˆªé™¤ï¼
```

```bash
# åœæ­¢æœå‹™
docker-compose down

# éŒ¯èª¤æ“ä½œ
docker system prune --volumes -f
# ğŸ’€ db_data è¢«åˆªé™¤ï¼Œæ‰€æœ‰è³‡æ–™åº«è³‡æ–™éºå¤±ï¼
```

### æœ€ä½³ä½¿ç”¨æ™‚æ©Ÿ

**âœ… é©åˆä½¿ç”¨ `docker system prune` çš„æƒ…å¢ƒï¼š**
1. **é–‹ç™¼ç’°å¢ƒå®šæœŸæ¸…ç†**
   ```bash
   # æ¯é€±äº”ä¸‹ç­å‰æ¸…ç†
   docker system prune -f
   ```

2. **CI/CD Pipeline å»ºç½®å¾Œæ¸…ç†**
   ```bash
   # .gitlab-ci.yml
   after_script:
     - docker system prune -f --filter "until=1h"
   ```

3. **ç£ç¢Ÿç©ºé–“ä¸è¶³ç·Šæ€¥è™•ç†**
   ```bash
   # æŸ¥çœ‹ç©ºé–“
   df -h
   
   # ç·Šæ€¥æ¸…ç†
   docker system prune -a -f --filter "until=72h"
   ```

**âŒ ä¸é©åˆçš„æƒ…å¢ƒï¼š**
1. ç”Ÿç”¢ç’°å¢ƒï¼ˆå¯èƒ½å½±éŸ¿æœå‹™ï¼‰
2. æœ‰é‡è¦è³‡æ–™çš„ Volumes æ™‚ï¼ˆä½¿ç”¨ `--volumes`ï¼‰
3. éœ€è¦ä¿ç•™ç‰¹å®šç‰ˆæœ¬æ˜ åƒæª”æ™‚ï¼ˆä½¿ç”¨ `-a`ï¼‰

### å®‰å…¨çš„æ¸…ç†æµç¨‹

```bash
# æ­¥é©Ÿ 1: æŸ¥çœ‹ç•¶å‰ç£ç¢Ÿä½¿ç”¨æƒ…æ³
docker system df -v

# è¼¸å‡ºç¯„ä¾‹ï¼š
# Images space usage:
# REPOSITORY    TAG       SIZE      SHARED SIZE   UNIQUE SIZE   CONTAINERS
# nginx         latest    187MB     0B            187MB         0
# postgres      15        412MB     0B            412MB         1
#
# Containers space usage:
# CONTAINER ID   IMAGE          SIZE
# abc123         postgres:15    50MB  â† æœ‰åœ¨ä½¿ç”¨
#
# Local Volumes space usage:
# VOLUME NAME         SIZE
# db_data             1.2GB     â† é‡è¦è³‡æ–™ï¼
# temp_cache          500MB     â† å¯åˆªé™¤

# æ­¥é©Ÿ 2: è­˜åˆ¥å¯å®‰å…¨åˆªé™¤çš„é …ç›®
docker ps -a | grep "Exited"        # åœæ­¢çš„å®¹å™¨
docker images -f "dangling=true"    # æ‡¸ç©ºæ˜ åƒæª”
docker volume ls -f "dangling=true" # æ‡¸ç©º Volumes

# æ­¥é©Ÿ 3: åˆ†éšæ®µæ¸…ç†
docker container prune -f           # å…ˆæ¸…ç†å®¹å™¨
docker image prune -f               # å†æ¸…ç†æ‡¸ç©ºæ˜ åƒæª”
docker network prune -f             # æ¸…ç†ç¶²è·¯

# æ­¥é©Ÿ 4: ç¢ºèªçµæœ
docker system df
```

---

### 2.3.2. è¨­å®š Log Rotationï¼ˆæ—¥èªŒè¼ªæ›¿ï¼‰ï¼šé¿å… Container Log å¡çˆ†ç¡¬ç¢Ÿ

### å®¹å™¨æ—¥èªŒçš„é è¨­è¡Œç‚º

Docker é è¨­æœƒå°‡å®¹å™¨çš„ `stdout` å’Œ `stderr` è¼¸å‡ºå„²å­˜ç‚º JSON æ ¼å¼çš„æ—¥èªŒæª”æ¡ˆã€‚

**æ—¥èªŒæª”æ¡ˆä½ç½®ï¼š**
```bash
# Linux
/var/lib/docker/containers/<CONTAINER_ID>/<CONTAINER_ID>-json.log

# ç¯„ä¾‹
/var/lib/docker/containers/abc123def456.../abc123def456...-json.log
```

**æŸ¥çœ‹å®¹å™¨æ—¥èªŒæª”æ¡ˆå¤§å°ï¼š**
```bash
# åˆ—å‡ºæ‰€æœ‰å®¹å™¨çš„æ—¥èªŒæª”æ¡ˆå¤§å°
sudo du -sh /var/lib/docker/containers/*/*.log

# è¼¸å‡ºç¯„ä¾‹ï¼š
# 1.2G  /var/lib/docker/containers/abc123.../abc123...-json.log
# 500M  /var/lib/docker/containers/def456.../def456...-json.log
# 3.5G  /var/lib/docker/containers/ghi789.../ghi789...-json.log  â† å•é¡Œï¼
```

**ç½é›£å ´æ™¯ï¼š**
```bash
# ä¸€å€‹æŒçºŒè¼¸å‡ºæ—¥èªŒçš„æ‡‰ç”¨
while true; do
  echo "Processing request..."
  sleep 0.1
done

# å¹¾å¤©å¾Œ...
# æ—¥èªŒæª”æ¡ˆå¤§å°: 50GB+
# ç£ç¢Ÿç©ºé–“: 0% å‰©é¤˜
# çµæœ: ç³»çµ±å´©æ½°
```

### è§£æ±ºæ–¹æ¡ˆ 1: Docker Daemon å…¨åŸŸè¨­å®š

**ç·¨è¼¯ Docker Daemon è¨­å®šæª”ï¼š**

```bash
# ç·¨è¼¯è¨­å®šæª”
sudo nano /etc/docker/daemon.json
```

**åŠ å…¥æ—¥èªŒè¼ªæ›¿è¨­å®šï¼š**
```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3",
    "compress": "true"
  }
}
```

**åƒæ•¸èªªæ˜ï¼š**
- `max-size`: å–®ä¸€æ—¥èªŒæª”æ¡ˆçš„æœ€å¤§å¤§å°ï¼ˆ10m = 10MBï¼‰
- `max-file`: ä¿ç•™çš„æ—¥èªŒæª”æ¡ˆæ•¸é‡ï¼ˆ3 å€‹ï¼‰
- `compress`: æ˜¯å¦å£“ç¸®èˆŠçš„æ—¥èªŒæª”æ¡ˆ

**è¨ˆç®—ç¸½æ—¥èªŒå¤§å°ï¼š**
```
ç¸½æ—¥èªŒå¤§å° = max-size Ã— max-file
         = 10MB Ã— 3
         = 30MBï¼ˆæ¯å€‹å®¹å™¨ï¼‰
```

**é‡å•Ÿ Docker Daemon å¥—ç”¨è¨­å®šï¼š**
```bash
# é‡å•Ÿ Docker
sudo systemctl restart docker

# é©—è­‰è¨­å®š
docker info | grep "Logging Driver"
# è¼¸å‡º: Logging Driver: json-file
```

### è§£æ±ºæ–¹æ¡ˆ 2: å–®ä¸€å®¹å™¨è¨­å®š

**docker run æŒ‡å®šæ—¥èªŒè¨­å®šï¼š**
```bash
docker run -d \
  --name my-app \
  --log-driver json-file \
  --log-opt max-size=5m \
  --log-opt max-file=2 \
  nginx
```

**Docker Compose è¨­å®šï¼š**
```yaml
version: '3.8'

services:
  web:
    image: nginx
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
  
  app:
    image: myapp
    logging:
      driver: "json-file"
      options:
        max-size: "50m"  # æ‡‰ç”¨ç¨‹å¼å¯èƒ½éœ€è¦æ›´å¤šæ—¥èªŒ
        max-file: "5"
  
  db:
    image: postgres
    logging:
      driver: "json-file"
      options:
        max-size: "100m"  # è³‡æ–™åº«æ—¥èªŒé€šå¸¸è¼ƒå¤§
        max-file: "3"
```

### è§£æ±ºæ–¹æ¡ˆ 3: ä½¿ç”¨ä¸åŒçš„ Log Driver

**1. local é©…å‹•ï¼ˆæ•ˆèƒ½æ›´å¥½ï¼‰**
```yaml
services:
  app:
    image: myapp
    logging:
      driver: "local"
      options:
        max-size: "10m"
        max-file: "3"
```

**2. syslog é©…å‹•ï¼ˆé›†ä¸­åŒ–æ—¥èªŒï¼‰**
```yaml
services:
  app:
    image: myapp
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://192.168.1.100:514"
        tag: "myapp"
```

**3. journald é©…å‹•ï¼ˆLinux ç³»çµ±æ—¥èªŒï¼‰**
```yaml
services:
  app:
    image: myapp
    logging:
      driver: "journald"
```

**æŸ¥çœ‹ journald æ—¥èªŒï¼š**
```bash
# æŸ¥çœ‹ç‰¹å®šå®¹å™¨çš„æ—¥èªŒ
journalctl CONTAINER_NAME=my-app

# å¾æœ€å¾Œ 100 è¡Œé–‹å§‹
journalctl -n 100 CONTAINER_NAME=my-app

# æŒçºŒè¿½è¹¤
journalctl -f CONTAINER_NAME=my-app
```

### é©—è­‰æ—¥èªŒè¼ªæ›¿æ˜¯å¦ç”Ÿæ•ˆ

**å»ºç«‹æ¸¬è©¦å®¹å™¨ï¼š**
```bash
# å•Ÿå‹•ä¸€å€‹æŒçºŒè¼¸å‡ºæ—¥èªŒçš„å®¹å™¨
docker run -d \
  --name log-test \
  --log-opt max-size=1m \
  --log-opt max-file=3 \
  busybox \
  sh -c 'while true; do echo "Test log message $(date)"; sleep 0.01; done'
```

**ç›£æ§æ—¥èªŒæª”æ¡ˆï¼š**
```bash
# æŒçºŒç›£æ§æ—¥èªŒæª”æ¡ˆå¤§å°
watch -n 1 'sudo du -h /var/lib/docker/containers/$(docker inspect -f "{{.Id}}" log-test)/$(docker inspect -f "{{.Id}}" log-test)-json.log'

# åˆ—å‡ºæ‰€æœ‰æ—¥èªŒæª”æ¡ˆï¼ˆåŒ…å«è¼ªæ›¿æª”æ¡ˆï¼‰
sudo ls -lh /var/lib/docker/containers/$(docker inspect -f "{{.Id}}" log-test)/

# è¼¸å‡ºç¯„ä¾‹ï¼š
# -rw-r-----  1 root root 1.0M Dec 12 10:00 <container-id>-json.log
# -rw-r-----  1 root root 1.0M Dec 12 09:50 <container-id>-json.log.1
# -rw-r-----  1 root root 1.0M Dec 12 09:40 <container-id>-json.log.2
```

### æœ€ä½³å¯¦è¸å»ºè­°

**1. æ ¹æ“šæ‡‰ç”¨é¡å‹èª¿æ•´è¨­å®š**

| æ‡‰ç”¨é¡å‹ | max-size å»ºè­° | max-file å»ºè­° | ç¸½å®¹é‡ |
|---------|--------------|--------------|--------|
| éœæ…‹ç¶²ç«™ | 1m | 2 | 2MB |
| API æœå‹™ | 10m | 3 | 30MB |
| è³‡æ–™åº« | 100m | 3 | 300MB |
| å¤§é‡æ—¥èªŒæ‡‰ç”¨ | ä½¿ç”¨å¤–éƒ¨æ—¥èªŒç³»çµ± | - | - |

**2. ç”Ÿç”¢ç’°å¢ƒï¼šä½¿ç”¨é›†ä¸­åŒ–æ—¥èªŒç³»çµ±**

```yaml
# æ¨è–¦æ¶æ§‹ï¼šELK Stack (Elasticsearch, Logstash, Kibana)
services:
  app:
    image: myapp
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "docker.{{.Name}}"
```

**3. å®šæœŸæª¢æŸ¥æ—¥èªŒç£ç¢Ÿä½¿ç”¨é‡**

```bash
#!/bin/bash
# check-docker-logs.sh

echo "=== Docker æ—¥èªŒä½¿ç”¨æƒ…æ³ ==="

# ç¸½æ—¥èªŒå¤§å°
total_size=$(sudo du -sh /var/lib/docker/containers | awk '{print $1}')
echo "ç¸½æ—¥èªŒå¤§å°: $total_size"

# å‰ 10 å¤§æ—¥èªŒæª”æ¡ˆ
echo ""
echo "å‰ 10 å¤§æ—¥èªŒæª”æ¡ˆ:"
sudo find /var/lib/docker/containers -name "*-json.log" -exec du -h {} \; | sort -rh | head -10

# è­¦å‘Šï¼šæ—¥èªŒè¶…é 1GB çš„å®¹å™¨
echo ""
echo "âš ï¸ è­¦å‘Šï¼šä»¥ä¸‹å®¹å™¨æ—¥èªŒè¶…é 1GB:"
sudo find /var/lib/docker/containers -name "*-json.log" -size +1G -exec du -h {} \;
```

**è¨­å®šå‘Šè­¦è…³æœ¬ï¼ˆCronï¼‰ï¼š**
```bash
# æ¯å¤©æ—©ä¸Š 9 é»æª¢æŸ¥
0 9 * * * /path/to/check-docker-logs.sh | mail -s "Docker Log Report" admin@example.com
```

é€™æ¨£å¯ä»¥æœ‰æ•ˆé¿å…æ—¥èªŒå¡çˆ†ç¡¬ç¢Ÿçš„ç½é›£ï¼
