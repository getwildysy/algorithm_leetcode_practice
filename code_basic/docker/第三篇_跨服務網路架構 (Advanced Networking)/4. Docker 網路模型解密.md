# 4. Docker ç¶²è·¯æ¨¡å‹è§£å¯†

## 4.1. é è¨­ç¶²è·¯é©…å‹•æ¯”è¼ƒï¼šBridge, Host, None çš„é©ç”¨å ´æ™¯

### Docker ç¶²è·¯é©…å‹•æ¦‚è¦½

Docker æä¾›å¤šç¨®ç¶²è·¯é©…å‹• (Network Driver)ï¼Œæ¯ç¨®éƒ½æœ‰ç‰¹å®šçš„ä½¿ç”¨å ´æ™¯èˆ‡ç‰¹æ€§ã€‚

```bash
# æŸ¥çœ‹æ‰€æœ‰ç¶²è·¯
docker network ls

# è¼¸å‡ºç¯„ä¾‹ï¼š
# NETWORK ID     NAME      DRIVER    SCOPE
# abc123def456   bridge    bridge    local   â† é è¨­ç¶²è·¯
# def456abc123   host      host      local
# ghi789def012   none      null      local
```

---

### 1. Bridge Networkï¼ˆæ©‹æ¥ç¶²è·¯ï¼‰

**é‹ä½œåŸç†ï¼š**

```
Host Machine
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Container 1          Container 2        â”‚
â”‚  172.17.0.2          172.17.0.3          â”‚
â”‚       â”‚                    â”‚              â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                â”‚                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚     â”‚   docker0 (bridge)  â”‚               â”‚
â”‚     â”‚     172.17.0.1      â”‚               â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                â”‚                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚     â”‚    eth0 (ä¸»æ©Ÿç¶²å¡)   â”‚               â”‚
â”‚     â”‚   192.168.1.100     â”‚               â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹æ€§ï¼š**
- æ¯å€‹å®¹å™¨éƒ½æœ‰è‡ªå·±çš„è™›æ“¬ç¶²è·¯ä»‹é¢
- å®¹å™¨å¯é€é IP äº’ç›¸é€šè¨Š
- éœ€è¦ port mapping æ‰èƒ½å¾ä¸»æ©Ÿå¤–éƒ¨è¨ªå•

**å»ºç«‹èˆ‡ä½¿ç”¨ï¼š**

```bash
# å»ºç«‹è‡ªè¨‚ bridge ç¶²è·¯ï¼ˆæ¨è–¦ï¼‰
docker network create my-bridge-network

# æŸ¥çœ‹ç¶²è·¯è©³æƒ…
docker network inspect my-bridge-network

# è¼¸å‡ºï¼ˆéƒ¨åˆ†ï¼‰ï¼š
# "IPAM": {
#     "Config": [
#         {
#             "Subnet": "172.18.0.0/16",  # è‡ªå‹•åˆ†é…çš„å­ç¶²è·¯
#             "Gateway": "172.18.0.1"
#         }
#     ]
# }

# å•Ÿå‹•å®¹å™¨ä¸¦é€£æ¥åˆ°ç¶²è·¯
docker run -d --name web1 \
  --network my-bridge-network \
  nginx

docker run -d --name web2 \
  --network my-bridge-network \
  nginx

# å®¹å™¨ä¹‹é–“å¯é€éåç¨±é€šè¨Šï¼ˆå…§å»º DNSï¼‰
docker exec web1 ping web2 -c 2
# PING web2 (172.18.0.3): 56 data bytes
# 64 bytes from 172.18.0.3: icmp_seq=0 ttl=64 time=0.123 ms
```

**é è¨­ bridge vs è‡ªè¨‚ bridge çš„å·®ç•°ï¼š**

| ç‰¹æ€§ | é è¨­ bridge (docker0) | è‡ªè¨‚ bridge |
|------|---------------------|------------|
| DNS è§£æ | âŒ ä¸æ”¯æ´å®¹å™¨åç¨±è§£æ | âœ… æ”¯æ´å®¹å™¨åç¨±è§£æ |
| éš”é›¢æ€§ | ğŸŸ¡ æ‰€æœ‰å®¹å™¨éƒ½åœ¨åŒä¸€å€‹ç¶²è·¯ | âœ… å¯å»ºç«‹å¤šå€‹ç¨ç«‹ç¶²è·¯ |
| è¨­å®šå½ˆæ€§ | âŒ ç„¡æ³•è‡ªè¨‚ | âœ… å¯è‡ªè¨‚å­ç¶²è·¯ã€gateway |
| æ¨è–¦ä½¿ç”¨ | åƒ…é™æ¸¬è©¦ | ç”Ÿç”¢ç’°å¢ƒæ¨è–¦ |

**ç¯„ä¾‹ï¼šé è¨­ bridge çš„å•é¡Œ**

```bash
# ä½¿ç”¨é è¨­ bridge
docker run -d --name app1 nginx
docker run -d --name app2 nginx

# ç„¡æ³•é€éåç¨± pingï¼ˆå¿…é ˆä½¿ç”¨ IPï¼‰
docker exec app1 ping app2
# ping: bad address 'app2'  â† å¤±æ•—ï¼

# åªèƒ½ç”¨ IP
docker inspect app2 --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}'
# 172.17.0.3

docker exec app1 ping 172.17.0.3  # æˆåŠŸ
```

**é©ç”¨å ´æ™¯ï¼š**
- âœ… å¤§å¤šæ•¸å–®æ©Ÿæ‡‰ç”¨
- âœ… éœ€è¦å®¹å™¨é–“é€šè¨Šçš„é–‹ç™¼ç’°å¢ƒ
- âœ… å¾®æœå‹™æ¶æ§‹ï¼ˆå–®æ©Ÿç‰ˆï¼‰
- âŒ éœ€è¦é«˜æ•ˆèƒ½çš„å ´æ™¯ï¼ˆæœ‰ NAT æ•ˆèƒ½æè€—ï¼‰

---

### 2. Host Networkï¼ˆä¸»æ©Ÿç¶²è·¯ï¼‰

**é‹ä½œåŸç†ï¼š**

å®¹å™¨**ç›´æ¥ä½¿ç”¨ä¸»æ©Ÿçš„ç¶²è·¯å †ç–Š**ï¼Œä¸å»ºç«‹ç¨ç«‹çš„ç¶²è·¯å‘½åç©ºé–“ã€‚

```
Host Machine (IP: 192.168.1.100)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Container (ä½¿ç”¨ä¸»æ©Ÿç¶²è·¯)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ‡‰ç”¨ç›£è½ 80 port               â”‚  â”‚
â”‚  â”‚ = ä¸»æ©Ÿçš„ 80 port               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚
â”‚  eth0: 192.168.1.100                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½¿ç”¨æ–¹å¼ï¼š**

```bash
# å•Ÿå‹•ä½¿ç”¨ host ç¶²è·¯çš„å®¹å™¨
docker run -d --name nginx-host \
  --network host \
  nginx

# ä¸éœ€è¦ -p åƒæ•¸ï¼Œå®¹å™¨ç›´æ¥ç›£è½ä¸»æ©Ÿçš„ port
# è¨ªå•æ–¹å¼ï¼šhttp://192.168.1.100:80ï¼ˆä¸»æ©Ÿ IPï¼‰
```

**é©—è­‰ï¼š**

```bash
# æŸ¥çœ‹å®¹å™¨å…§çš„ç¶²è·¯ä»‹é¢
docker exec nginx-host ip addr

# è¼¸å‡ºæœƒé¡¯ç¤ºä¸»æ©Ÿçš„æ‰€æœ‰ç¶²è·¯ä»‹é¢ï¼š
# 1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536
# 2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500
#     inet 192.168.1.100/24  â† ä¸»æ©Ÿçš„ IP

# åœ¨å®¹å™¨å…§æŸ¥çœ‹ç›£è½çš„ port
docker exec nginx-host netstat -tuln | grep 80
# tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN
```

**ç‰¹æ€§èˆ‡limitationsï¼š**

**å„ªé»ï¼š**
- âœ… ç¶²è·¯æ•ˆèƒ½æœ€ä½³ï¼ˆç„¡ NAT è½‰æ›ï¼‰
- âœ… å®¹å™¨å¯ç›´æ¥ç¶å®šä¸»æ©Ÿçš„ä»»ä½•ç¶²è·¯ä»‹é¢

**ç¼ºé»ï¼š**
- âŒ Port è¡çªå•é¡Œï¼ˆå¤šå€‹å®¹å™¨ä¸èƒ½ä½¿ç”¨ç›¸åŒ portï¼‰
- âŒ å®‰å…¨æ€§è¼ƒä½ï¼ˆå®¹å™¨å¯å­˜å–ä¸»æ©Ÿç¶²è·¯ï¼‰
- âŒ å¯æ”œæ€§å·®ï¼ˆç¶å®šä¸»æ©Ÿç¶²è·¯è¨­å®šï¼‰

**é©ç”¨å ´æ™¯ï¼š**
- âœ… éœ€è¦æ¥µé«˜ç¶²è·¯æ•ˆèƒ½çš„æ‡‰ç”¨ï¼ˆå¦‚é«˜é »äº¤æ˜“ç³»çµ±ï¼‰
- âœ… ç¶²è·¯ç›£æ§å·¥å…·ï¼ˆéœ€è¦æ•ç²ä¸»æ©Ÿæµé‡ï¼‰
- âœ… éœ€è¦ç¶å®šç‰¹å®šç¶²è·¯ä»‹é¢çš„æ‡‰ç”¨
- âŒ ä¸€èˆ¬ Web æ‡‰ç”¨ï¼ˆç”¨ bridge å³å¯ï¼‰

**å¯¦éš›ç¯„ä¾‹ï¼šç›£æ§å·¥å…·**

```bash
# Prometheus Node Exporterï¼ˆéœ€è¦è®€å–ä¸»æ©ŸæŒ‡æ¨™ï¼‰
docker run -d \
  --name node-exporter \
  --network host \
  --pid host \
  -v "/:/host:ro,rslave" \
  prom/node-exporter:latest \
  --path.rootfs=/host

# è¨ªå•ï¼šhttp://ä¸»æ©ŸIP:9100/metrics
```

---

### 3. None Networkï¼ˆç„¡ç¶²è·¯ï¼‰

**é‹ä½œåŸç†ï¼š**

å®¹å™¨**å®Œå…¨æ²’æœ‰ç¶²è·¯é€£æ¥**ï¼Œåªæœ‰ loopback ä»‹é¢ã€‚

```
Container
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  127.0.0.1 (lo)  â”‚
â”‚                  â”‚
â”‚  ç„¡å°å¤–ç¶²è·¯       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½¿ç”¨æ–¹å¼ï¼š**

```bash
# å•Ÿå‹•ç„¡ç¶²è·¯å®¹å™¨
docker run -d --name isolated \
  --network none \
  alpine sleep 3600

# æŸ¥çœ‹ç¶²è·¯ä»‹é¢
docker exec isolated ip addr

# è¼¸å‡ºï¼šåªæœ‰ loopback
# 1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536
#     inet 127.0.0.1/8 scope host lo
```

**é©—è­‰ç„¡æ³•å°å¤–é€£ç·šï¼š**

```bash
docker exec isolated ping google.com
# ping: bad address 'google.com'

docker exec isolated wget https://google.com
# wget: bad address 'google.com'
```

**é©ç”¨å ´æ™¯ï¼š**
- âœ… å®‰å…¨æ€§è¦æ±‚æ¥µé«˜çš„å®¹å™¨ï¼ˆå¦‚å¯†ç¢¼è™•ç†ã€åŠ å¯†é‹ç®—ï¼‰
- âœ… æ‰¹æ¬¡è™•ç†ä»»å‹™ï¼ˆä¸éœ€è¦ç¶²è·¯ï¼‰
- âœ… æ¸¬è©¦éš”é›¢ç’°å¢ƒ
- âœ… è‡ªè¨‚ç¶²è·¯é…ç½®çš„åŸºç¤ï¼ˆæ‰‹å‹•åŠ å…¥ç¶²è·¯ï¼‰

**å¯¦éš›ç¯„ä¾‹ï¼šå®‰å…¨çš„å¯†ç¢¼ç”Ÿæˆå®¹å™¨**

```bash
# å»ºç«‹å®Œå…¨éš”é›¢çš„å®¹å™¨
docker run -it --rm \
  --network none \
  --read-only \
  alpine sh

# åœ¨å®¹å™¨å…§
/ # openssl rand -base64 32  # ç”Ÿæˆå¯†ç¢¼
# ç„¡æ³•å°‡è³‡æ–™å‚³é€åˆ°å¤–éƒ¨ç¶²è·¯
```

---

### 4. Overlay Networkï¼ˆè·¨ä¸»æ©Ÿç¶²è·¯ï¼‰

**é‹ä½œåŸç†ï¼š**

ç”¨æ–¼ **Docker Swarm** æˆ–å¤šä¸»æ©Ÿç’°å¢ƒï¼Œè®“ä¸åŒä¸»æ©Ÿä¸Šçš„å®¹å™¨å¯ä»¥äº’ç›¸é€šè¨Šã€‚

```
Host 1 (192.168.1.10)          Host 2 (192.168.1.20)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Container A     â”‚          â”‚  Container B     â”‚
â”‚  10.0.0.2        â”‚          â”‚  10.0.0.3        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                             â”‚
         â”‚  VXLAN Tunnel (overlay)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
              Overlay Network (10.0.0.0/24)
```

**å»ºç«‹èˆ‡ä½¿ç”¨ï¼š**

```bash
# éœ€è¦å…ˆåˆå§‹åŒ– Swarmï¼ˆå³ä½¿å–®æ©Ÿä¹Ÿå¯ä»¥ï¼‰
docker swarm init

# å»ºç«‹ overlay ç¶²è·¯
docker network create -d overlay my-overlay

# å»ºç«‹æœå‹™ï¼ˆè‡ªå‹•ä½¿ç”¨ overlay ç¶²è·¯ï¼‰
docker service create \
  --name web \
  --network my-overlay \
  --replicas 3 \
  nginx
```

**é©ç”¨å ´æ™¯ï¼š**
- âœ… Docker Swarm å¢é›†
- âœ… è·¨ä¸»æ©Ÿå®¹å™¨é€šè¨Š
- âœ… å¾®æœå‹™æ¶æ§‹ï¼ˆå¤šæ©Ÿéƒ¨ç½²ï¼‰

---

### 5. Macvlan Networkï¼ˆç›´æ¥ç¶å®šå¯¦é«”ç¶²è·¯ï¼‰

**é‹ä½œåŸç†ï¼š**

è®“å®¹å™¨**æ“æœ‰å¯¦é«”ç¶²è·¯çš„ MAC ä½å€**ï¼Œç›´æ¥å‡ºç¾åœ¨å€åŸŸç¶²è·¯ä¸­ã€‚

```
Physical Network (192.168.1.0/24)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                        â”‚
â”‚  Router: 192.168.1.1                   â”‚
â”‚                                        â”‚
â”‚  Container A: 192.168.1.10 (MAC: aaa)  â”‚
â”‚  Container B: 192.168.1.11 (MAC: bbb)  â”‚
â”‚  Host:        192.168.1.100            â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å»ºç«‹èˆ‡ä½¿ç”¨ï¼š**

```bash
# å»ºç«‹ macvlan ç¶²è·¯
docker network create -d macvlan \
  --subnet=192.168.1.0/24 \
  --gateway=192.168.1.1 \
  -o parent=eth0 \  # ä¸»æ©Ÿçš„å¯¦é«”ç¶²å¡
  my-macvlan

# å•Ÿå‹•å®¹å™¨ä¸¦æŒ‡å®š IP
docker run -d \
  --name web \
  --network my-macvlan \
  --ip 192.168.1.10 \
  nginx

# å¯å¾å€åŸŸç¶²è·¯çš„å…¶ä»–è¨­å‚™ç›´æ¥è¨ªå•
# http://192.168.1.10
```

**é©ç”¨å ´æ™¯ï¼š**
- âœ… éœ€è¦å®¹å™¨ç›´æ¥å‡ºç¾åœ¨å¯¦é«”ç¶²è·¯ä¸­
- âœ… ç¶²è·¯è¨­å‚™ç›£æ§ï¼ˆéœ€è¦æ¥æ”¶å»£æ’­å°åŒ…ï¼‰
- âœ… Legacy æ‡‰ç”¨é·ç§»ï¼ˆéœ€è¦å›ºå®š IPï¼‰

---

### ç¶²è·¯é©…å‹•é¸æ“‡æ±ºç­–æ¨¹

```
éœ€è¦å¤šä¸»æ©Ÿé€šè¨Šï¼Ÿ
â”œâ”€ æ˜¯ â†’ Overlay Network
â””â”€ å¦  â†“

éœ€è¦æ¥µè‡´ç¶²è·¯æ•ˆèƒ½ï¼Ÿ
â”œâ”€ æ˜¯ â†’ Host Network
â””â”€ å¦  â†“

éœ€è¦å®Œå…¨éš”é›¢ï¼Ÿ
â”œâ”€ æ˜¯ â†’ None Network
â””â”€ å¦  â†“

éœ€è¦å®¹å™¨æœ‰å¯¦é«”ç¶²è·¯ IPï¼Ÿ
â”œâ”€ æ˜¯ â†’ Macvlan Network
â””â”€ å¦ â†’ Bridge Networkï¼ˆé è¨­é¸æ“‡ï¼‰
```

---

## 4.2. æœå‹™ç™¼ç¾ (Service Discovery) åŸç†ï¼šDocker å…§å»º DNS å¦‚ä½•é‹ä½œ

### Docker å…§å»º DNS ä¼ºæœå™¨

Docker ç‚ºæ¯å€‹**è‡ªè¨‚ç¶²è·¯**æä¾›å…§å»ºçš„ DNS ä¼ºæœå™¨ (IP: `127.0.0.11`)ï¼Œè®“å®¹å™¨å¯ä»¥é€é**åç¨±**äº’ç›¸æºé€šã€‚

```
Custom Bridge Network
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                        â”‚
â”‚  Container: web                        â”‚
â”‚  IP: 172.18.0.2                        â”‚
â”‚  DNS: 127.0.0.11 (Docker DNS)          â”‚
â”‚                                        â”‚
â”‚          â†“ ping db                     â”‚
â”‚          â†“                             â”‚
â”‚  Container: db                         â”‚
â”‚  IP: 172.18.0.3                        â”‚
â”‚  DNS: 127.0.0.11 (Docker DNS)          â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### DNS è§£ææµç¨‹

**ç¯„ä¾‹å ´æ™¯ï¼š** Container `web` è¦é€£æ¥ Container `db`

```bash
# 1. å»ºç«‹ç¶²è·¯å’Œå®¹å™¨
docker network create app-network

docker run -d --name db \
  --network app-network \
  postgres:15

docker run -d --name web \
  --network app-network \
  -e DATABASE_URL=postgresql://user:pass@db:5432/mydb \
  myapp
```

**DNS è§£ææ­¥é©Ÿï¼š**

```
1. æ‡‰ç”¨ç¨‹å¼è¦é€£æ¥ "db"
   â†“
2. æŸ¥è©¢å®¹å™¨å…§çš„ /etc/resolv.conf
   nameserver 127.0.0.11  â† Docker DNS
   â†“
3. Docker DNS æŸ¥è©¢ db çš„ IP
   â†“
4. å›å‚³: db = 172.18.0.2
   â†“
5. å»ºç«‹é€£ç·šåˆ° 172.18.0.2:5432
```

**é©—è­‰ DNS è¨­å®šï¼š**

```bash
# æŸ¥çœ‹å®¹å™¨å…§çš„ DNS è¨­å®š
docker exec web cat /etc/resolv.conf

# è¼¸å‡ºï¼š
# nameserver 127.0.0.11  â† Docker å…§å»º DNS
# options ndots:0

# æ‰‹å‹•è§£æå®¹å™¨åç¨±
docker exec web nslookup db

# è¼¸å‡ºï¼š
# Server:    127.0.0.11
# Address:   127.0.0.11:53
#
# Non-authoritative answer:
# Name:   db
# Address: 172.18.0.2

# æˆ–ä½¿ç”¨ dig
docker exec web dig db +short
# 172.18.0.2
```

### æœå‹™ç™¼ç¾çš„é€²éšåŠŸèƒ½

**1. ç¶²è·¯åˆ¥å (Network Alias)**

ä¸€å€‹å®¹å™¨å¯ä»¥æœ‰å¤šå€‹ DNS åç¨±ï¼š

```bash
# å•Ÿå‹•å®¹å™¨æ™‚æŒ‡å®šåˆ¥å
docker run -d --name db \
  --network app-network \
  --network-alias database \
  --network-alias postgres-server \
  postgres:15

# ç¾åœ¨å¯ä»¥ç”¨ä»»ä½•åç¨±å­˜å–
docker exec web ping db           # âœ…
docker exec web ping database      # âœ…
docker exec web ping postgres-server  # âœ…
```

**Docker Compose ç¯„ä¾‹ï¼š**

```yaml
version: '3.8'
services:
  db:
    image: postgres:15
    networks:
      app-network:
        aliases:
          - database
          - postgres-server
  
  web:
    image: myapp
    environment:
      DB_HOST: database  # ä½¿ç”¨åˆ¥å
    networks:
      - app-network

networks:
  app-network:
```

**2. è² è¼‰å¹³è¡¡ (Load Balancing)**

å¤šå€‹å®¹å™¨ä½¿ç”¨ç›¸åŒåç¨±æ™‚ï¼ŒDocker æœƒé€²è¡Œ Round-Robin è² è¼‰å¹³è¡¡ï¼š

```bash
# å»ºç«‹ 3 å€‹ä½¿ç”¨ç›¸åŒåˆ¥åçš„å®¹å™¨
docker run -d --name api1 \
  --network app-network \
  --network-alias api \
  myapi

docker run -d --name api2 \
  --network app-network \
  --network-alias api \
  myapi

docker run -d --name api3 \
  --network app-network \
  --network-alias api \
  myapi

# å¾ web å®¹å™¨æŸ¥è©¢ api
docker exec web nslookup api

# è¼¸å‡ºï¼ˆRound-Robin è¼ªæ›¿ï¼‰ï¼š
# Name:   api
# Address: 172.18.0.2  â† api1
# Address: 172.18.0.3  â† api2
# Address: 172.18.0.4  â† api3
```

**æ¸¬è©¦è² è¼‰å¹³è¡¡ï¼š**

```bash
# é€£çºŒ ping æœƒè¼ªæ›¿åˆ°ä¸åŒå®¹å™¨
for i in {1..6}; do
  docker exec web curl -s http://api/hostname
done

# è¼¸å‡ºï¼š
# api1
# api2
# api3
# api1
# api2
# api3
```

**3. Docker Compose æœå‹™ç™¼ç¾**

Docker Compose è‡ªå‹•ç‚ºæ¯å€‹æœå‹™å»ºç«‹ DNS è¨˜éŒ„ï¼š

```yaml
version: '3.8'
services:
  web:
    image: nginx
    depends_on:
      - api
  
  api:
    image: node:18
    command: node server.js
    environment:
      DB_HOST: db  # ä½¿ç”¨æœå‹™åç¨±
  
  db:
    image: postgres:15
```

```bash
# å•Ÿå‹•å¾Œï¼Œæœå‹™åç¨±å³ç‚º DNS åç¨±
docker-compose up -d

# web å¯ä»¥ ping api
docker-compose exec web ping api  âœ…

# api å¯ä»¥ping db
docker-compose exec api ping db   # âœ…
```

### DNS å¿«å–èˆ‡ TTL

Docker DNS æœƒå¿«å–è§£æçµæœï¼Œé è¨­ TTL = 0ï¼ˆä¸å¿«å–ï¼‰ï¼š

```bash
# æŸ¥çœ‹ç•¶å‰çš„ DNS è§£æ
docker exec web nslookup db
# Address: 172.18.0.2

# é‡æ–°å•Ÿå‹• db å®¹å™¨ï¼ˆIP å¯èƒ½æ”¹è®Šï¼‰
docker restart db

# ç­‰å¾…å¹¾ç§’å¾Œï¼Œæ–°çš„è§£ææœƒè‡ªå‹•æ›´æ–°
docker exec web nslookup db
# Address: 172.18.0.5  â† æ–° IP
```

---

## 4.3. å®¹å™¨ IP çš„å‹•æ…‹æ€§ï¼šç‚ºä»€éº¼ä¸æ‡‰è©²åœ¨ç¨‹å¼ç¢¼ä¸­å¯«æ­» IP Addressï¼Ÿ

### å®¹å™¨ IP çš„ä¸ç©©å®šæ€§

**å•é¡Œå ´æ™¯ï¼š**

```bash
# Day 1: å•Ÿå‹•å®¹å™¨
docker run -d --name api myapi
docker inspect api --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}'
# 172.17.0.2

# åœ¨ç¨‹å¼ç¢¼ä¸­å¯«æ­» IP
# config.js
const DB_HOST = '172.17.0.2';  // âŒ éŒ¯èª¤åšæ³•
```

```bash
# Day 2: é‡å•Ÿå®¹å™¨
docker restart api

# IP æ”¹è®Šäº†ï¼
docker inspect api --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}'
# 172.17.0.5  â† ä¸åŒçš„ IP

# ç¨‹å¼å´©æ½°ï¼
# Error: connect ECONNREFUSED 172.17.0.2:5432
```

### IP æ”¹è®Šçš„å¸¸è¦‹åŸå› 

1. **å®¹å™¨é‡å•Ÿ**
   ```bash
   docker restart api  # IP å¯èƒ½æ”¹è®Š
   ```

2. **å®¹å™¨é‡æ–°å»ºç«‹**
   ```bash
   docker stop api
   docker rm api
   docker run -d --name api myapi  # æ–° IP
   ```

3. **ç¶²è·¯é‡å»º**
   ```bash
   docker-compose down
   docker-compose up -d  # æ‰€æœ‰å®¹å™¨éƒ½æ˜¯æ–° IP
   ```

4. **Docker Daemon é‡å•Ÿ**
   ```bash
   sudo systemctl restart docker  # æ•´å€‹ç¶²è·¯é‡å»º
   ```

### æ­£ç¢ºåšæ³•ï¼šä½¿ç”¨æœå‹™åç¨±

**âœ… æ–¹æ³• 1ï¼šä½¿ç”¨å®¹å™¨åç¨±**

```bash
# å»ºç«‹ç¶²è·¯
docker network create app-net

# å•Ÿå‹•è³‡æ–™åº«
docker run -d --name db \
  --network app-net \
  postgres:15

# å•Ÿå‹• APIï¼ˆä½¿ç”¨åç¨±è€Œé IPï¼‰
docker run -d --name api \
  --network app-net \
  -e DB_HOST=db \  # âœ… ä½¿ç”¨åç¨±
  myapi
```

**æ‡‰ç”¨ç¨‹å¼ç¢¼ï¼š**

```javascript
// âœ… æ­£ç¢ºï¼šå¾ç’°å¢ƒè®Šæ•¸è®€å–
const dbHost = process.env.DB_HOST || 'db';
const dbConfig = {
  host: dbHost,  // 'db' æœƒé€é Docker DNS è§£æ
  port: 5432,
  database: 'myapp'
};

// âŒ éŒ¯èª¤ï¼šå¯«æ­» IP
const dbConfig = {
  host: '172.17.0.2',  // å®¹å™¨é‡å•Ÿå°±å¤±æ•ˆ
  port: 5432
};
```

**âœ… æ–¹æ³• 2ï¼šDocker Compose**

```yaml
version: '3.8'

services:
  api:
    build: ./api
    environment:
      DB_HOST: db  # âœ… ä½¿ç”¨æœå‹™åç¨±
      DB_PORT: 5432
      REDIS_URL: redis://cache:6379  # âœ…
    depends_on:
      - db
      - cache
  
  db:
    image: postgres:15
  
  cache:
    image: redis:7
```

### ç‰¹æ®Šæƒ…æ³ï¼šå›ºå®šå®¹å™¨ IP

æŸäº›æƒ…æ³ä¸‹ç¢ºå¯¦éœ€è¦å›ºå®š IPï¼ˆä¾‹å¦‚ license ç¶å®š IPï¼‰ï¼š

```bash
# å»ºç«‹è‡ªè¨‚å­ç¶²è·¯
docker network create \
  --subnet=172.20.0.0/16 \
  --gateway=172.20.0.1 \
  fixed-ip-network

# å•Ÿå‹•å®¹å™¨ä¸¦æŒ‡å®šå›ºå®š IP
docker run -d \
  --name api \
  --network fixed-ip-network \
  --ip 172.20.0.10 \  # å›ºå®š IP
  myapi
```

**Docker Compose å›ºå®š IPï¼š**

```yaml
version: '3.8'

services:
  api:
    image: myapi
    networks:
      app-network:
        ipv4_address: 172.20.0.10  # å›ºå®š IP

networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
```

> âš ï¸ **æ³¨æ„**ï¼šå³ä½¿ä½¿ç”¨å›ºå®š IPï¼Œä¹Ÿå»ºè­°åœ¨ç¨‹å¼ç¢¼ä¸­ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ï¼Œè€Œä¸è¦ç›´æ¥å¯«æ­»ã€‚

### æœ€ä½³å¯¦è¸ç¸½çµ

| åšæ³• | è©•åƒ¹ | ä½¿ç”¨æ™‚æ©Ÿ |
|------|------|---------|
| å¯«æ­»å®¹å™¨ IP | âŒ çµ•å°ç¦æ­¢ | å¾ä¸ |
| ä½¿ç”¨å®¹å™¨åç¨±/æœå‹™åç¨± | âœ… æ¨è–¦ | 99% çš„æƒ…æ³ |
| å›ºå®š IP + ç’°å¢ƒè®Šæ•¸ | ğŸŸ¡ å¯æ¥å— | License ç¶å®šã€ç‰¹æ®Šéœ€æ±‚ |
| ä½¿ç”¨ç¶²è·¯åˆ¥å | âœ… æ¨è–¦ | å¤šå®¹å™¨è² è¼‰å¹³è¡¡ |

**ç’°å¢ƒè®Šæ•¸è¨­å®šç¯„æœ¬ï¼š**

```bash
# .env
DB_HOST=db
DB_PORT=5432
REDIS_HOST=cache
REDIS_PORT=6379
API_HOST=api
API_PORT=4000
```

```yaml
# docker-compose.yml
services:
  web:
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      REDIS_HOST: ${REDIS_HOST}
      API_URL: http://${API_HOST}:${API_PORT}
```

é€™æ¨£å¯ä»¥ç¢ºä¿æœå‹™åœ¨ä»»ä½•ç’°å¢ƒä¸‹éƒ½èƒ½æ­£ç¢ºé€£æ¥ï¼
