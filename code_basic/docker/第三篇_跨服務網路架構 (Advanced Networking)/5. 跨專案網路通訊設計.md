#5. è·¨å°ˆæ¡ˆç¶²è·¯é€šè¨Šè¨­è¨ˆ

## 5.1. å¤–éƒ¨ç¶²è·¯ (External Networks) çš„å»ºç«‹èˆ‡ç®¡ç† (docker network create)

### ä»€éº¼æ˜¯å¤–éƒ¨ç¶²è·¯ï¼Ÿ

å¤–éƒ¨ç¶²è·¯ (External Network) æ˜¯æŒ‡**åœ¨ Docker Compose å°ˆæ¡ˆå¤–éƒ¨å»ºç«‹**çš„ç¶²è·¯ï¼Œå¯ä»¥è¢«å¤šå€‹ç¨ç«‹çš„ Compose å°ˆæ¡ˆå…±äº«ä½¿ç”¨ã€‚

**ä½¿ç”¨å ´æ™¯ï¼š**
- Project A (Web App) éœ€è¦é€£æ¥ Project B (Database)
- å¤šå€‹å¾®æœå‹™å°ˆæ¡ˆéœ€è¦äº’ç›¸é€šè¨Š
- Tra

efik åå‘ä»£ç†éœ€è¦è·¯ç”±åˆ°å¤šå€‹æ‡‰ç”¨

### æ¶æ§‹åœ–è§£

**å‚³çµ±åšæ³•ï¼ˆç„¡æ³•è·¨å°ˆæ¡ˆé€šè¨Šï¼‰ï¼š**

```
Project A                Project B
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  web         â”‚        â”‚  api         â”‚
â”‚  db          â”‚        â”‚  cache       â”‚
â”‚              â”‚        â”‚              â”‚
â”‚  network_a   â”‚        â”‚  network_b   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘                       â†‘
     ç„¡æ³•äº’ç›¸é€šè¨Š
```

**ä½¿ç”¨å¤–éƒ¨ç¶²è·¯ï¼ˆå¯è·¨å°ˆæ¡ˆé€šè¨Šï¼‰ï¼š**

```
         shared-network (å¤–éƒ¨ç¶²è·¯)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                               â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Project A  â”‚              â”‚ Project B  â”‚
â”‚  web â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  api       â”‚
â”‚  db        â”‚              â”‚  cache     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### å»ºç«‹å¤–éƒ¨ç¶²è·¯

**æ­¥é©Ÿ 1ï¼šå»ºç«‹å…±äº«ç¶²è·¯**

```bash
# å»ºç«‹ä¸€å€‹å…±äº«ç¶²è·¯
docker network create shared-network

# æŸ¥çœ‹ç¶²è·¯
docker network ls | grep shared
# abc123...  shared-network  bridge    local

# æŸ¥çœ‹è©³ç´°è³‡è¨Š
docker network inspect shared-network

# è¼¸å‡ºï¼ˆéƒ¨åˆ†ï¼‰ï¼š
# "Name": "shared-network",
# "Driver": "bridge",
# "IPAM": {
#     "Config": [
#         {
#             "Subnet": "172.18.0.0/16",
#             "Gateway": "172.18.0.1"
#         }
#     ]
# }
```

**æ­¥é©Ÿ 2ï¼šå»ºç«‹é€²éšè¨­å®šçš„ç¶²è·¯**

```bash
# è‡ªè¨‚å­ç¶²è·¯å’Œ Gateway
docker network create \
  --driver bridge \
  --subnet=172.20.0.0/16 \
  --gateway=172.20.0.1 \
  --opt com.docker.network.bridge.name=br-shared \
  shared-network

# è¨­å®š IP ç¯„åœ
docker network create \
  --subnet=172.20.0.0/16 \
  --ip-range=172.20.5.0/24 \  # é™åˆ¶å®¹å™¨ä½¿ç”¨çš„ IP ç¯„åœ
  --gateway=172.20.0.1 \
  shared-network

# è¨­å®š DNS
docker network create \
  --subnet=172.20.0.0/16 \
  --dns=8.8.8.8 \
  --dns=8.8.4.4 \
  shared-network
```

**æ­¥é©Ÿ 3ï¼šåœ¨ Docker Compose ä¸­å®£å‘Šä½¿ç”¨å¤–éƒ¨ç¶²è·¯**

**Project A - docker-compose.ymlï¼š**
```yaml
version: '3.8'

services:
  web:
    image: nginx
    container_name: project-a-web
    networks:
      - shared-network  # ä½¿ç”¨å¤–éƒ¨ç¶²è·¯
      - internal        # å…§éƒ¨ç¶²è·¯

  db:
    image: postgres:15
    container_name: project-a-db
    networks:
      - internal  # åªåœ¨å…§éƒ¨ç¶²è·¯

networks:
  # å®£å‘Šé€™æ˜¯å¤–éƒ¨ç¶²è·¯
  shared-network:
    external: true  # â† é—œéµè¨­å®š
  
  # å…§éƒ¨ç¶²è·¯ï¼ˆå°ˆæ¡ˆç§æœ‰ï¼‰
  internal:
    driver: bridge
```

**Project B - docker-compose.ymlï¼š**
```yaml
version: '3.8'

services:
  api:
    image: node:18
    container_name: project-b-api
    networks:
      - shared-network  # ä½¿ç”¨ç›¸åŒçš„å¤–éƒ¨ç¶²è·¯
      - backend

  cache:
    image: redis:7
    container_name: project-b-cache
    networks:
      - backend

networks:
  shared-network:
    external: true  # â† ä½¿ç”¨å¤–éƒ¨ç¶²è·¯
  
  backend:
    driver: bridge
```

---

### é©—è­‰è·¨å°ˆæ¡ˆé€šè¨Š

```bash
# å•Ÿå‹• Project A
cd /path/to/project-a
docker-compose up -d

# å•Ÿå‹• Project B
cd /path/to/project-b
docker-compose up -d

# å¾ Project A çš„ web å®¹å™¨ ping Project B çš„ api å®¹å™¨
docker exec project-a-web ping project-b-api -c 2
# PING project-b-api (172.20.0.3) 56(84) bytes of data.
# 64 bytes from project-b-api.shared-network (172.20.0.3): icmp_seq=1 ttl=64 time=0.123 ms
# âœ… æˆåŠŸé€šè¨Šï¼

# å¾ Project B çš„ api ç™¼é€ HTTP è«‹æ±‚åˆ° Project A çš„ web
docker exec project-b-api curl http://project-a-web
# âœ… æˆåŠŸï¼
```

---

### ç¶²è·¯ç®¡ç†æŒ‡ä»¤

```bash
# åˆ—å‡ºæ‰€æœ‰ç¶²è·¯
docker network ls

# æŸ¥çœ‹ç¶²è·¯è©³æƒ…ï¼ˆåŒ…å«é€£æ¥çš„å®¹å™¨ï¼‰
docker network inspect shared-network

# è¼¸å‡ºï¼ˆéƒ¨åˆ†ï¼‰ï¼š
# "Containers": {
#     "abc123...": {
#         "Name": "project-a-web",
#         "IPv4Address": "172.20.0.2/16"
#     },
#     "def456...": {
#         "Name": "project-b-api",
#         "IPv4Address": "172.20.0.3/16"
#     }
# }

# æ‰‹å‹•é€£æ¥å®¹å™¨åˆ°ç¶²è·¯
docker network connect shared-network <container_name>

# æ‰‹å‹•æ–·é–‹é€£æ¥
docker network disconnect shared-network <container_name>

# åˆªé™¤ç¶²è·¯ï¼ˆéœ€å…ˆåœæ­¢æ‰€æœ‰ä½¿ç”¨è©²ç¶²è·¯çš„å®¹å™¨ï¼‰
docker network rm shared-network

# æ¸…ç†æœªä½¿ç”¨çš„ç¶²è·¯
docker network prune
```

---

## 5.2. è·¨ Stack é€šè¨Šå¯¦ä½œ

### 5.2.1. è®“ Project A (Web App) é€£æ¥ Project B (Database) çš„ç¶²è·¯è¨­å®š

### å¯¦æˆ°å ´æ™¯ï¼šåˆ†é›¢è³‡æ–™åº«èˆ‡æ‡‰ç”¨

**æ¶æ§‹è¨­è¨ˆï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Project A      â”‚       â”‚  Project B      â”‚
â”‚  (Application)  â”‚       â”‚  (Database)     â”‚
â”‚                 â”‚       â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Web     â”‚  â”‚       â”‚  â”‚ PostgreSQLâ”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚       â”‚  â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€ â”˜  â”‚
â”‚        â”‚        â”‚       â”‚        â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”‚       â”‚        â”‚        â”‚
â”‚  â”‚    API    â”œâ”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚                 â”‚
â”‚                 â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  app-networkâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”‚ db-networkâ”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚
          â””â”€â”€â”€â”€â”€ shared-network â”€â”€â”˜
```

**å¯¦ä½œæ­¥é©Ÿï¼š**

**æ­¥é©Ÿ 1ï¼šå»ºç«‹å…±äº«ç¶²è·¯**

```bash
# å»ºç«‹è³‡æ–™åº«å°ˆç”¨çš„å…±äº«ç¶²è·¯
docker network create db-network
```

**æ­¥é©Ÿ 2ï¼šProject B (Database) è¨­å®š**

```yaml
# project-b/docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:15
    container_name: shared-postgres
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - db-network  # åªé€£æ¥åˆ°å…±äº«ç¶²è·¯
    # ğŸ”’ ä¸æš´éœ² port åˆ°ä¸»æ©Ÿï¼ˆå®‰å…¨ï¼‰
    # ports:
    #   - "5432:5432"  # â† ä¸éœ€è¦é€™è¡Œ

networks:
  db-network:
    external: true

volumes:
  postgres_data:
```

```bash
# .env
DB_USER=app_user
DB_PASSWORD=secure_password_123
DB_NAME=myapp_db
```

**æ­¥é©Ÿ 3ï¼šProject A (Application) è¨­å®š**

```yaml
# project-a/docker-compose.yml
version: '3.8'

services:
  api:
    build: ./api
    container_name: app-api
    environment:
      # ä½¿ç”¨å…±äº«è³‡æ–™åº«
      DB_HOST: shared-postgres  # â† Project B çš„å®¹å™¨åç¨±
      DB_PORT: 5432
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
    networks:
      - app-internal
      - db-network  # é€£æ¥åˆ°å…±äº«ç¶²è·¯
    depends_on:
      - web

  web:
    image: nginx
    container_name: app-web
    ports:
      - "80:80"
    networks:
      - app-internal

networks:
  app-internal:  # æ‡‰ç”¨å…§éƒ¨ç¶²è·¯
    driver: bridge
  
  db-network:    # å…±äº«è³‡æ–™åº«ç¶²è·¯
    external: true
```

**æ­¥é©Ÿ 4ï¼šå•Ÿå‹•èˆ‡æ¸¬è©¦**

```bash
# å…ˆå•Ÿå‹•è³‡æ–™åº«å°ˆæ¡ˆ
cd project-b
docker-compose up -d

# ç­‰å¾…è³‡æ–™åº«å•Ÿå‹•
sleep 5

# å•Ÿå‹•æ‡‰ç”¨å°ˆæ¡ˆ
cd ../project-a
docker-compose up -d

# é©—è­‰é€£ç·š
docker-compose exec api psql -h shared-postgres -U app_user -d myapp_db -c "\dt"
# âœ… æˆåŠŸé€£æ¥åˆ° Project B çš„è³‡æ–™åº«ï¼
```

---

### 5.2.2. åœ¨ YAML ä¸­å®£å‘Š networks: external: true çš„æ­£ç¢ºå¯«æ³•

### èªæ³•è©³è§£

**æ–¹æ³• 1ï¼šç°¡æ½”å¯«æ³•ï¼ˆæ¨è–¦ï¼‰**

```yaml
version: '3.8'

services:
  app:
    image: myapp
    networks:
      - shared-network

networks:
  shared-network:
    external: true  # â† å®£å‘Šç‚ºå¤–éƒ¨ç¶²è·¯
```

**æ–¹æ³• 2ï¼šæ˜ç¢ºæŒ‡å®šç¶²è·¯åç¨±**

```yaml
version: '3.8'

services:
  app:
    image: myapp
    networks:
      - my-network  # â† compose å…§éƒ¨ä½¿ç”¨çš„åç¨±

networks:
  my-network:  # â† compose å…§éƒ¨åç¨±
    name: actual-network-name  # â† Docker å¯¦éš›çš„ç¶²è·¯åç¨±
    external: true
```

**ä½¿ç”¨å ´æ™¯ï¼š**

```bash
# Docker ä¸­çš„å¯¦éš›ç¶²è·¯åç¨±
docker network create production-shared-network

# Compose æª”æ¡ˆ
```yaml
networks:
  shared:  # â† åœ¨ services ä¸­ä½¿ç”¨ "shared"
    name: production-shared-network  # â† å¯¦éš›ç¶²è·¯åç¨±
    external: true
```

**æ–¹æ³• 3ï¼šä½¿ç”¨å°ˆæ¡ˆå‰ç¶´**

```yaml
# docker-compose.yml
networks:
  shared-network:
    external: true
    name: ${PROJECT_PREFIX}_shared  # å¾ç’°å¢ƒè®Šæ•¸è®€å–
```

```bash
# .env
PROJECT_PREFIX=prod

# å¯¦éš›ç¶²è·¯åç¨±æœƒæ˜¯: prod_shared
docker network create prod_shared
```

---

### å¸¸è¦‹éŒ¯èª¤èˆ‡ä¿®æ­£

**âŒ éŒ¯èª¤ 1ï¼šexternal æ‹¼å¯«éŒ¯èª¤**

```yaml
networks:
  shared-network:
    externals: true  # â† éŒ¯èª¤ï¼æ‡‰è©²æ˜¯ external
```

**éŒ¯èª¤è¨Šæ¯ï¼š**
```
ERROR: The Compose file is invalid because:
networks.shared-network value Additional properties are not allowed ('externals' was unexpected)
```

**âœ… æ­£ç¢ºå¯«æ³•ï¼š**
```yaml
networks:
  shared-network:
    external: true  # â† æ­£ç¢º
```

---

**âŒ éŒ¯èª¤ 2ï¼šexternal èˆ‡ driver åŒæ™‚ä½¿ç”¨**

```yaml
networks:
  shared-network:
    external: true
    driver: bridge  # â† éŒ¯èª¤ï¼å¤–éƒ¨ç¶²è·¯ä¸èƒ½æŒ‡å®š driver
```

**éŒ¯èª¤è¨Šæ¯ï¼š**
```
ERROR: Service "app" uses an undefined network "shared-network"
```

**âœ… æ­£ç¢ºåšæ³•ï¼š** åªåœ¨å»ºç«‹ç¶²è·¯æ™‚æŒ‡å®š driver

```bash
# å»ºç«‹æ™‚æŒ‡å®š
docker network create --driver bridge shared-network
```

```yaml
# compose åªå®£å‘Šä½¿ç”¨
networks:
  shared-network:
    external: true
```

---

**âŒ éŒ¯èª¤ 3ï¼šç¶²è·¯ä¸å­˜åœ¨**

```yaml
networks:
  shared-network:
    external: true
```

```bash
docker-compose up
# ERROR: Network shared-network declared as external, but could not be found.
# Please create the network manually using `docker network create shared-network`
```

**âœ… è§£æ±ºæ–¹æ³•ï¼š**
```bash
# å…ˆå»ºç«‹ç¶²è·¯
docker network create shared-network

# å†å•Ÿå‹•
docker-compose up -d
```

---

**âŒ éŒ¯èª¤ 4ï¼šåç¨±ä¸ä¸€è‡´**

```bash
# å¯¦éš›å»ºç«‹çš„ç¶²è·¯
docker network create my-shared-network
```

```yaml
# Compose å®£å‘Šçš„åç¨±
networks:
  shared-network:  # â† åç¨±ä¸ä¸€è‡´
    external: true
```

```bash
docker-compose up
# ERROR: Network shared-network declared as external, but could not be found.
```

**âœ… è§£æ±ºæ–¹æ³• 1ï¼šä¿®æ­£ Compose åç¨±**
```yaml
networks:
  my-shared-network:  # â† èˆ‡å¯¦éš›åç¨±ä¸€è‡´
    external: true
```

**âœ… è§£æ±ºæ–¹æ³• 2ï¼šä½¿ç”¨ name å±¬æ€§**
```yaml
networks:
  shared:  # â† å…§éƒ¨ä½¿ç”¨çš„åç¨±
    name: my-shared-network  # â† Docker å¯¦éš›åç¨±
    external: true
```

---

## 5.3. ç¶²è·¯éš”é›¢ç­–ç•¥ï¼šç¢ºä¿è³‡æ–™åº«åªå°å…§é–‹æ”¾ï¼Œä¸å°å¤–æš´éœ² Port

### å®‰å…¨æ¶æ§‹è¨­è¨ˆ

**ä¸å®‰å…¨çš„åšæ³•ï¼ˆâŒï¼‰ï¼š**

```yaml
services:
  db:
    image: postgres:15
    ports:
      - "5432:5432"  # âŒ ç›´æ¥æš´éœ²åˆ°ä¸»æ©Ÿï¼Œä»»ä½•äººéƒ½å¯ä»¥é€£æ¥ï¼
    environment:
      POSTGRES_PASSWORD: weak123
```

```bash
# ä»»ä½•äººéƒ½å¯ä»¥å¾ä¸»æ©Ÿé€£æ¥
psql -h localhost -U postgres
# âš ï¸ å®‰å…¨é¢¨éšªï¼
```

---

**å®‰å…¨çš„åšæ³•ï¼ˆâœ…ï¼‰ï¼š**

```yaml
version: '3.8'

services:
  db:
    image: postgres:15
    # âœ… ä¸æš´éœ² port åˆ°ä¸»æ©Ÿ
    # ports:  # â† ç§»é™¤é€™è¡Œ
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    networks:
      - db-network  # åªåœ¨å…§éƒ¨ç¶²è·¯

  api:
    image: myapi
    environment:
      DB_HOST: db  # â† é€é Docker ç¶²è·¯é€£æ¥
    networks:
      - db-network  # å¯ä»¥é€£æ¥è³‡æ–™åº«
      - web-network

  nginx:
    image: nginx
    ports:
      - "80:80"  # åªæœ‰ Nginx å°å¤–
    networks:
      - web-network  # ç„¡æ³•ç›´æ¥å­˜å–è³‡æ–™åº«

networks:
  db-network:
    internal: false  # é è¨­ï¼ˆå…è¨±å®¹å™¨è¨ªå•å¤–éƒ¨ç¶²è·¯ï¼‰
  
  web-network:
    driver: bridge
```

**é©—è­‰éš”é›¢æ•ˆæœï¼š**

```bash
# âœ… API å¯ä»¥é€£æ¥è³‡æ–™åº«
docker-compose exec api psql -h db -U postgres
# Success!

# âŒ Nginx ç„¡æ³•é€£æ¥è³‡æ–™åº«ï¼ˆä¸åœ¨åŒä¸€ç¶²è·¯ï¼‰
docker-compose exec nginx ping db
# ping: bad address 'db'

# âŒ ä¸»æ©Ÿç„¡æ³•ç›´æ¥é€£æ¥è³‡æ–™åº«
psql -h localhost -p 5432 -U postgres
# Connection refused
```

---

### ä½¿ç”¨ internal ç¶²è·¯ï¼ˆå®Œå…¨éš”é›¢ï¼‰

```yaml
version: '3.8'

services:
  db:
    image: postgres:15
    networks:
      - db-internal  # å®Œå…¨éš”é›¢çš„å…§éƒ¨ç¶²è·¯

  api:
    image: myapi
    networks:
      - db-internal  # å¯ä»¥é€£æ¥è³‡æ–™åº«
      - public       # ä¹Ÿå¯ä»¥é€£æ¥å¤–éƒ¨

networks:
  db-internal:
    internal: true  # âœ… å®¹å™¨ç„¡æ³•è¨ªå•å¤–éƒ¨ç¶²è·¯
  
  public:
    driver: bridge
```

**internal: true çš„æ•ˆæœï¼š**

1. å®¹å™¨ä¹‹é–“å¯ä»¥äº’ç›¸é€šè¨Š
2. **å®¹å™¨ç„¡æ³•è¨ªå•å¤–éƒ¨ç¶²è·¯ï¼ˆåŒ…æ‹¬ç¶²éš›ç¶²è·¯ï¼‰**
3. ä¸»æ©Ÿç„¡æ³•é€é port mapping è¨ªå•å®¹å™¨

```bash
# âœ… API å¯ä»¥é€£æ¥åˆ° DB
docker-compose exec api ping db
# Success

# âŒ DB ç„¡æ³•è¨ªå•ç¶²éš›ç¶²è·¯
docker-compose exec db ping google.com
# Network is unreachable

# âŒ API ä¹Ÿç„¡æ³•é€é db-internal ç¶²è·¯è¨ªå•å¤–éƒ¨
# ä½†å¯ä»¥é€é public ç¶²è·¯è¨ªå•
```

---

### å¤šå±¤ç¶²è·¯éš”é›¢

**ä¼æ¥­ç´šæ¶æ§‹ï¼š**

```yaml
version: '3.8'

services:
  # å‰ç«¯ï¼ˆå°å¤–ï¼‰
  nginx:
    image: nginx
    ports:
      - "443:443"
    networks:
      - frontend  # å‰ç«¯ç¶²è·¯

  # æ‡‰ç”¨å±¤ï¼ˆä¸­é–“å±¤ï¼‰
  api:
    image: myapi
    networks:
      - frontend  # é€£æ¥å‰ç«¯
      - backend   # é€£æ¥å¾Œç«¯
    # ä¸æš´éœ²ä»»ä½• port

  # è³‡æ–™å±¤ï¼ˆå…§éƒ¨ï¼‰
  postgres:
    image: postgres:15
    networks:
      - backend  # åªåœ¨å¾Œç«¯ç¶²è·¯
    # ä¸æš´éœ² port

  redis:
    image: redis:7
    networks:
      - backend

networks:
  # å‰ç«¯ç¶²è·¯ï¼šNginx â†” API
  frontend:
    driver: bridge
  
  # å¾Œç«¯ç¶²è·¯ï¼šAPI â†” DB/Redisï¼ˆå®Œå…¨éš”é›¢ï¼‰
  backend:
    driver: bridge
    internal: true  # â† è³‡æ–™åº«å±¤å®Œå…¨éš”é›¢
```

**ç¶²è·¯æ‹“æ’²ï¼š**

```
Internet
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nginx (å‰ç«¯)        â”‚
â”‚  - frontend          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ frontend network
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API (æ‡‰ç”¨å±¤)        â”‚
â”‚  - frontend          â”‚
â”‚  - backend           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ backend network (internal: true)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL / Redis  â”‚
â”‚  - backend (å…§éƒ¨)    â”‚
â”‚  â›” ç„¡æ³•è¨ªå•å¤–éƒ¨ç¶²è·¯  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®‰å…¨å„ªå‹¢ï¼š**

1. âœ… Nginx ç„¡æ³•ç›´æ¥è¨ªå•è³‡æ–™åº«
2. âœ… è³‡æ–™åº«ç„¡æ³•è¢«å¤–éƒ¨æ”»æ“Š
3. âœ… å³ä½¿ Nginx è¢«é§­ï¼Œè³‡æ–™åº«ä»ç„¶å®‰å…¨
4. âœ… è³‡æ–™åº«ç„¡æ³•å¤–æ´©è³‡æ–™åˆ°å¤–éƒ¨ç¶²è·¯

---

### Traefik æ•´åˆç¯„ä¾‹

```yaml
version: '3.8'

services:
  traefik:
    image: traefik:v2.10
    ports:
      - "80:80"
      - "443:443"
    networks:
      - traefik-public  # å°å¤–ç¶²è·¯

  api:
    image: myapi
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.example.com`)"
      - "traefik.docker.network=traefik-public"
    networks:
      - traefik-public  # Traefik å¯ä»¥è·¯ç”±
      - db-internal     # é€£æ¥è³‡æ–™åº«

  db:
    image: postgres:15
    networks:
      - db-internal  # åªåœ¨å…§éƒ¨ç¶²è·¯

networks:
  traefik-public:
    external: true  # å¤–éƒ¨å…±äº«ç¶²è·¯
  
  db-internal:
    internal: true  # å®Œå…¨éš”é›¢
```

**å•Ÿå‹•å‰æº–å‚™ï¼š**

```bash
# å»ºç«‹ Traefik å…¬é–‹ç¶²è·¯
docker network create traefik-public

# å•Ÿå‹•æœå‹™
docker-compose up -d
```

**è¨ªå•è·¯å¾‘ï¼š**

```
Internet â†’ Traefik (80/443)
              â†“
          API (traefik-public)
              â†“
          DB (db-internal)  â† ç„¡æ³•å¾å¤–éƒ¨ç›´æ¥è¨ªå•
```

---

### é˜²ç«ç‰†è¦å‰‡è£œå……

å³ä½¿ä½¿ç”¨ç¶²è·¯éš”é›¢ï¼Œå»ºè­°åœ¨ä¸»æ©Ÿå±¤é¢ä¹Ÿè¨­å®šé˜²ç«ç‰†ï¼š

```bash
# UFW (Ubuntu)
# åªå…è¨± 80 å’Œ 443 port
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# iptables
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 5432 -j DROP  # ç¦æ­¢ PostgreSQL
```

é€™æ¨£å¯ä»¥å¯¦ç¾**å¤šå±¤é˜²è­·**ï¼Œç¢ºä¿è³‡æ–™å®‰å…¨ï¼
