# 3. Docker Compose é€²éšæ¨¡çµ„åŒ–

## 3.1. çµ„æ…‹æª”ç¹¼æ‰¿æ©Ÿåˆ¶ (Inheritance)ï¼šç†è§£ Base Config èˆ‡ Override çš„é‹ä½œé‚è¼¯

### Docker Compose çš„æª”æ¡ˆåˆä½µåŸå‰‡

Docker Compose æ”¯æ´ä½¿ç”¨å¤šå€‹ YAML æª”æ¡ˆä¾†çµ„ç¹”è¨­å®šï¼Œé€é `-f` åƒæ•¸æŒ‡å®šå¤šå€‹æª”æ¡ˆæ™‚ï¼ŒDocker Compose æœƒæŒ‰ç…§**ç”±å·¦è‡³å³**çš„é †åºåˆä½µæª”æ¡ˆã€‚

```bash
# èªæ³•
docker-compose -f file1.yml -f file2.yml -f file3.yml up

# åˆä½µé †åºï¼šfile1 â† file2 â† file3ï¼ˆå¾Œé¢çš„è¦†è“‹å‰é¢çš„ï¼‰
```

### åˆä½µè¦å‰‡è©³è§£

**è¦å‰‡ 1ï¼šç‰©ä»¶ (Object) æœƒæ·±åº¦åˆä½µ**

```yaml
# base.yml
services:
  web:
    image: nginx
    ports:
      - "80:80"
    environment:
      ENV: production
```

```yaml
# override.yml
services:
  web:
    environment:
      DEBUG: "true"  # æ–°å¢æ¬„ä½
    volumes:
      -./html:/usr/share/nginx/html  # æ–°å¢ volumes
```

```bash
docker-compose -f base.yml -f override.yml config

# åˆä½µçµæœï¼š
# services:
#   web:
#     image: nginx
#     ports:
#       - "80:80"
#     environment:
#       ENV: production    â† ä¿ç•™
#       DEBUG: "true"      â† æ–°å¢
#     volumes:
#       - ./html:/usr/share/nginx/html  â† æ–°å¢
```

**è¦å‰‡ 2ï¼šé™£åˆ— (Array) æœƒå®Œå…¨æ›¿æ›ï¼ˆä¸æ˜¯åˆä½µï¼‰**

```yaml
# base.yml
services:
  web:
    image: nginx
    ports:
      - "80:80"
      - "443:443"
```

```yaml
# override.yml
services:
  web:
    ports:
      - "8080:80"  # å®Œå…¨æ›¿æ›ï¼Œä¸æ˜¯æ–°å¢
```

```bash
docker-compose -f base.yml -f override.yml config

# åˆä½µçµæœï¼š
# services:
#   web:
#     image: nginx
#     ports:
#       - "8080:80"  â† å®Œå…¨æ›¿æ›ï¼Œ443 port æ¶ˆå¤±äº†ï¼
```

> âš ï¸ **é‡è¦**ï¼šé™£åˆ—æ¬„ä½åŒ…æ‹¬ï¼š`ports`, `volumes`, `networks`, `depends_on`, `environment`ï¼ˆç•¶ä½¿ç”¨é™£åˆ—æ ¼å¼æ™‚ï¼‰

**è¦å‰‡ 3ï¼šç´”é‡å€¼ (Scalar) ç›´æ¥è¦†è“‹**

```yaml
# base.yml
services:
  web:
    image: nginx:1.25
    restart: always
```

```yaml
# override.yml
services:
  web:
    image: nginx:1.26  # è¦†è“‹
    restart: no        # è¦†è“‹
```

```bash
# åˆä½µçµæœï¼š
# services:
#   web:
#     image: nginx:1.26   â† è¢«è¦†è“‹
#     restart: no         â† è¢«è¦†è“‹
```

### å¯¦æˆ°ç¯„ä¾‹ï¼šä¸‰å±¤å¼æ¶æ§‹

```
.
â”œâ”€â”€ docker-compose.yml        # åŸºç¤è¨­å®šï¼ˆå…±é€šï¼‰
â”œâ”€â”€ docker-compose.dev.yml    # é–‹ç™¼ç’°å¢ƒè¦†å¯«
â””â”€â”€ docker-compose.prod.yml   # ç”Ÿç”¢ç’°å¢ƒè¦†å¯«
```

**docker-compose.ymlï¼ˆåŸºç¤è¨­å®šï¼‰ï¼š**
```yaml
ç‰ˆæœ¬å®šç¾©èˆ‡å…±é€šè¨­å®š
version: '3.8'

services:
  web:
    image: nginx:${NGINX_VERSION:-1.25}
    restart: unless-stopped
    networks:
      - frontend
  
  app:
    build:
      context: ./app
    networks:
      - frontend
      - backend
  
  db:
    image: postgres:15
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    networks:
      - backend

networks:
  frontend:
  backend:
```

**docker-compose.dev.ymlï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰ï¼š**
```yaml
version: '3.8'

services:
  web:
    # é–‹ç™¼ç’°å¢ƒä½¿ç”¨æœ¬åœ° 80 port
    ports:
      - "80:80"
    volumes:
      # æ›è¼‰æœ¬åœ°è¨­å®šæª”æ–¹ä¾¿èª¿æ•´
      - ./nginx.dev.conf:/etc/nginx/nginx.conf:ro
  
  app:
    # ä½¿ç”¨ volume æ›è¼‰è®“ç¨‹å¼ç¢¼ç†±æ›´æ–°
    volumes:
      - ./app:/app
      - /app/node_modules  # æ’é™¤ node_modules
    # é–‹å•Ÿé™¤éŒ¯æ¨¡å¼
    environment:
      NODE_ENV: development
      DEBUG: "*"
    # è¦†è“‹ CMD ä½¿ç”¨é–‹ç™¼ä¼ºæœå™¨
    command: npm run dev
  
  db:
    # é–‹ç™¼ç’°å¢ƒæš´éœ² port æ–¹ä¾¿ç”¨ GUI å·¥å…·é€£æ¥
    ports:
      - "5432:5432"
    # é–‹ç™¼ç’°å¢ƒé—œé–‰å¯†ç¢¼è¤‡é›œåº¦è¦æ±‚
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust
```

**docker-compose.prod.ymlï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰ï¼š**
```yaml
version: '3.8'

services:
  web:
    # ç”Ÿç”¢ç’°å¢ƒä¸ç›´æ¥æš´éœ² portï¼ˆé€é Traefikï¼‰
    expose:
      - "80"
    # è³‡æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    # å¥åº·æª¢æŸ¥
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 3s
      retries: 3
  
  app:
    # ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨å»ºç½®å¥½çš„æ˜ åƒæª”ï¼ˆä¸ç”¨ volumeï¼‰
    image: myapp:${APP_VERSION}
    environment:
      NODE_ENV: production
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
      replicas: 2  # å…©å€‹å‰¯æœ¬
  
  db:
    # ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨ Named Volume æŒä¹…åŒ–è³‡æ–™
    volumes:
      - db_data_prod:/var/lib/postgresql/data
    # ä¸æš´éœ² port åˆ°ä¸»æ©Ÿ
    # ports: []  # ç§»é™¤æ‰€æœ‰ port æš´éœ²
    deploy:
      resources:
        limits:
          memory: 2G

volumes:
  db_data_prod:  # ç”Ÿç”¢ç’°å¢ƒçš„è³‡æ–™åº« Volume
```

### ä½¿ç”¨æ–¹å¼

```bash
# é–‹ç™¼ç’°å¢ƒ
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d

# ç”Ÿç”¢ç’°å¢ƒ
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# æŸ¥çœ‹åˆä½µå¾Œçš„å®Œæ•´è¨­å®šï¼ˆé™¤éŒ¯ç”¨ï¼‰
docker-compose -f docker-compose.yml -f docker-compose.dev.yml config
```

---

## 3.2. å¤š YAML æª”æ¡ˆç®¡ç†å¯¦æˆ°

### 3.2.1. æ’°å¯« docker-compose.yml (é€šç”¨è¨­å®šï¼šImage åç¨±ã€ç¶²è·¯å®šç¾©)

**è¨­è¨ˆåŸå‰‡ï¼š**
- åªæ”¾ç½®**æ‰€æœ‰ç’°å¢ƒéƒ½éœ€è¦çš„è¨­å®š**
- ä¸åŒ…å«ç’°å¢ƒç‰¹å®šçš„åƒæ•¸ï¼ˆå¦‚ ports, volumesï¼‰
- å®šç¾©æœå‹™çš„**åŸºæœ¬æ¶æ§‹**

```yaml
# docker-compose.yml
version: '3.8'

# ========================================
# é€šç”¨è¨­å®šï¼šæ‰€æœ‰ç’°å¢ƒå…±ç”¨
# ========================================

services:
  # Nginx åå‘ä»£ç†
  nginx:
    image: nginx:${NGINX_VERSION:-1.25-alpine}
    container_name: ${PROJECT_NAME:-myproject}_nginx
    restart: unless-stopped
    depends_on:
      - api
      - frontend
    networks:
      - web_network
      - api_network

  # å‰ç«¯æ‡‰ç”¨
  frontend:
    image: node:18-alpine
    container_name: ${PROJECT_NAME:-myproject}_frontend
    working_dir: /app
    restart: unless-stopped
    networks:
      - web_network

  # API å¾Œç«¯
  api:
    image: node:18-alpine
    container_name: ${PROJECT_NAME:-myproject}_api
    working_dir: /app
    restart: unless-stopped
    depends_on:
      - db
      - redis
    networks:
      - api_network
      - db_network

  # PostgreSQL è³‡æ–™åº«
  db:
    image: postgres:${POSTGRES_VERSION:-15-alpine}
    container_name: ${PROJECT_NAME:-myproject}_db
    restart: unless-stopped
    environment:
      # å¾ .env æª”æ¡ˆè®€å–
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    networks:
      - db_network

  # Redis å¿«å–
  redis:
    image: redis:${REDIS_VERSION:-7-alpine}
    container_name: ${PROJECT_NAME:-myproject}_redis
    restart: unless-stopped
    networks:
      - db_network

# ========================================
# ç¶²è·¯å®šç¾©
# ========================================
networks:
  # å¤–éƒ¨ç¶²è·¯ï¼ˆNginx â†” Frontendï¼‰
  web_network:
    driver: bridge
  
  # API ç¶²è·¯ï¼ˆNginx â†” APIï¼‰
  api_network:
    driver: bridge
  
  # è³‡æ–™åº«ç¶²è·¯ï¼ˆAPI â†” DB/Redisï¼‰
  db_network:
    driver: bridge
    internal: true  # å…§éƒ¨ç¶²è·¯ï¼Œä¸å°å¤–

# ========================================
# åŸºç¤ Volumesï¼ˆåœ¨å„ç’°å¢ƒè¦†å¯«ï¼‰
# ========================================
volumes:
  db_data:
  redis_data:
```

---

### 3.2.2. æ’°å¯« docker-compose.dev.yml (é–‹ç™¼å°ˆç”¨ï¼šé–‹å•Ÿ Debugã€Bind Mounts æ›è¼‰åŸå§‹ç¢¼)

```yaml
# docker-compose.dev.yml
version: '3.8'

# ========================================
# é–‹ç™¼ç’°å¢ƒè¨­å®š
# ========================================

services:
  nginx:
    ports:
      - "8080:80"  # é–‹ç™¼ç’°å¢ƒä½¿ç”¨ 8080
    volumes:
      # æ›è¼‰è‡ªè¨‚ Nginx è¨­å®š
      - ./nginx/dev.conf:/etc/nginx/nginx.conf:ro
      # é–‹å•Ÿ nginx æ—¥èªŒè¼¸å‡º
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  frontend:
    ports:
      - "3000:3000"  # Vite dev server
    volumes:
      # ğŸ”¥ ç†±æ›´æ–°ï¼šæ›è¼‰åŸå§‹ç¢¼
      - ./frontend:/app
      - /app/node_modules  # æ’é™¤ node_modules
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:8080/api
      - VITE_DEV_SERVER_HOST=0.0.0.0  # å…è¨±å®¹å™¨å¤–éƒ¨è¨ªå•
    command: npm run dev -- --host
    # ä¸éœ€è¦è¨­å®š restartï¼Œé–‹ç™¼æ™‚ç¶“å¸¸æ‰‹å‹•é‡å•Ÿ

  api:
    ports:
      - "4000:4000"  # API ç›´æ¥æš´éœ²æ–¹ä¾¿æ¸¬è©¦
      - "9229:9229"  # Node.js é™¤éŒ¯ port
    volumes:
      # ğŸ”¥ ç†±æ›´æ–°ï¼šæ›è¼‰åŸå§‹ç¢¼
      - ./backend:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - DEBUG=app:*  # é–‹å•Ÿ debug æ—¥èªŒ
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_URL=redis://redis:6379
    # Nodemon è‡ªå‹•é‡å•Ÿ + é™¤éŒ¯æ¨¡å¼
    command: npm run dev:debug
    stdin_open: true  # å…è¨±æ¨™æº–è¼¸å…¥ï¼ˆäº’å‹•å¼é™¤éŒ¯ï¼‰
    tty: true

  db:
    ports:
      - "5432:5432"  # æš´éœ² port æ–¹ä¾¿ç”¨ TablePlus ç­‰å·¥å…·é€£æ¥
    volumes:
      # é–‹ç™¼ç’°å¢ƒä½¿ç”¨æœ¬åœ°è³‡æ–™å¤¾ï¼ˆæ–¹ä¾¿åˆªé™¤é‡å»ºï¼‰
      - ./data/postgres:/var/lib/postgresql/data
      # æ›è¼‰åˆå§‹åŒ–è…³æœ¬
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    environment:
      # é–‹ç™¼ç’°å¢ƒå¯ä»¥é—œé–‰å¯†ç¢¼æª¢æŸ¥åŠ é€Ÿå•Ÿå‹•
      # POSTGRES_HOST_AUTH_METHOD: trust  # âš ï¸ åƒ…é™æœ¬æ©Ÿé–‹ç™¼

  redis:
    ports:
      - "6379:6379"  # æš´éœ² port æ–¹ä¾¿ç”¨ Redis Client é€£æ¥
    volumes:
      # é–‹ç™¼ç’°å¢ƒè³‡æ–™å¯ä»¥ä¸æŒä¹…åŒ–ï¼ˆæˆ–ä½¿ç”¨æœ¬åœ°è³‡æ–™å¤¾ï¼‰
      - ./data/redis:/data
    # é–‹ç™¼ç’°å¢ƒå•Ÿç”¨ AOF æŒä¹…åŒ–ï¼ˆæ–¹ä¾¿è§€å¯Ÿï¼‰
    command: redis-server --appendonly yes

# ========================================
# é–‹ç™¼å·¥å…·æœå‹™
# ========================================

  # Adminerï¼ˆè³‡æ–™åº«ç®¡ç†ä»‹é¢ï¼‰
  adminer:
    image: adminer:latest
    container_name: ${PROJECT_NAME:-myproject}_adminer
    ports:
      - "8081:8080"
    networks:
      - db_network
    environment:
      ADMINER_DEFAULT_SERVER: db

  # MailDevï¼ˆéƒµä»¶æ¸¬è©¦å·¥å…·ï¼‰
  maildev:
    image: maildev/maildev:latest
    container_name: ${PROJECT_NAME:-myproject}_maildev
    ports:
      - "1080:1080"  # Web UI
      - "1025:1025"  # SMTP
    networks:
      - api_network
```

**é–‹ç™¼ç’°å¢ƒ .env æª”æ¡ˆï¼š**
```bash
# .env.dev
PROJECT_NAME=myproject
NGINX_VERSION=1.25-alpine
POSTGRES_VERSION=15-alpine
REDIS_VERSION=7-alpine

DB_NAME=myapp_dev
DB_USER=developer
DB_PASSWORD=dev123456

# API è¨­å®š
API_PORT=4000
JWT_SECRET=dev_secret_key_change_in_production
```

---

### 3.2.3. æ’°å¯« docker-compose.prod.yml (ç”Ÿç”¢å°ˆç”¨ï¼šRestart Policyã€è³‡æºé™åˆ¶)

```yaml
# docker-compose.prod.yml
version: '3.8'

# ========================================
# ç”Ÿç”¢ç’°å¢ƒè¨­å®š
# ========================================

services:
  nginx:
    # ä½¿ç”¨è‡ªè¨‚å»ºç½®çš„ Nginx æ˜ åƒæª”ï¼ˆåŒ…å«éœæ…‹æª”æ¡ˆï¼‰
    image: ${DOCKER_REGISTRY}/myproject-nginx:${VERSION}
    # ä¸ç›´æ¥æš´éœ² portï¼ˆé€é Traefik åå‘ä»£ç†ï¼‰
    expose:
      - "80"
    # Traefik Labels
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.myproject.rule=Host(`example.com`)"
      - "traefik.http.routers.myproject.entrypoints=websecure"
      - "traefik.http.routers.myproject.tls.certresolver=letsencrypt"
    networks:
      - traefik_proxy  # å¤–éƒ¨ Traefik ç¶²è·¯
      - web_network
    # ğŸ”§ è³‡æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    # å¥åº·æª¢æŸ¥
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  frontend:
    # ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨å»ºç½®å¥½çš„æ˜ åƒæª”
    image: ${DOCKER_REGISTRY}/myproject-frontend:${VERSION}
    # ä¸æ›è¼‰ volumesï¼ˆç¨‹å¼ç¢¼å·²æ‰“åŒ…åœ¨æ˜ åƒæª”ä¸­ï¼‰
    environment:
      - NODE_ENV=production
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
      # ğŸ”„ å¤šå‰¯æœ¬
      replicas: 2
      restart_policy:
        condition: on-failure  max_attempts: 3
        delay: 5s
    healthcheck:
      test: ["CMD", "node", "healthcheck.js"]
      interval: 30s
      timeout: 5s
      retries: 3

  api:
    image: ${DOCKER_REGISTRY}/myproject-api:${VERSION}
    # ä¸æš´éœ² portï¼ˆåªæ¥å—å…§éƒ¨é€£ç·šï¼‰
    environment:
      - NODE_ENV=production
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=info  # ç”Ÿç”¢ç’°å¢ƒé™ä½æ—¥èªŒç­‰ç´š
    # ğŸ” å”¯è®€æª”æ¡ˆç³»çµ±ï¼ˆå®‰å…¨æ€§ï¼‰
    read_only: true
    tmpfs:
      - /tmp
      - /app/logs
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      replicas: 3  # ä¸‰å€‹å‰¯æœ¬
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 15s
      timeout: 3s
      retries: 5
      start_period: 60s

  db:
    # ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨ Named Volume
    volumes:
      - db_data_prod:/var/lib/postgresql/data
    # ä¸æš´éœ²ä»»ä½• port åˆ°ä¸»æ©Ÿ
    # ports: []  # ç§»é™¤
    environment:
      # ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨å¼·å¯†ç¢¼
      POSTGRES_PASSWORD: ${DB_PASSWORD_PROD}
      # è¨­å®šé€£ç·šæ•¸é™åˆ¶
      POSTGRES_MAX_CONNECTIONS: 200
    # PostgreSQL å„ªåŒ–è¨­å®š
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    volumes:
      - redis_data_prod:/data
    # æŒä¹…åŒ–è¨­å®š
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

# ========================================
# ç”Ÿç”¢ç’°å¢ƒç¶²è·¯
# ========================================
networks:
  traefik_proxy:
    external: true  # ä½¿ç”¨å¤–éƒ¨ Traefik ç¶²è·¯

# ========================================
# ç”Ÿç”¢ç’°å¢ƒ Volumes
# ========================================
volumes:
  db_data_prod:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/data/postgres  # æ›è¼‰åˆ°å¯¦é«”ç£ç¢Ÿ
  
  redis_data_prod:
    driver: local
```

**ç”Ÿç”¢ç’°å¢ƒ .env æª”æ¡ˆï¼š**
```bash
# .env.prod
PROJECT_NAME=myproject_prod
DOCKER_REGISTRY=registry.example.com
VERSION=1.0.0

DB_NAME=myapp_production
DB_USER=app_user
DB_PASSWORD_PROD=<strong_random_password>

# å¾ CI/CD æˆ– Secret Manager æ³¨å…¥
# JWT_SECRET=<from_vault>
```

---

## 3.3. æŒ‡ä»¤çµ„åˆæŠ€å·§ï¼šä½¿ç”¨ -f åƒæ•¸åˆä½µå¤šå€‹çµ„æ…‹æª”

### åŸºæœ¬ç”¨æ³•

```bash
# èªæ³•
docker-compose -f <file1> -f <file2> ... <command>

# ç¯„ä¾‹ï¼šå•Ÿå‹•é–‹ç™¼ç’°å¢ƒ
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d

# ç¯„ä¾‹ï¼šå•Ÿå‹•ç”Ÿç”¢ç’°å¢ƒ
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

### å¸¸ç”¨æŒ‡ä»¤çµ„åˆ

**1. æŸ¥çœ‹åˆä½µå¾Œçš„å®Œæ•´è¨­å®šï¼ˆé™¤éŒ¯å¿…å‚™ï¼‰**
```bash
# è¼¸å‡ºåˆä½µå¾Œçš„ YAML åˆ°çµ‚ç«¯
docker-compose -f docker-compose.yml -f docker-compose.dev.yml config

# è¼¸å‡ºåˆ°æª”æ¡ˆ
docker-compose -f docker-compose.yml -f docker-compose.dev.yml config > merged.yml

# åªé¡¯ç¤ºç‰¹å®šæœå‹™
docker-compose -f docker-compose.yml -f docker-compose.dev.yml config --services
# è¼¸å‡ºï¼šnginx, frontend, api, db, redis, adminer, maildev
```

**2. å•Ÿå‹•ç‰¹å®šæœå‹™**
```bash
# åªå•Ÿå‹• API åŠå…¶ä¾è³´
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d api

# åªå•Ÿå‹•è³‡æ–™åº«
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d db redis
```

**3. æŸ¥çœ‹æ—¥èªŒ**
```bash
# æŸ¥çœ‹æ‰€æœ‰æœå‹™æ—¥èªŒ
docker-compose -f docker-compose.yml -f docker-compose.dev.yml logs -f

# æŸ¥çœ‹ç‰¹å®šæœå‹™
docker-compose -f docker-compose.yml -f docker-compose.dev.yml logs -f api

# åªé¡¯ç¤ºæœ€å¾Œ 100 è¡Œ
docker-compose -f docker-compose.yml -f docker-compose.dev.yml logs --tail=100 api
```

**4. é‡å•Ÿæœå‹™**
```bash
# é‡å•Ÿç‰¹å®šæœå‹™
docker-compose -f docker-compose.yml -f docker-compose.dev.yml restart api

# é‡æ–°å»ºç½®ä¸¦é‡å•Ÿ
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d --build api
```

**5. åœæ­¢èˆ‡åˆªé™¤**
```bash
# åœæ­¢æ‰€æœ‰æœå‹™
docker-compose -f docker-compose.yml -f docker-compose.dev.yml stop

# åœæ­¢ä¸¦åˆªé™¤å®¹å™¨ï¼ˆä¿ç•™ volumesï¼‰
docker-compose -f docker-compose.yml -f docker-compose.dev.yml down

# åˆªé™¤å®¹å™¨å’Œ volumes
docker-compose -f docker-compose.yml -f docker-compose.dev.yml down -v
```

### ç°¡åŒ–æŒ‡ä»¤ï¼šä½¿ç”¨ Shell Alias æˆ–è…³æœ¬

**æ–¹æ³• 1ï¼šShell Aliasï¼ˆé©åˆå€‹äººé–‹ç™¼ï¼‰**

```bash
# åœ¨ ~/.bashrc æˆ– ~/.zshrc åŠ å…¥
alias dcdev='docker-compose -f docker-compose.yml -f docker-compose.dev.yml'
alias dcprod='docker-compose -f docker-compose.yml -f docker-compose.prod.yml'

# é‡æ–°è¼‰å…¥
source ~/.bashrc

# ä½¿ç”¨
dcdev up -d
dcdev logs -f api
dcdev down
```

**æ–¹æ³• 2ï¼šMakefileï¼ˆæ¨è–¦ï¼‰**

```makefile
# Makefile
.PHONY: dev prod stop clean logs

# é–‹ç™¼ç’°å¢ƒ
dev:
	docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d

dev-build:
	docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d --build

dev-down:
	docker-compose -f docker-compose.yml -f docker-compose.dev.yml down

# ç”Ÿç”¢ç’°å¢ƒ
prod:
	docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

prod-build:
	docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build

prod-down:
	docker-compose -f docker-compose.yml -f docker-compose.prod.yml down

# é€šç”¨
logs:
	docker-compose -f docker-compose.yml -f docker-compose.dev.yml logs -f

stop:
	docker-compose -f docker-compose.yml -f docker-compose.dev.yml stop

clean:
	docker-compose -f docker-compose.yml -f docker-compose.dev.yml down -v
	docker system prune -f

# æŸ¥çœ‹è¨­å®š
config-dev:
	docker-compose -f docker-compose.yml -f docker-compose.dev.yml config

config-prod:
	docker-compose -f docker-compose.yml -f docker-compose.prod.yml config
```

**ä½¿ç”¨ Makefileï¼š**
```bash
# å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ
make dev

# æŸ¥çœ‹æ—¥èªŒ
make logs

# åœæ­¢
make stop

# å®Œå…¨æ¸…ç†
make clean
```

**æ–¹æ³• 3ï¼šShell è…³æœ¬ï¼ˆé©åˆ Teamï¼‰**

```bash
#!/bin/bash
# dc.sh - Docker Compose wrapper

ENV=${1:-dev}  # é è¨­ dev
shift  # ç§»é™¤ç¬¬ä¸€å€‹åƒæ•¸

case "$ENV" in
  dev)
    docker-compose -f docker-compose.yml -f docker-compose.dev.yml "$@"
    ;;
  prod)
    docker-compose -f docker-compose.yml -f docker-compose.prod.yml "$@"
    ;;
  *)
    echo "Usage: ./dc.sh {dev|prod} [docker-compose commands]"
    exit 1
    ;;
esac
```

```bash
# çµ¦äºˆåŸ·è¡Œæ¬Šé™
chmod +x dc.sh

# ä½¿ç”¨
./dc.sh dev up -d
./dc.sh dev logs -f api
./dc.sh prod up -d --build
./dc.sh prod down
```

---

## 3.4. ç’°å¢ƒè®Šæ•¸ç®¡ç†ï¼š.env æª”æ¡ˆèˆ‡ Shell è®Šæ•¸çš„å„ªå…ˆç´šæ¬Šé‡è§£æ

### ç’°å¢ƒè®Šæ•¸çš„ä¾†æºèˆ‡å„ªå…ˆç´š

Docker Compose æœƒå¾å¤šå€‹ä¾†æºè®€å–ç’°å¢ƒè®Šæ•¸ï¼Œå„ªå…ˆç´š**ç”±é«˜åˆ°ä½**ï¼š

```
1. Shell ç’°å¢ƒè®Šæ•¸ï¼ˆæœ€é«˜ï¼‰
2. docker-compose æŒ‡ä»¤ä¸­çš„ -e åƒæ•¸
3. docker-compose.yml ä¸­çš„ environment å€å¡Š
4. .env æª”æ¡ˆ
5. Dockerfile ä¸­çš„ ENV æŒ‡ä»¤ï¼ˆæœ€ä½ï¼‰
```

### è©³ç´°ç¯„ä¾‹

**æƒ…å¢ƒè¨­å®šï¼š**

```bash
# .env æª”æ¡ˆ
DB_HOST=localhost
DB_PORT=5432
NODE_ENV=development
```

```dockerfile
# Dockerfile
FROM node:18
ENV NODE_ENV=production  # Dockerfile ä¸­çš„é è¨­å€¼
ENV DB_PORT=3000
```

```yaml
# docker-compose.yml
services:
  api:
    build: .
    environment:
      DB_HOST: db  # è¦†å¯« .env çš„ DB_HOST
      DB_USER: ${DB_USER}  # å¾ .env è®€å–
```

**æ¸¬è©¦å„ªå…ˆç´šï¼š**

```bash
# æ¸¬è©¦ 1: åªç”¨ .env
docker-compose up
# çµæœï¼š
# DB_HOST=db (ä¾†è‡ª docker-compose.yml)
# DB_PORT=5432 (ä¾†è‡ª .env)
# DB_USER=å¾ .env è®€å–
# NODE_ENV=development (ä¾†è‡ª .envï¼Œè¦†è“‹ Dockerfile)

# æ¸¬è©¦ 2: Shell è®Šæ•¸è¦†å¯«
export NODE_ENV=staging
docker-compose up
# çµæœï¼š
# NODE_ENV=staging (Shell è®Šæ•¸å„ªå…ˆç´šæœ€é«˜)

# æ¸¬è©¦ 3: æŒ‡ä»¤åƒæ•¸
NODE_ENV=production DB_PORT=9999 docker-compose up
# çµæœï¼š
# NODE_ENV=production (Shell è®Šæ•¸)
# DB_PORT=9999 (Shell è®Šæ•¸ï¼Œè¦†è“‹ .env)
```

### .env æª”æ¡ˆçš„ä½¿ç”¨è¦å‰‡

**è¦å‰‡ 1ï¼šæª”æ¡ˆä½ç½®**
```
.
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ .env  â† å¿…é ˆèˆ‡ docker-compose.yml åŒç›®éŒ„
â””â”€â”€ services/
    â””â”€â”€ api/
        â”œâ”€â”€ Dockerfile
        â””â”€â”€ .env  â† é€™å€‹æª”æ¡ˆä¸æœƒè¢«è®€å–ï¼
```

**è¦å‰‡ 2ï¼š.env æª”æ¡ˆæ ¼å¼**
```bash
# .env

# âœ… æ­£ç¢ºï¼šç­‰è™Ÿå…©é‚Šä¸è¦æœ‰ç©ºæ ¼
DB_HOST=localhost
DB_PORT=5432

# âŒ éŒ¯èª¤ï¼šæœ‰ç©ºæ ¼
DB_HOST = localhost  # ä¸æœƒæ­£ç¢ºè§£æ

# âœ… æ”¯æ´å¼•è™Ÿï¼ˆè™•ç†ç©ºæ ¼å€¼ï¼‰
APP_NAME="My Application"
MESSAGE='Hello World'

# âœ… æ”¯æ´è¨»è§£
# é€™æ˜¯è¨»è§£
DB_USER=admin  # è¡Œå°¾è¨»è§£

# âœ… æ”¯æ´å¤šè¡Œå€¼ï¼ˆä½¿ç”¨å¼•è™Ÿï¼‰
DESCRIPTION="This is a
multi-line
value"

# âŒ ä¸æ”¯æ´è®Šæ•¸æ›¿ä»£
BASE_URL=http://localhost
API_URL=${BASE_URL}/api  # ä¸æœƒå±•é–‹ï¼Œæœƒæ˜¯å­—é¢å€¼
```

**è¦å‰‡ 3ï¼šåœ¨ docker-compose.yml ä¸­å¼•ç”¨**
```yaml
services:
  api:
    image: node:18
    environment:
      # æ–¹æ³• 1ï¼šè®Šæ•¸æ›¿æ›ï¼ˆæ¨è–¦ï¼‰
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      
      # æ–¹æ³• 2ï¼šè¨­å®šé è¨­å€¼
      - DB_USER=${DB_USER:-default_user}
      - DB_PASSWORD=${DB_PASSWORD:-default_password}
      
      # æ–¹æ³• 3ï¼šå¿…å¡«æª¢æŸ¥ï¼ˆæ²’è¨­å®šæœƒå ±éŒ¯ï¼‰
      - DB_NAME=${DB_NAME:?DB_NAME is required}
      
      # æ–¹æ³• 4ï¼šç›´æ¥å¯«æ­»å€¼
      - NODE_ENV=production
```

### å¤šç’°å¢ƒ .env ç®¡ç†ç­–ç•¥

**ç­–ç•¥ 1ï¼šåˆ†é›¢ .env æª”æ¡ˆ**

```
.
â”œâ”€â”€ .env.dev
â”œâ”€â”€ .env.staging
â”œâ”€â”€ .env.prod
â”œâ”€â”€ .env.example  # ç¯„æœ¬æª”æ¡ˆï¼ˆåŠ å…¥ Gitï¼‰
â””â”€â”€ docker-compose.yml
```

```bash
# ä½¿ç”¨å‰è¤‡è£½å°æ‡‰ç’°å¢ƒçš„æª”æ¡ˆ
cp .env.dev .env

# æˆ–ä½¿ç”¨ç¬¦è™Ÿé€£çµ
ln -sf .env.dev .env

# å•Ÿå‹•
docker-compose up -d
```

**ç­–ç•¥ 2ï¼šä½¿ç”¨ --env-file åƒæ•¸**

```bash
# æŒ‡å®šç’°å¢ƒè®Šæ•¸æª”æ¡ˆ
docker-compose --env-file .env.dev up -d
docker-compose --env-file .env.prod up -d

# å¯ä»¥çµåˆå¤šå€‹çµ„æ…‹æª”
docker-compose \
  -f docker-compose.yml \
  -f docker-compose.dev.yml \
  --env-file .env.dev \
  up -d
```

**ç­–ç•¥ 3ï¼šç’°å¢ƒè®Šæ•¸æ³¨å…¥è…³æœ¬**

```bash
#!/bin/bash
# start.sh

ENV=${1:-dev}

case "$ENV" in
  dev)
    export ENV_FILE=.env.dev
    COMPOSE_FILE="docker-compose.yml:docker-compose.dev.yml"
    ;;
  staging)
    export ENV_FILE=.env.staging
    COMPOSE_FILE="docker-compose.yml:docker-compose.staging.yml"
    ;;
  prod)
    export ENV_FILE=.env.prod
    COMPOSE_FILE="docker-compose.yml:docker-compose.prod.yml"
    ;;
  *)
    echo "Usage: ./start.sh {dev|staging|prod}"
    exit 1
    ;;
esac

# è¼‰å…¥ç’°å¢ƒè®Šæ•¸
set -a  # è‡ªå‹• export æ‰€æœ‰è®Šæ•¸
source "$ENV_FILE"
set +a

# å•Ÿå‹•æœå‹™
docker-compose -f ${COMPOSE_FILE//:/ -f } up -d
```

### å®‰å…¨æ€§æœ€ä½³å¯¦è¸

**1. ä¸è¦æŠŠ .env åŠ å…¥ Git**
```bash
# .gitignore
.env
.env.local
.env.*.local

# ä½†è¦æä¾›ç¯„æœ¬
!.env.example
```

**2. æä¾› .env.example ç¯„æœ¬**
```bash
# .env.example
# Database Settings
DB_HOST=localhost
DB_PORT=5432
DB_NAME=myapp
DB_USER=your_username_here
DB_PASSWORD=your_password_here

# Application Settings
NODE_ENV=development
JWT_SECRET=your_jwt_secret_here
API_PORT=4000
```

**3. ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨ Secret Manager**
```yaml
# docker-compose.prod.yml
services:
  api:
    environment:
      # å¾å¤–éƒ¨ç³»çµ±æ³¨å…¥ï¼ˆå¦‚ AWS Secrets Manager, Vaultï¼‰
      DB_PASSWORD: ${DB_PASSWORD}  # ç”± CI/CD pipeline æ³¨å…¥
    secrets:
      - db_password

secrets:
  db_password:
    external: true
```

**4. é©—è­‰å¿…è¦è®Šæ•¸**
```bash
#!/bin/bash
#check-env.sh

REQUIRED_VARS=("DB_HOST" "DB_PORT" "DB_NAME" "DB_USER" "DB_PASSWORD")

for var in "${REQUIRED_VARS[@]}"; do
  if [ -z "${!var}" ]; then
    echo "âŒ Error: $var is not set"
    exit 1
  else
    echo "âœ… $var is set"
  fi
done

echo "All required environment variables are set!"
```

```bash
# åœ¨å•Ÿå‹•å‰åŸ·è¡Œæª¢æŸ¥
source .env
./check-env.sh && docker-compose up -d
```

é€™æ¨£å¯ä»¥ç¢ºä¿ç’°å¢ƒè¨­å®šçš„æ­£ç¢ºæ€§èˆ‡å®‰å…¨æ€§ï¼
