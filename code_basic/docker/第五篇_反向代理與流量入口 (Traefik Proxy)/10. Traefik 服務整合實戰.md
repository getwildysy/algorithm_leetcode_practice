# 10. Traefik 服務整合實戰

## 10.1. 自動服務發現 (Auto Discovery)：Traefik 如何監聽 Docker Socket

### Docker Socket 監聽機制

**Docker Socket 是什麼？**

Docker Socket (`/var/run/docker.sock`) 是 Docker Daemon 與客戶端通訊的 Unix Socket，Traefik 透過監聽這個 Socket 來即時發現容器的啟動、停止與標籤變更。

```
┌─────────────────────────────────────┐
│  Docker Daemon                      │
│  /var/run/docker.sock              │
└────────────┬────────────────────────┘
             │ (Unix Socket)
             │
┌────────────▼────────────────────────┐
│  Traefik                            │
│  監聽 Socket 事件                    │
│  ├─ Container Start → 新增路由      │
│  ├─ Container Stop  → 移除路由      │
│  └─ Label Change    → 更新路由      │
└─────────────────────────────────────┘
```

### Traefik 設定

**docker-compose.yml：**

```yaml
version: '3.8'

services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    restart: unless-stopped
    
    command:
      # 啟用 Docker Provider
      - "--providers.docker=true"
      
      # Docker Socket 路徑（預設）
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      
      # 預設不暴露容器（需明確標註 traefik.enable=true）
      - "--providers.docker.exposedbydefault=false"
      
      # 指定要使用的 Docker 網路
      - "--providers.docker.network=traefik-public"
      
      # 監聽間隔（預設 1秒）
      - "--providers.docker.watch=true"
      
      # EntryPoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      
      # 儀表板
      - "--api.dashboard=true"
    
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    
    volumes:
      # ⚠️ 掛載 Docker Socket（允許 Traefik 監聽）
      - /var/run/docker.sock:/var/run/docker.sock:ro
      
      # SSL 憑證儲存
      - ./letsencrypt:/letsencrypt
    
    networks:
      - traefik-public
    
    labels:
      # Traefik 自己也需要標記（儀表板）
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=web"

networks:
  traefik-public:
    external: true
```

### 安全性考量

**問題：** 掛載 Docker Socket 相當於給予 Traefik **root 權限**

```yaml
# ⚠️ 危險：完整權限
volumes:
  - /var/run/docker.sock:/var/run/docker.sock
```

**Traefik 可以做的事：**
- 啟動/停止任何容器
- 刪除容器
- 存取容器內部
- 執行任意指令

**解決方案：** 使用 Docker Socket Proxy

```yaml
services:
  # Socket Proxy（限制權限）
  socket-proxy:
    image: tecnativa/docker-socket-proxy
    container_name: socket-proxy
    restart: unless-stopped
    environment:
      # 只允許讀取容器資訊
      CONTAINERS: 1
      NETWORKS: 1
      SERVICES: 1
      TASKS: 1
      # 禁止寫入操作
      POST: 0
      BUILD: 0
      COMMIT: 0
      CONFIGS: 0
      EXEC: 0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - socket-proxy

  traefik:
    image: traefik:v2.10
    command:
      # 透過 Proxy 連接
      - "--providers.docker.endpoint=tcp://socket-proxy:2375"
      - "--providers.docker=true"
    networks:
      - socket-proxy
      - traefik-public
    # 不需要直接掛載 Socket

networks:
  socket-proxy:
    internal: true
  traefik-public:
    external: true
```

---

## 10.2. 標籤配置法 (Labels)

### 10.2.1. 設定 Host Rule：綁定網域名稱 (Host)

**基本 Host Rule：**

```yaml
services:
  whoami:
    image: traefik/whoami
    labels:
      - "traefik.enable=true"
      
      # Host Rule：單一網域
      - "traefik.http.routers.whoami.rule=Host(`whoami.example.com`)"
      
      - "traefik.http.routers.whoami.entrypoints=websecure"
      - "traefik.http.routers.whoami.tls.certresolver=letsencrypt"
    networks:
      - traefik-public
```

**多網域 Host Rule：**

```yaml
services:
  app:
    image: myapp
    labels:
      - "traefik.enable=true"
      
      # 多個網域（使用 || 運算子）
      - "traefik.http.routers.app.rule=Host(`example.com`) || Host(`www.example.com`)"
      
      - "traefik.http.routers.app.entrypoints=websecure"
      - "traefik.http.routers.app.tls.certresolver=letsencrypt"
```

**萬用字元網域：**

```yaml
services:
  app:
    image: myapp
    labels:
      - "traefik.enable=true"
      
      # 萬用字元（需要 DNS 萬用字元記錄）
      - "traefik.http.routers.app.rule=HostRegexp(`{subdomain:[a-z]+}.example.com`)"
      
      - "traefik.http.routers.app.entrypoints=websecure"
      - "traefik.http.routers.app.tls.certresolver=letsencrypt"
      
      # 萬用字元 SSL
      - "traefik.http.routers.app.tls.domains[0].main=example.com"
      - "traefik.http.routers.app.tls.domains[0].sans=*.example.com"
```

**本機開發（localhost）：**

```yaml
services:
  app:
    image: myapp
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Host(`app.localhost`)"
      - "traefik.http.routers.app.entrypoints=web"  # HTTP only
```

---

### 10.2.2. 設定 Path Prefix：/api 轉發後端，/ 轉發前端

**完整全端應用範例：**

```yaml
version: '3.8'

services:
  # ========================================
  # 前端（處理根路徑）
  # ========================================
  frontend:
    image: frontend:latest
    labels:
      - "traefik.enable=true"
      
      # Router：處理根路徑與所有前端路由
      - "traefik.http.routers.frontend.rule=Host(`example.com`) && PathPrefix(`/`)"
      
      # 優先級（數字小 = 優先級低）
      - "traefik.http.routers.frontend.priority=1"
      
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
      - "traefik.docker.network=traefik-public"
    networks:
      - traefik-public

  # ========================================
  # API 後端（處理 /api 路徑）
  # ========================================
  backend:
    image: backend:latest
    labels:
      - "traefik.enable=true"
      
      # Router：處理 /api 開頭的所有請求
      - "traefik.http.routers.backend.rule=Host(`example.com`) && PathPrefix(`/api`)"
      
      # 優先級（數字大 = 優先級高，會先匹配）
      - "traefik.http.routers.backend.priority=10"
      
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=letsencrypt"
      
      # Middleware：移除 /api 前綴
      - "traefik.http.middlewares.backend-stripprefix.stripprefix.prefixes=/api"
      - "traefik.http.routers.backend.middlewares=backend-stripprefix"
      
      - "traefik.http.services.backend.loadbalancer.server.port=4000"
      - "traefik.docker.network=traefik-public"
    networks:
      - traefik-public

networks:
  traefik-public:
    external: true
```

**路由匹配測試：**

```bash
# 前端路由
curl https://example.com/                # → frontend (priority: 1)
curl https://example.com/about           # → frontend
curl https://example.com/products/123    # → frontend

# API 路由
curl https://example.com/api/users       # → backend (priority: 10)
# 實際轉發到 backend:4000/users （/api 被移除）

curl https://example.com/api/v1/products # → backend
# 實際轉發到 backend:4000/v1/products
```

**Strip Prefix 說明：**

```
請求：https://example.com/api/users

1. Traefik 收到請求
2. 路由規則匹配：PathPrefix(`/api`) ✅
3. Middleware 處理：stripprefix.prefixes=/api
   /api/users → /users
4. 轉發到後端：backend:4000/users
```

**多個 API 版本：**

```yaml
services:
  api-v1:
    image: api:v1
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api-v1.rule=Host(`example.com`) && PathPrefix(`/api/v1`)"
      - "traefik.http.routers.api-v1.priority=20"  # 更高優先級
      - "traefik.http.middlewares.api-v1-strip.stripprefix.prefixes=/api/v1"
      - "traefik.http.routers.api-v1.middlewares=api-v1-strip"

  api-v2:
    image: api:v2
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api-v2.rule=Host(`example.com`) && PathPrefix(`/api/v2`)"
      - "traefik.http.routers.api-v2.priority=20"
      - "traefik.http.middlewares.api-v2-strip.stripprefix.prefixes=/api/v2"
      - "traefik.http.routers.api-v2.middlewares=api-v2-strip"
```

---

### 10.2.3. 指定網路：traefik.docker.network 的重要性

**問題場景：** 容器連接到多個網路

```yaml
services:
  app:
    image: myapp
    networks:
      - traefik-public  # Traefik 所在網路
      - backend         # 資料庫網路
      - redis-network   # Redis 網路
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Host(`example.com`)"
```

**問題：** Traefik 不知道該使用哪個網路的 IP！

**解決：** 明確指定網路

```yaml
services:
  app:
    image: myapp
    networks:
      - traefik-public
      - backend
      - redis-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Host(`example.com`)"
      
      # ✅ 明確指定使用 traefik-public 網路
      - "traefik.docker.network=traefik-public"
```

**驗證：**

```bash
# 查看容器的網路
docker inspect app | jq '.[0].NetworkSettings.Networks'

# 輸出：
# {
#   "traefik-public": {
#     "IPAddress": "172.20.0.5"  ← Traefik 會使用這個 IP
#   },
#   "backend": {
#     "IPAddress": "172.21.0.3"
#   }
# }
```

---

## 10.3. HTTPS 自動化：設定 ACME (Let's Encrypt) 進行 SSL 證書自動申請與續期

### Let's Encrypt ACME 設定

**Traefik 設定：**

```yaml
services:
  traefik:
    image: traefik:v2.10
    command:
      # EntryPoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      
      # HTTP → HTTPS 重新導向
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      
      # ACME (Let's Encrypt) 設定
      - "--certificatesresolvers.letsencrypt.acme.email=admin@example.com"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      
      # HTTP Challenge（適合單機部署）
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      
      # 測試環境（避免 Rate Limit）
      # - "--certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
      
      # Docker Provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
    
    ports:
      - "80:80"
      - "443:443"
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      
      # ⚠️ ACME 檔案必須有正確權限
      - ./letsencrypt:/letsencrypt
    
    networks:
      - traefik-public
```

**建立 ACME 檔案：**

```bash
# 建立目錄
mkdir -p letsencrypt

# 建立空的 acme.json
touch letsencrypt/acme.json

# 設定權限（必須是 600）
chmod 600 letsencrypt/acme.json

# 驗證權限
ls -l letsencrypt/acme.json
# -rw------- 1 user user 0 Dec 12 10:00 acme.json
```

**應用服務設定：**

```yaml
services:
  app:
    image: myapp
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Host(`example.com`)"
      - "traefik.http.routers.app.entrypoints=websecure"
      
      # ✅ 啟用 TLS
      - "traefik.http.routers.app.tls=true"
      
      # ✅ 使用 Let's Encrypt
      - "traefik.http.routers.app.tls.certresolver=letsencrypt"
    networks:
      - traefik-public
```

### DNS Challenge（萬用字元憑證）

**適用場景：** `*.example.com` 萬用字元憑證

```yaml
services:
  traefik:
    image: traefik:v2.10
    command:
      # DNS Challenge (以 Cloudflare 為例)
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.letsencrypt.acme.email=admin@example.com"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    
    environment:
      # Cloudflare API Token
      CF_API_EMAIL: admin@example.com
      CF_API_KEY: your_cloudflare_api_key
```

**萬用字元憑證設定：**

```yaml
services:
  app:
    image: myapp
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Host(`app.example.com`)"
      - "traefik.http.routers.app.entrypoints=websecure"
      - "traefik.http.routers.app.tls=true"
      - "traefik.http.routers.app.tls.certresolver=letsencrypt"
      
      # 萬用字元網域設定
      - "traefik.http.routers.app.tls.domains[0].main=example.com"
      - "traefik.http.routers.app.tls.domains[0].sans=*.example.com"
```

### 驗證 SSL 憑證

```bash
# 查看 acme.json 內容
cat letsencrypt/acme.json | jq '.letsencrypt.Certificates[0].domain'

# 測試 HTTPS
curl -I https://example.com

# 輸出：
# HTTP/2 200
# server: nginx
# ...

# 檢查憑證有效期
openssl s_client -connect example.com:443 -servername example.com < /dev/null 2>/dev/null | openssl x509 -noout -dates

# 輸出：
# notBefore=Dec 12 00:00:00 2024 GMT
# notAfter=Mar 12 00:00:00 2025 GMT  ← 90天有效期
```

---

## 10.4. 中介軟體 (Middleware) 應用：Basic Auth 密碼保護與強制 HTTPS 重新導向

### Basic Auth 保護

**產生密碼：**

```bash
# 安裝 htpasswd
sudo apt-get install apache2-utils

# 產生密碼（使用者：admin）
htpasswd -nb admin mypassword

# 輸出：
# admin:$apr1$ruca84Hq$mbjdMZBAG.KWn7vfN/SNK/

# 多個使用者
htpasswd -nb admin password1
htpasswd -nb user password2

# 輸出：
# admin:$apr1$...
# user:$apr1$...
```

**Traefik 設定：**

```yaml
services:
  # 受保護的應用
  admin-panel:
    image: admin-panel:latest
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin.rule=Host(`admin.example.com`)"
      - "traefik.http.routers.admin.entrypoints=websecure"
      - "traefik.http.routers.admin.tls.certresolver=letsencrypt"
      
      # Basic Auth Middleware
      - "traefik.http.middlewares.admin-auth.basicauth.users=admin:$$apr1$$ruca84Hq$$mbjdMZBAG.KWn7vfN/SNK/"
      
      # ⚠️ 注意：$ 符號需要跳脫成 $$
      
      # 套用 Middleware
      - "traefik.http.routers.admin.middlewares=admin-auth"
    networks:
      - traefik-public
```

**多個使用者：**

```yaml
services:
  app:
    labels:
      # 方法 1：多行（推薦）
      - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$...,user:$$apr1$$..."
      
      # 方法 2：從檔案讀取
      - "traefik.http.middlewares.auth.basicauth.usersfile=/path/to/.htpasswd"
```

### HTTPS 強制重新導向

**全域重新導向：**

```yaml
services:
  traefik:
    command:
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      
      # 全域 HTTP → HTTPS
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
```

**個別服務設定：**

```yaml
services:
  app:
    labels:
      # HTTP Router（重新導向）
      - "traefik.http.routers.app-http.rule=Host(`example.com`)"
      - "traefik.http.routers.app-http.entrypoints=web"
      - "traefik.http.routers.app-http.middlewares=redirect-to-https"
      
      # HTTPS Router
      - "traefik.http.routers.app-https.rule=Host(`example.com`)"
      - "traefik.http.routers.app-https.entrypoints=websecure"
      - "traefik.http.routers.app-https.tls.certresolver=letsencrypt"
      
      # Redirect Middleware
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
```

### 組合多個 Middleware

```yaml
services:
  app:
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Host(`example.com`)"
      - "traefik.http.routers.app.entrypoints=websecure"
      - "traefik.http.routers.app.tls.certresolver=letsencrypt"
      
      # Middleware 1：壓縮
      - "traefik.http.middlewares.compress.compress=true"
      
      # Middleware 2：CORS
      - "traefik.http.middlewares.cors.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE"
      - "traefik.http.middlewares.cors.headers.accesscontrolalloworigin=*"
      - "traefik.http.middlewares.cors.headers.accesscontrolmaxage=100"
      
      # Middleware 3：Rate Limit
      - "traefik.http.middlewares.ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.ratelimit.ratelimit.burst=50"
      
      # Middleware 4：IP 白名單
      - "traefik.http.middlewares.whitelist.ipwhitelist.sourcerange=192.168.1.0/24,10.0.0.0/8"
      
      # ✅ 組合套用（使用逗號分隔）
      - "traefik.http.routers.app.middlewares=compress,cors,ratelimit,whitelist"
```

### 常用 Middleware 範例

**1. 自訂標頭：**

```yaml
- "traefik.http.middlewares.headers.headers.customrequestheaders.X-Custom-Header=value"
- "traefik.http.middlewares.headers.headers.customresponseheaders.X-Powered-By=Traefik"
```

**2. 路徑重寫：**

```yaml
# /old/path → /new/path
- "traefik.http.middlewares.rewrite.replacepathregex.regex=^/old/(.*)"
- "traefik.http.middlewares.rewrite.replacepathregex.replacement=/new/$$1"
```

**3. Retry（重試）：**

```yaml
- "traefik.http.middlewares.retry.retry.attempts=3"
- "traefik.http.middlewares.retry.retry.initialinterval=100ms"
```

**4. 電路斷路器：**

```yaml
- "traefik.http.middlewares.breaker.circuitbreaker.expression=NetworkErrorRatio() > 0.3"
```

**完整實戰範例：**

```yaml
version: '3.8'

services:
  traefik:
    image: traefik:v2.10
    command:
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--certificatesresolvers.letsencrypt.acme.email=admin@example.com"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./letsencrypt:/letsencrypt
    networks:
      - traefik-public

  frontend:
    image: frontend:latest
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`example.com`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
      - "traefik.docker.network=traefik-public"
    networks:
      - traefik-public

  api:
    image: api:latest
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`example.com`) && PathPrefix(`/api`)"
      - "traefik.http.routers.api.priority=10"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      
      # Middlewares
      - "traefik.http.middlewares.api-strip.stripprefix.prefixes=/api"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolalloworigin=*"
      - "traefik.http.middlewares.api-ratelimit.ratelimit.average=50"
      - "traefik.http.routers.api.middlewares=api-strip,api-cors,api-ratelimit"
      
      - "traefik.http.services.api.loadbalancer.server.port=4000"
      - "traefik.docker.network=traefik-public"
    networks:
      - traefik-public

  admin:
    image: admin:latest
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin.rule=Host(`admin.example.com`)"
      - "traefik.http.routers.admin.entrypoints=websecure"
      - "traefik.http.routers.admin.tls.certresolver=letsencrypt"
      
      # Basic Auth
      - "traefik.http.middlewares.admin-auth.basicauth.users=admin:$$apr1$$..."
      - "traefik.http.routers.admin.middlewares=admin-auth"
      
      - "traefik.http.services.admin.loadbalancer.server.port=3000"
      - "traefik.docker.network=traefik-public"
    networks:
      - traefik-public

networks:
  traefik-public:
    external: true
```

這樣可以實現完整的 Traefik 服務整合與安全防護！
