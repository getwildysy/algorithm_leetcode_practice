# 6. å…¨ç«¯å°ˆæ¡ˆçµæ§‹è¨­è¨ˆ (Monorepo vs Polyrepo)

## 6.1. Build Context è¨­å®šï¼šåœ¨æ ¹ç›®éŒ„ YAML ä¸­åˆ†åˆ¥æŒ‡å‘ ./frontend èˆ‡ ./backend

### å°ˆæ¡ˆçµæ§‹è¨­è¨ˆ

**Monorepo çµæ§‹ï¼ˆå–®ä¸€å„²å­˜åº«ï¼‰ï¼š**

```
my-fullstack-app/
â”œâ”€â”€ docker-compose.yml          # æ ¹ç›®éŒ„çš„ Compose æª”æ¡ˆ
â”œâ”€â”€ .env
â”œâ”€â”€ frontend/                   # å‰ç«¯å°ˆæ¡ˆ
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ App.jsx
â”‚   â”‚   â””â”€â”€ main.jsx
â”‚   â””â”€â”€ dist/                   # å»ºç½®è¼¸å‡º
â”œâ”€â”€ backend/                    # å¾Œç«¯å°ˆæ¡ˆ
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ server.js
â”‚   â”‚   â””â”€â”€ routes/
â”‚   â””â”€â”€ node_modules/
â””â”€â”€ nginx/                      # Nginx è¨­å®š
    â””â”€â”€ nginx.conf
```

### Build Context åŸºæœ¬æ¦‚å¿µ

**Build Context** æ˜¯ Docker å»ºç½®æ˜ åƒæª”æ™‚å¯ä»¥å­˜å–çš„**æª”æ¡ˆç›®éŒ„ç¯„åœ**ã€‚

```bash
# Build Context ç¤ºæ„åœ–
docker build -t myapp -f /path/to/Dockerfile /build/context

# èªæ³•ï¼š
# docker build [OPTIONS] PATH
#                         ^^^^
#                    Build Context è·¯å¾‘
```

**é‡è¦è¦å‰‡ï¼š**
- Dockerfile ä¸­çš„ `COPY` å’Œ `ADD` æŒ‡ä»¤åªèƒ½å­˜å– Build Context å…§çš„æª”æ¡ˆ
- ç„¡æ³•å­˜å– Context å¤–çš„æª”æ¡ˆï¼ˆå³ä½¿ä½¿ç”¨ `../`ï¼‰

---

### Docker Compose ä¸­è¨­å®š Build Context

**æ ¹ç›®éŒ„çš„ docker-compose.ymlï¼š**

```yaml
version: '3.8'

services:
  # ========================================
  # å‰ç«¯æœå‹™
  # ========================================
  frontend:
    build:
      context: ./frontend      # Build Context = frontend ç›®éŒ„
      dockerfile: Dockerfile    # ä½¿ç”¨ frontend/Dockerfile
      args:                     # å»ºç½®åƒæ•¸
        NODE_ENV: production
        API_URL: ${API_URL}
    image: myapp-frontend:${VERSION:-latest}
    container_name: frontend
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://backend:4000
    networks:
      - app-network
    depends_on:
      - backend

  # ========================================
  # å¾Œç«¯æœå‹™
  # ========================================
  backend:
    build:
      context: ./backend       # Build Context = backend ç›®éŒ„
      dockerfile: Dockerfile
      args:
        NODE_ENV: production
    image: myapp-backend:${VERSION:-latest}
    container_name: backend
    ports:
      - "4000:4000"
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - REDIS_URL=redis://redis:6379
    networks:
      - app-network
      - db-network
    depends_on:
      - postgres
      - redis

  # ========================================
  # Nginx åå‘ä»£ç†
  # ========================================
  nginx:
    build:
      context: ./nginx         # Build Context = nginx ç›®éŒ„
      dockerfile: Dockerfile
    image: myapp-nginx:${VERSION:-latest}
    ports:
      - "80:80"
      - "443:443"
    networks:
      - app-network
    depends_on:
      - frontend
      - backend

  # ========================================
  # è³‡æ–™åº«
  # ========================================
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - db-network

  redis:
    image: redis:7-alpine
    networks:
      - db-network

networks:
  app-network:
  db-network:
    internal: true

volumes:
  postgres_data:
```

---

### å‰ç«¯ Dockerfile ç¯„ä¾‹

**frontend/Dockerfileï¼š**

```dockerfile
# ========================================
# Stage 1: Build Stage (å»ºç½®éšæ®µ)
# ========================================
FROM node:18-alpine AS builder

# è¨­å®šå·¥ä½œç›®éŒ„
WORKDIR /app

# å…ˆè¤‡è£½ package.jsonï¼ˆåˆ©ç”¨ Docker å¿«å–ï¼‰
COPY package.json package-lock.json ./

# å®‰è£ä¾è³´
RUN npm ci --only=production

# è¤‡è£½åŸå§‹ç¢¼
COPY . .

# æ¥æ”¶å»ºç½®åƒæ•¸
ARG API_URL=http://localhost:4000
ENV VITE_API_URL=$API_URL

# å»ºç½®ç”Ÿç”¢ç‰ˆæœ¬
RUN npm run build
# è¼¸å‡ºåˆ° /app/dist


# ========================================
# Stage 2: Production Stage (ç”Ÿç”¢éšæ®µ)
# ========================================
FROM nginx:alpine

# è¤‡è£½è‡ªè¨‚ Nginx è¨­å®š
COPY nginx.conf /etc/nginx/nginx.conf

# å¾ builder éšæ®µè¤‡è£½å»ºç½®å¥½çš„éœæ…‹æª”æ¡ˆ
COPY --from=builder /app/dist /usr/share/nginx/html

# æš´éœ² port
EXPOSE 80

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --quiet --tries=1 --spider http://localhost/ || exit 1

# å•Ÿå‹• Nginx
CMD ["nginx", "-g", "daemon off;"]
```

**èªªæ˜ï¼š**
- **Stage 1**ï¼šä½¿ç”¨ Node.js å»ºç½®å‰ç«¯ï¼ˆVite/React/Vueï¼‰
- **Stage 2**ï¼šåªä¿ç•™éœæ…‹æª”æ¡ˆ + Nginxï¼Œå¤§å¹…ç¸®å°æ˜ åƒæª”å¤§å°
- **å¾ builder è¤‡è£½**ï¼š`COPY --from=builder` å¾å»ºç½®éšæ®µå–å¾—ç”¢ç‰©

---

### å¾Œç«¯ Dockerfile ç¯„ä¾‹

**backend/Dockerfileï¼š**

```dockerfile
# ========================================
# Stage 1: Dependencies (ä¾è³´å®‰è£)
# ========================================
FROM node:18-alpine AS deps

WORKDIR /app

# åªè¤‡è£½ package æª”æ¡ˆ
COPY package.json package-lock.json ./

# å®‰è£æ‰€æœ‰ä¾è³´ï¼ˆåŒ…å« devDependenciesï¼Œå› ç‚ºå¯èƒ½éœ€è¦ç·¨è­¯ï¼‰
RUN npm ci


# ========================================
# Stage 2: Builder (å»ºç½®éšæ®µ)
# ========================================
FROM node:18-alpine AS builder

WORKDIR /app

# å¾ deps éšæ®µè¤‡è£½ node_modules
COPY --from=deps /app/node_modules ./node_modules

# è¤‡è£½åŸå§‹ç¢¼
COPY . .

# å¦‚æœä½¿ç”¨ TypeScriptï¼Œé€™è£¡ç·¨è­¯
# RUN npm run build

# ç§»é™¤ devDependencies
RUN npm prune --production


# ========================================
# Stage 3: Runner (åŸ·è¡Œéšæ®µ)
# ========================================
FROM node:18-alpine AS runner

# è¨­å®šé root ä½¿ç”¨è€…
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nodejs

WORKDIR /app

# åˆ‡æ›ä½¿ç”¨è€…
USER nodejs

# åªè¤‡è£½å¿…è¦æª”æ¡ˆ
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nodejs:nodejs /app/package.json ./
COPY --from=builder --chown=nodejs:nodejs /app/src ./src

# æš´éœ² port
EXPOSE 4000

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
  CMD node healthcheck.js || exit 1

# å•Ÿå‹•æ‡‰ç”¨
CMD ["node", "src/server.js"]
```

**å„ªåŒ–é‡é»ï¼š**
1. **ä¸‰éšæ®µå»ºç½®**ï¼šdeps â†’ builder â†’ runner
2. **é root ä½¿ç”¨è€…**ï¼šæå‡å®‰å…¨æ€§
3. **åªè¤‡è£½å¿…è¦æª”æ¡ˆ**ï¼šç¸®å°æ˜ åƒæª”å¤§å°
4. **æª”æ¡ˆæ‰€æœ‰æ¬Š**ï¼š`--chown=nodejs:nodejs`

---

### å»ºç½®èˆ‡å•Ÿå‹•

```bash
# å»ºç½®æ‰€æœ‰æœå‹™
docker-compose build

# å»ºç½®ç‰¹å®šæœå‹™
docker-compose build frontend

# ä¸ä½¿ç”¨å¿«å–é‡æ–°å»ºç½®
docker-compose build --no-cache backend

# å»ºç½®ä¸¦å•Ÿå‹•
docker-compose up -d --build

# æŸ¥çœ‹å»ºç½®çš„æ˜ åƒæª”
docker images | grep myapp
# myapp-frontend   latest   ...   150MB
# myapp-backend    latest   ...   180MB
# myapp-nginx      latest   ...   25MB
```

---

### é€²éšï¼šä½¿ç”¨ä¸åŒçš„ Dockerfile

```yaml
services:
  frontend-dev:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev  # é–‹ç™¼ç’°å¢ƒç”¨
  
  frontend-prod:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod  # ç”Ÿç”¢ç’°å¢ƒç”¨
```

---

### Context å¤–éƒ¨æª”æ¡ˆçš„è™•ç†

**éŒ¯èª¤ç¤ºç¯„ï¼š**

```dockerfile
# backend/Dockerfile
FROM node:18

WORKDIR /app

# âŒ éŒ¯èª¤ï¼šç„¡æ³•å­˜å– Context å¤–çš„æª”æ¡ˆ
COPY ../shared/utils.js ./utils.js
# Error: COPY failed: Forbidden path outside the build context
```

**è§£æ±ºæ–¹æ¡ˆ 1ï¼šèª¿æ•´ Build Context**

```yaml
services:
  backend:
    build:
      context: .          # Context è¨­ç‚ºæ ¹ç›®éŒ„
      dockerfile: backend/Dockerfile  # æŒ‡å®š Dockerfile è·¯å¾‘
```

```dockerfile
# backend/Dockerfile
FROM node:18
WORKDIR /app

# âœ… ç¾åœ¨å¯ä»¥å­˜å–
COPY shared/utils.js ./utils.js
COPY backend/src ./src
```

**è§£æ±ºæ–¹æ¡ˆ 2ï¼šä½¿ç”¨ç¬¦è™Ÿé€£çµ**

```bash
# åœ¨ backend ç›®éŒ„å»ºç«‹ç¬¦è™Ÿé€£çµ
cd backend
ln -s ../shared ./shared
```

```dockerfile
# backend/Dockerfile
COPY shared/utils.js ./utils.js  # âœ… é€éç¬¦è™Ÿé€£çµå­˜å–
```

---

## 6.2. å¤šéšæ®µå»ºç½® (Multi-stage Builds) æ‡‰ç”¨

### ç‚ºä»€éº¼éœ€è¦å¤šéšæ®µå»ºç½®ï¼Ÿ

**å•é¡Œï¼šå–®éšæ®µå»ºç½®çš„ç¼ºé»**

```dockerfile
# âŒ å–®éšæ®µå»ºç½®
FROM node:18

WORKDIR /app
COPY package.json .
RUN npm install  # åŒ…å« devDependencies
COPY . .
RUN npm run build

CMD ["npm", "start"]
```

**ç¼ºé»ï¼š**
- æ˜ åƒæª”åŒ…å«æ‰€æœ‰ `devDependencies`ï¼ˆå¦‚ webpack, babelï¼‰
- åŒ…å«åŸå§‹ç¢¼ï¼ˆTypeScriptã€JSX ç­‰ï¼‰
- æ˜ åƒæª”å¤§å°è†¨è„¹ï¼ˆå¯èƒ½ > 1GBï¼‰

**è§£æ±ºï¼šå¤šéšæ®µå»ºç½®**

- å»ºç½®éšæ®µï¼šå®‰è£æ‰€æœ‰å·¥å…·ã€ç·¨è­¯ç¨‹å¼ç¢¼
- åŸ·è¡Œéšæ®µï¼šåªä¿ç•™ç”¢ç‰©å’ŒåŸ·è¡Œç’°å¢ƒ
- æ˜ åƒæª”å¤§å°ç¸®å° 70-90%

---

### 6.2.1. å‰ç«¯æœ€ä½³åŒ–ï¼šNode.js Build â†’ Nginx Serve (éœæ…‹æª”æ¡ˆä¼ºæœ)

### React/Vite å°ˆæ¡ˆç¯„ä¾‹

**frontend/Dockerfileï¼š**

```dockerfile
# ========================================
# Stage 1: å»ºç½®éšæ®µ
# ========================================
FROM node:18-alpine AS build

WORKDIR /app

# å®‰è£ä¾è³´
COPY package*.json ./
RUN npm ci

# è¤‡è£½åŸå§‹ç¢¼ä¸¦å»ºç½®
COPY . .
RUN npm run build
# ç”¢ç‰©ï¼š/app/dist (ç´„ 2-5MB)


# ========================================
# Stage 2: ç”Ÿç”¢éšæ®µï¼ˆNginxï¼‰
# ========================================
FROM nginx:alpine

# è¤‡è£½å»ºç½®ç”¢ç‰©
COPY --from=build /app/dist /usr/share/nginx/html

# è¤‡è£½è‡ªè¨‚ Nginx è¨­å®š
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

**Nginx è¨­å®šï¼ˆnginx.confï¼‰ï¼š**

```nginx
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Gzip å£“ç¸®
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_min_length 1000;

    # SPA è·¯ç”±æ”¯æ´
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API ä»£ç†
    location /api/ {
        proxy_pass http://backend:4000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # éœæ…‹è³‡æºå¿«å–
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

**æ˜ åƒæª”å¤§å°æ¯”è¼ƒï¼š**

```bash
# å»ºç½®
docker build -t frontend:multi-stage -f Dockerfile .

# æŸ¥çœ‹å¤§å°
docker images frontend

# çµæœå°æ¯”ï¼š
# å–®éšæ®µï¼š  node:18 base (980MB) + dependencies (200MB) = 1.2GB
# å¤šéšæ®µï¼š  nginx:alpine (25MB) + éœæ…‹æª”æ¡ˆ (3MB) = 28MB
# ç¸®å°æ¯”ä¾‹ï¼š97.7% ğŸ‰
```

---

### Next.js å°ˆæ¡ˆç¯„ä¾‹

```dockerfile
# ========================================
# Dependencies
# ========================================
FROM node:18-alpine AS deps

WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci


# ========================================
# Builder
# ========================================
FROM node:18-alpine AS builder

WORKDIR /app

COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Next.js ç’°å¢ƒè®Šæ•¸
ENV NEXT_TELEMETRY_DISABLED 1

# å»ºç½®
RUN npm run build


# ========================================
# Runner
# ========================================
FROM node:18-alpine AS runner

WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# åªè¤‡è£½å¿…è¦æª”æ¡ˆ
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000

CMD ["node", "server.js"]
```

**package.json è¨­å®šï¼š**

```json
{
  "scripts": {
    "build": "next build"
  },
  "next": {
    "output": "standalone"  // â† å•Ÿç”¨ standalone æ¨¡å¼
  }
}
```

---

### 6.2.2. å¾Œç«¯æœ€ä½³åŒ–ï¼šç·¨è­¯ç’°å¢ƒ (SDK) â†’ åŸ·è¡Œç’°å¢ƒ (Runtime)

### Node.js/TypeScript å°ˆæ¡ˆ

```dockerfile
# ========================================
# Stage 1: å»ºç½®ç’°å¢ƒï¼ˆåŒ…å« TypeScriptï¼‰
# ========================================
FROM node:18-alpine AS builder

WORKDIR /app

# å®‰è£ä¾è³´
COPY package*.json ./
RUN npm ci

# è¤‡è£½ TypeScript è¨­å®š
COPY tsconfig.json ./

# è¤‡è£½åŸå§‹ç¢¼
COPY src ./src

# ç·¨è­¯ TypeScript
RUN npm run build
# ç”¢ç‰©ï¼š/app/dist

# ç§»é™¤ devDependencies
RUN npm prune --production


# ========================================
# Stage 2: åŸ·è¡Œç’°å¢ƒï¼ˆåªæœ‰ Node.jsï¼‰
# ========================================
FROM node:18-alpine AS runner

WORKDIR /app

# å»ºç«‹é root ä½¿ç”¨è€…
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# åªè¤‡è£½ç·¨è­¯å¾Œçš„ JS æª”æ¡ˆ
COPY --from=builder --chown=nodejs:nodejs /app/dist ./dist
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nodejs:nodejs /app/package.json ./

USER nodejs

EXPOSE 4000

HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:4000/health', (r) => r.statusCode === 200 ? process.exit(0) : process.exit(1))" || exit 1

CMD ["node", "dist/server.js"]
```

**tsconfig.jsonï¼š**

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

---

### Python/FastAPI å°ˆæ¡ˆ

```dockerfile
# ========================================
# Stage 1: å»ºç½®ç’°å¢ƒ
# ========================================
FROM python:3.11-slim AS builder

WORKDIR /app

# å®‰è£å»ºç½®å·¥å…·
RUN apt-get update && \
    apt-get install -y --no-install-recommends gcc g++ && \
    rm -rf /var/lib/apt/lists/*

# å®‰è£ Python ä¾è³´
COPY requirements.txt ./
RUN pip install --user --no-cache-dir -r requirements.txt


# ========================================
# Stage 2: åŸ·è¡Œç’°å¢ƒ
# ========================================
FROM python:3.11-slim

WORKDIR /app

# å»ºç«‹é root ä½¿ç”¨è€…
RUN useradd -m -u 1001 appuser

# å¾ builder è¤‡è£½å·²å®‰è£çš„å¥—ä»¶
COPY --from=builder /root/.local /home/appuser/.local

# è¤‡è£½æ‡‰ç”¨ç¨‹å¼ç¢¼
COPY --chown=appuser:appuser . .

# æ›´æ–° PATH
ENV PATH=/home/appuser/.local/bin:$PATH

USER appuser

EXPOSE 8000

HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
  CMD curl -f http://localhost:8000/health || exit 1

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

---

### Go å°ˆæ¡ˆï¼ˆæ¥µè‡´å„ªåŒ–ï¼‰

```dockerfile
# ========================================
# Stage 1: å»ºç½®ç’°å¢ƒ
# ========================================
FROM golang:1.21-alpine AS builder

WORKDIR /app

# ä¸‹è¼‰ä¾è³´
COPY go.mod go.sum ./
RUN go mod download

# è¤‡è£½åŸå§‹ç¢¼
COPY . .

# ç·¨è­¯ï¼ˆå®Œå…¨éœæ…‹é€£çµï¼‰
RUN CGO_ENABLED=0 GOOS=linux go build \
    -a -installsuffix cgo \
    -ldflags '-extldflags "-static" -s -w' \
    -o main .


# ========================================
# Stage 2: æ¥µç°¡åŸ·è¡Œç’°å¢ƒ
# ========================================
FROM scratch

# è¤‡è£½ SSL æ†‘è­‰ï¼ˆå¦‚æœéœ€è¦ HTTPS è«‹æ±‚ï¼‰
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/

# è¤‡è£½ç·¨è­¯å¥½çš„äºŒé€²åˆ¶æª”æ¡ˆ
COPY --from=builder /app/main /main

EXPOSE 8080

CMD ["/main"]
```

**æ˜ åƒæª”å¤§å°ï¼š**
```bash
# golang:1.21-alpine (builder): 300MB
# scratch + binary:             10MB
# ç¸®å°æ¯”ä¾‹ï¼š96.7% ğŸš€
```

---

## 6.3. æœ¬æ©Ÿé–‹ç™¼ç†±æ›´æ–° (Hot Reload) çš„ Volume æ›è¼‰æŠ€å·§

### å‰ç«¯ç†±æ›´æ–°è¨­å®š

**docker-compose.dev.ymlï¼š**

```yaml
version: '3.8'

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev  # é–‹ç™¼å°ˆç”¨
      target: development         # å¤šéšæ®µå»ºç½®çš„ development éšæ®µ
    volumes:
      # ğŸ”¥ æ›è¼‰åŸå§‹ç¢¼ï¼ˆç†±æ›´æ–°ï¼‰
      - ./frontend/src:/app/src:ro  # å”¯è®€æ›è¼‰ï¼ˆå®¹å™¨ä¸ä¿®æ”¹ä¸»æ©Ÿæª”æ¡ˆï¼‰
      - ./frontend/public:/app/public:ro
      
      # âš ï¸ æ’é™¤ node_modulesï¼ˆä½¿ç”¨å®¹å™¨å…§çš„ç‰ˆæœ¬ï¼‰
      - /app/node_modules
      
      # Vite å¿«å–
      - frontend_cache:/app/.vite
    ports:
      - "3000:3000"
      - "24678:24678"  # Vite HMR port
    environment:
      - NODE_ENV=development
      - VITE_HMR_HOST=localhost  # Hot Module Replacement
    command: npm run dev -- --host 0.0.0.0

volumes:
  frontend_cache:
```

**frontend/Dockerfile.devï¼š**

```dockerfile
FROM node:18-alpine

WORKDIR /app

# å®‰è£ä¾è³´
COPY package*.json ./
RUN npm install  # é–‹ç™¼ç’°å¢ƒå®‰è£æ‰€æœ‰ä¾è³´

# è¤‡è£½è¨­å®šæª”
COPY vite.config.js ./
COPY index.html ./

# ä¸è¤‡è£½ srcï¼ˆæœƒå¾ volume æ›è¼‰ï¼‰

EXPOSE 3000 24678

CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
```

**é‡è¦ï¼š`/app/node_modules` çš„ä½œç”¨**

```yaml
volumes:
  - ./frontend/src:/app/src       # æ›è¼‰ä¸»æ©Ÿçš„ src
  - /app/node_modules             # â† åŒ¿å volumeï¼Œè¦†è“‹ä¸»æ©Ÿçš„ node_modules
```

**ç‚ºä»€éº¼éœ€è¦é€™æ¨£åšï¼Ÿ**

1. ä¸»æ©Ÿå’Œå®¹å™¨å¯èƒ½æ˜¯ä¸åŒä½œæ¥­ç³»çµ±ï¼ˆWindows vs Linuxï¼‰
2. `node_modules` å¯èƒ½åŒ…å«ç·¨è­¯å¾Œçš„äºŒé€²åˆ¶æª”æ¡ˆï¼ˆä¸ç›¸å®¹ï¼‰
3. ä½¿ç”¨å®¹å™¨å…§å»ºç½®çš„ `node_modules` ç¢ºä¿ç›¸å®¹æ€§

---

### å¾Œç«¯ç†±æ›´æ–°è¨­å®š

**docker-compose.dev.ymlï¼š**

```yaml
services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    volumes:
      # æ›è¼‰åŸå§‹ç¢¼
      - ./backend/src:/app/src:ro
      
      # æ’é™¤ node_modules
      - /app/node_modules
      
      # æ—¥èªŒç›®éŒ„ï¼ˆå¯å¯«ï¼‰
      - ./backend/logs:/app/logs
    ports:
      - "4000:4000"
      - "9229:9229"  # Node.js é™¤éŒ¯ port
    environment:
      - NODE_ENV=development
      - DEBUG=app:*
    # Nodemon è‡ªå‹•é‡å•Ÿ
    command: npm run dev:debug

  # Python/FastAPI å¾Œç«¯
  python-api:
    build:
      context: ./python-api
      dockerfile: Dockerfile.dev
    volumes:
      - ./python-api/app:/app/app:ro
      - /app/__pycache__  # æ’é™¤å¿«å–
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1  # å³æ™‚è¼¸å‡ºæ—¥èªŒ
    # Uvicorn ç†±æ›´æ–°
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

**backend/package.jsonï¼š**

```json
{
  "scripts": {
    "dev": "nodemon src/server.js",
    "dev:debug": "nodemon --inspect=0.0.0.0:9229 src/server.js"
  },
  "devDependencies": {
    "nodemon": "^3.0.0"
  }
}
```

**backend/nodemon.jsonï¼š**

```json
{
  "watch": ["src"],
  "ext": "js,json",
  "ignore": ["src/**/*.spec.js"],
  "exec": "node src/server.js",
  "env": {
    "NODE_ENV": "development"
  },
  "delay": "1000"
}
```

---

### è³‡æ–™åº«è³‡æ–™æŒä¹…åŒ–

```yaml
services:
  postgres:
    image: postgres:15-alpine
    volumes:
      # é–‹ç™¼ç’°å¢ƒï¼šä½¿ç”¨æœ¬åœ°è³‡æ–™å¤¾ï¼ˆæ–¹ä¾¿å‚™ä»½/é‡ç½®ï¼‰
      - ./data/postgres:/var/lib/postgresql/data
      
      # åˆå§‹åŒ–è…³æœ¬
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      - ./scripts/seed-data.sql:/docker-entrypoint-initdb.d/02-seed.sql:ro
    ports:
      - "5432:5432"
```

**é‡ç½®è³‡æ–™åº«ï¼š**

```bash
# åœæ­¢å®¹å™¨
docker-compose down

# åˆªé™¤è³‡æ–™
rm -rf ./data/postgres

# é‡æ–°å•Ÿå‹•ï¼ˆæœƒåŸ·è¡Œåˆå§‹åŒ–è…³æœ¬ï¼‰
docker-compose up -d postgres
```

---

### æ•ˆèƒ½å„ªåŒ–æŠ€å·§

**1. ä½¿ç”¨ `delegated` æˆ– `cached` æ¨¡å¼ï¼ˆMac/Windowsï¼‰**

```yaml
volumes:
  # delegated: å®¹å™¨å¯«å…¥å„ªå…ˆï¼Œç¨å¾ŒåŒæ­¥åˆ°ä¸»æ©Ÿ
  - ./backend/src:/app/src:delegated
  
  # cached: ä¸»æ©Ÿå¯«å…¥å„ªå…ˆï¼Œç¨å¾ŒåŒæ­¥åˆ°å®¹å™¨
  - ./frontend/src:/app/src:cached
```

**2. ä½¿ç”¨ `.dockerignore`**

```
# .dockerignore
node_modules
npm-debug.log
dist
.git
.env
*.md
```

**3. ä½¿ç”¨ Turbopack/Vite å¿«é€Ÿé–‹ç™¼ä¼ºæœå™¨**

```yaml
services:
  frontend:
    command: npm run dev -- --turbo  # Next.js Turbopack
```

---

### å®Œæ•´é–‹ç™¼ç’°å¢ƒç¯„ä¾‹

```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    volumes:
      - ./frontend/src:/app/src:cached
      - ./frontend/public:/app/public:cached
      - /app/node_modules
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://localhost:4000
    command: npm run dev

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    volumes:
      - ./backend/src:/app/src:cached
      - /app/node_modules
      - ./backend/logs:/app/logs
    ports:
      - "4000:4000"
      - "9229:9229"
    environment:
      - NODE_ENV=development
      - DB_HOST=postgres
    command: npm run dev:debug
    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    image: postgres:15-alpine
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./scripts:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: dev123
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dev"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

**å•Ÿå‹•é–‹ç™¼ç’°å¢ƒï¼š**

```bash
# å»ºç½®ä¸¦å•Ÿå‹•
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d --build

# æŸ¥çœ‹æ—¥èªŒ
docker-compose -f docker-compose.yml -f docker-compose.dev.yml logs -f backend

# é€²å…¥å®¹å™¨é™¤éŒ¯
docker-compose -f docker-compose.yml -f docker-compose.dev.yml exec backend sh
```

é€™æ¨£å¯ä»¥å¯¦ç¾å®Œæ•´çš„æœ¬æ©Ÿé–‹ç™¼ç†±æ›´æ–°ç’°å¢ƒï¼
