# 第 13 章：常見的「後悔藥」處方

在 Git 的世界裡，幾乎什麼動作都是可以反悔的。這章我們來學習幾種常見的情境。

## 13.1 後悔決策樹 (Decision Tree)

不知道該用哪個指令？請查閱此圖：

```mermaid
graph TD
    Start{我後悔了...}
    
    Start --> Q1{Commit 了嗎？}
    
    Q1 -- No --> Q2{Add (Staged) 了嗎？}
    Q1 -- Yes --> Q3{Push 出去了嗎？}
    
    Q2 -- No (Modified only) --> Ans1[git restore <file>]
    Q2 -- Yes --> Ans2[git restore --staged <file>]
    
    Q3 -- Yes --> Ans3[git revert <commit-id>]
    Q3 -- No --> Q4{想保留修改內容嗎？}
    
    Q4 -- Yes (退回暫存區) --> Ans4[git reset --soft HEAD~1]
    Q4 -- No (全部不要了) --> Ans5[git reset --hard HEAD~1]
    Q4 -- 只是想改訊息 --> Ans6[git commit --amend]
    
    style Ans1 fill:#f9f
    style Ans2 fill:#f9f
    style Ans3 fill:#f9f
    style Ans4 fill:#bbf
    style Ans5 fill:#f99
    style Ans6 fill:#bbf
```

---

## 13.2 情境詳解

### 情境一：寫錯 Commit Message
*   **指令**：`git commit --amend -m "New Message"`
*   **效果**：修改最近一次的 Commit 訊息 (此操作會改變 Commit ID)。

### 情境二：漏了檔案沒 Commit
*   **指令**：
    ```bash
    git add missed-file.js
    git commit --amend --no-edit
    ```
*   **效果**：把漏掉的檔案併入上一次 Commit。

### 情境三：不小心 git add 了 (Unstage)
*   **指令**：`git restore --staged <file>`
*   **效果**：把檔案從暫存區踢回工作目錄 (檔案內容保留)。

### 情境四：改爛了，想還原檔案 (Discard)
*   **指令**：`git restore <file>`
*   **效果**：**危險！** 檔案會回復到上一次 Commit 的狀態，你剛寫的爛 code 會直接消失。

### 情境五：Commit 做錯了，想重來 (Reset)
*   **Soft Reset** (`git reset --soft HEAD~1`)：
    *   Commit 消失，但**檔案內容保留在暫存區**。
    *   適用：想重新整理 Commit 內容時。
*   **Hard Reset** (`git reset --hard HEAD~1`)：
    *   Commit 消失，**檔案內容也直接消失**。
    *   適用：徹底放棄這一次的修改。

### 情境六：已經 Push 出去了，想復原 (Revert)
*   **指令**：`git revert <commit-id>`
*   **效果**：新增一個「反向」Commit，抵銷之前的修改。
*   **適用**：公共分支 (Main/Master) 上發生的錯誤。

---

## 13.3 總結表

| 狀態 | 指令 (Git 2.23+) | 舊版指令 | 作用 |
| :--- | :--- | :--- | :--- |
| **Modified** | `git restore <file>` | `git checkout -- <file>` | 捨棄修改 (不可逆) |
| **Staged** | `git restore --staged <file>` | `git reset HEAD <file>` | 取消暫存 |
| **Committed** | `git reset --soft HEAD~1` | 同左 | 退回 Commit (保留檔案) |
| **Committed** | `git reset --hard HEAD~1` | 同左 | 刪除 Commit (刪除檔案) |
| **Pushed** | `git revert <commit>` | 同左 | 新增反向 Commit |
