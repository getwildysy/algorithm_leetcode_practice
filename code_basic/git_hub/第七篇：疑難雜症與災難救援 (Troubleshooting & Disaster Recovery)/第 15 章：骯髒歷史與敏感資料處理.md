# 第 15 章：骯髒歷史與敏感資料處理

## 15.1 災難現場：不小心上傳了密碼

最常見的慘劇之一：你不小心把包含 AWS Key 或資料庫密碼的 `.env` 檔案 Commit 出去了。
雖然你發現後馬上刪除並推了新版本，但**駭客可以從歷史紀錄 (Git History) 裡把那個檔案撈出來**。

### 緊急處置 SOP
1.  **立刻更改密碼**：這是最重要的。你的 Key 既然上過 GitHub，就必須假設它已經被爬蟲抓走了。
2.  **清洗歷史紀錄**：使用工具把該檔案從所有 Commit 中徹底抹除。

### 工具 A：BFG Repo-Cleaner (簡單、快速、推薦)
BFG 是一個 Java 寫的工具，專門用來刪除敏感資料。

```bash
# 1. 下載 bfg.jar
# 2. 執行刪除指令 (移除 .env)
java -jar bfg.jar --delete-files .env  my-repo.git

# 3. 清理 Git 垃圾回收機制 (GC)
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# 4. 強制推送到遠端 (覆寫所有歷史)
git push --force
```

### 工具 B：git-filter-repo (Python based, 官方推薦)
Git 官方現在推薦用 `git-filter-repo` 取代舊的 `git filter-branch`。
```bash
pip install git-filter-repo
git filter-repo --path .env --invert-paths
```

---

## 15.2 如何安全地管理敏感資料？

如果不能 Commit 密碼，那我的程式碼怎麼拿到密碼？

### 方法一：Environment Variables (環境變數)
*   **作法**：程式碼讀取 `process.env.DB_PASSWORD`。
*   **本地**：建立 `.env` 檔案，並將其加入 `.gitignore`。
*   **部署**：在 Heroku/AWS 後台設定環境變數。

### 方法二：加密儲存 (git-crypt / git-secret)
如果你真的想把機密檔案放進 Git (方便團隊共享)，請務必**加密**。

**git-crypt** 是一個透明加密工具：
*   `git push` 時：自動加密 (變成亂碼)。
*   `git pull` 時：自動解密 (變回明文)。
*   只有擁有密鑰 (GPG Key) 的團隊成員能看到明文，駭客偷走 Repo 也只能看到亂碼。

---

## 15.3 Deep Dive: .gitignore 詳解

`.gitignore` 的語法其實很靈活。

```gitignore
# 忽略所有 .log 檔
*.log

# 但不要忽略 (例外) important.log
!important.log

# 忽略 build 目錄下所有東西
build/

# 忽略 doc 目錄下的所有 .txt (不包含 doc/server/ 裡的)
doc/*.txt

# 忽略 doc 目錄下及其子目錄的所有 .pdf
doc/**/*.pdf
```

### 為什麼 .gitignore 無效？

**情境**：加了 `config.yml` 到忽略清單，但 Git 還是繼續追蹤它。

**原因**：`.gitignore` **只對 Untracked (未被追蹤) 的檔案有效**。
如果檔案已經被 Commit 過了，它就是 Tracked 狀態，Git 會無視忽略規則。

**解法：清除索引 (Clear Index)**
你必須手動告訴 Git：「請忘記這個檔案」。

```bash
# --cached 代表只刪除「索引/暫存區」，保留實體檔案
git rm --cached config.yml
```
執行完這行後，`config.yml` 會變回 Untracked 狀態，這時 `.gitignore` 就會生效了。

---

## 15.4 結語：Git 的哲學

Git 不僅是一個備份工具，它是工程師之間溝通的語言。
*   **Clean History**：好的 Commit Message 與線圖，是對同事的尊重。
*   **Review Code**：透過 PR 機制，互相學習與把關。
*   **Automation**：把重複的工作交給 CI/CD，讓人腦專注於創造價值。

祝你在 Git 的旅程中，只有 `Merge`，沒有 `Conflict`！
