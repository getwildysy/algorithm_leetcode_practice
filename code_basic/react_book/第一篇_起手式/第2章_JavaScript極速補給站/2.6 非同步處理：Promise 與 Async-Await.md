# 2.6 非同步處理：Promise 與 Async/Await

JavaScript 是**單執行緒 (Single Threaded)** 的語言，這意味著它一次只能做一件事。為了不讓長時間的任務（如發送網路請求）卡住整個網頁，我們需要「非同步 (Asynchronous)」處理。

## 1. 以前的噩夢：Callback Hell

在古老的年代，我們使用回呼函式 (Callback) 來處理非同步。

```javascript
getData(function(a) {
  getMoreData(a, function(b) {
    getMoreMoreData(b, function(c) {
      console.log(c);
    });
  });
});
// 波動拳程式碼，難以閱讀與維護
```

## 2. Promise：現代的救星

Promise 物件代表一個「未來才會完成」的操作。它有三種狀態：
1. **Pending** (進行中)
2. **Fulfilled** (已成功) -> 呼叫 `.then()`
3. **Rejected** (已失敗) -> 呼叫 `.catch()`

```javascript
fetch('https://api.example.com/data')
  .then(response => response.json()) // 成功拿到回應
  .then(data => console.log(data))   // 成功解析 JSON
  .catch(error => console.error(error)); // 發生錯誤
```

## 3. Async / Await：語法糖

ES8 (2017) 推出了 `async` 和 `await`，讓我們能用「看起來很像同步」的語法寫非同步程式碼。這是目前最推薦的寫法。

### 基本規則

1. **async**：宣告一個函式是非同步的，它會自動回傳一個 Promise。
2. **await**：只能在 async 函式內部使用。它會暫停程式執行，直到 Promise 完成（resolved）。

### 範例：改寫 fetch

```javascript
// 宣告 async 函式
async function fetchUserData() {
  try {
    // 等待請求完成
    const response = await fetch('https://api.example.com/user');
    
    // 等待 JSON 解析完成
    const data = await response.json();
    
    console.log(data);
  } catch (error) {
    // 統一用 try-catch 處理錯誤
    console.error('Fetch failed:', error);
  }
}

fetchUserData();
```

## 4. React 中的應用：useEffect

在 React 中，我們通常會在 `useEffect` Hook 裡面執行非同步操作（例如 API 請求）。

> [!CAUTION]
> **陷阱**：`useEffect` 的 callback 函式本身**不能**是 async 的！

**❌ 錯誤寫法：**
```javascript
// useEffect 不預期接收一個 Promise
useEffect(async () => {
  const data = await fetchAPI(); // 爆炸
}, []);
```

**✅ 正確寫法：**
在 useEffect 內部定義一個 async 函式並呼叫它。

```javascript
useEffect(() => {
  // 1. 定義 async 函式
  const fetchData = async () => {
    try {
      const result = await someAPI();
      setData(result);
    } catch (e) {
      setError(e);
    }
  };

  // 2. 立即呼叫它
  fetchData();
}, []); // 空依賴陣列表示只在組件掛載時執行一次
```

## 小結

- JavaScript 需要非同步機制來處理耗時任務。
- **Promise** 是基礎，解決了 Callback Hell。
- **Async/Await** 是最佳解，讓程式碼可讀性大幅提升。
- 在 React `useEffect` 中使用 async/await 時，記得要包一層 function。
