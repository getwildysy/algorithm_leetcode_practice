# 6.1 列表渲染：key 值的重要性

在 React 中渲染陣列是非常常見的操作，但「為什麼一定要加 `key`？」以及「為什麼不能用 index 當 key？」是很多人的疑問。這牽涉到 React 的核心演算法 —— **Reconciliation (協調)**。

## 1. 為什麼需要 key？

React 在更新 DOM 時，會比較新舊兩棵 Virtual DOM Tree。
當遇到一個列表 (List) 時，React 需要一個「識別證」來知道：
- 哪一個項目是**新加**的？
- 哪一個項目被**刪除**了？
- 哪一個項目只是**換了位置**？

如果沒有 `key`，React 只能「笨笨地」依序比較。如果有 `key`，React 就能迅速找到對應的舊節點進行複用。

---

## 2. 致命錯誤：使用 Index 當 Key

這是新手最常犯的錯誤。

```jsx
// ❌ 這樣寫會有隱患
{items.map((item, index) => (
  <li key={index}>{item.text}</li>
))}
```

### 💣 爆炸場景：刪除項目
假設列表原本是 `[A, B, C]`。
1. `key=0` 是 A
2. `key=1` 是 B
3. `key=2` 是 C

現在你刪除了 A，列表變 `[B, C]`。
1. `key=0` 變成 B (React 以為：A 內容變成了 B)
2. `key=1` 變成 C (React 以為：B 內容變成了 C)
3. `key=2` 消失了 (React 以為：C 被刪除了)

**結果**：
如果你的列表中有 `<input>` 等會有自己狀態的元件，狀態會**錯位**！(例如原本填在 B 的文字跑去 C 了)。

---

## 3. 正確的 key 設定方式

請使用資料中**唯一且穩定**的 ID。

```jsx
// ✅ DB ID 或 UUID
{items.map((item) => (
  <li key={item.id}>{item.text}</li>
))}
```

如果真的沒有 ID 怎麼辦？
1. 請後端補上 ID (最佳解)。
2. 在前端抓到資料時，用 `crypto.randomUUID()` 自己產一次 ID (次佳解)。
3. **千萬不要**在 render 指令裡面產 ID (`key={Math.random()}`)，這會導致列表每次都強制重繪，效能極差且 Input 焦點會一直跳掉。

## 小結

- Key 是 React 辨識身分的證件。
- Key 必須在**兄弟節點**之間唯一。
- **禁止使用 Index 當 Key**，除非你的列表永遠不會變更順序、不會插入/刪除項目。
